{
  Endpoint oldEndpoint;
synchronized (endpoints) {
    startServices(endpoint);
    oldEndpoint=endpoints.remove(uri);
    endpoints.put(getEndpointKey(uri,endpoint),endpoint);
    if (oldEndpoint != null) {
      stopServices(oldEndpoint);
    }
  }
  return oldEndpoint;
}
