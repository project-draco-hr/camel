{
  ConnectionFactory factory=new ConnectionFactory();
  factory.setHost("localhost");
  factory.setPort(5672);
  factory.setUsername("cameltest");
  factory.setPassword("cameltest");
  factory.setVirtualHost("/");
  Connection conn=factory.newConnection();
  final List<Envelope> received=new ArrayList<Envelope>();
  Channel channel=conn.createChannel();
  channel.queueDeclare("sammyq",false,false,true,null);
  channel.queueBind("sammyq",EXCHANGE,"route1");
  channel.basicConsume("sammyq",true,new DefaultConsumer(channel){
    @Override public void handleDelivery(    String consumerTag,    Envelope envelope,    AMQP.BasicProperties properties,    byte[] body) throws IOException {
      received.add(envelope);
    }
  }
);
  template.sendBodyAndHeader("new message",RabbitMQConstants.EXCHANGE_NAME,"ex1");
  Thread.sleep(500);
  assertEquals(1,received.size());
}
