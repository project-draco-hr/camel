{
  context.addRoutes(new RouteBuilder(){
    public void configure() throws Exception {
      from("direct:start").aggregate().header("id").batchTimeout(500L).batchSize(5).to("mock:result");
    }
  }
);
  startCamelContext();
  MockEndpoint result=getMockEndpoint("mock:result");
  result.expectedMinimumMessageCount(4);
  template.sendBodyAndHeader("direct:start","Message 1a","id","1");
  template.sendBodyAndHeader("direct:start","Message 2a","id","2");
  template.sendBodyAndHeader("direct:start","Message 1b","id","1");
  template.sendBodyAndHeader("direct:start","Message 2b","id","2");
  template.sendBodyAndHeader("direct:start","Message 1c","id","1");
  Thread.sleep(100);
  template.sendBodyAndHeader("direct:start","Message 3a","id","3");
  template.sendBodyAndHeader("direct:start","Message 4","id","4");
  template.sendBodyAndHeader("direct:start","Message 3b","id","3");
  template.sendBodyAndHeader("direct:start","Message 3c","id","3");
  template.sendBodyAndHeader("direct:start","Message 1d","id","1");
  assertMockEndpointsSatisfied();
  assertEquals("Message 1c",result.getExchanges().get(0).getIn().getBody());
  assertEquals("Message 2b",result.getExchanges().get(1).getIn().getBody());
  assertEquals("Message 3c",result.getExchanges().get(2).getIn().getBody());
  assertEquals("Message 4",result.getExchanges().get(3).getIn().getBody());
  if (result.getReceivedCounter() > 4) {
    assertEquals("Message 1d",result.getExchanges().get(4).getIn().getBody());
  }
}
