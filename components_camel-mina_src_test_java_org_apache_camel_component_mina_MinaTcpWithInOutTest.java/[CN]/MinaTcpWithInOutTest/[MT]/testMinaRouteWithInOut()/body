{
  container=new DefaultCamelContext();
  latch=new CountDownLatch(1);
  uri="mina:tcp://localhost:6321?textline=true";
  ReverserServer server=new ReverserServer();
  server.start();
  container.addRoutes(createRouteBuilder());
  container.start();
  Endpoint endpoint=container.getEndpoint("direct:x");
  Exchange exchange=endpoint.createExchange(ExchangePattern.InOut);
  Message message=exchange.getIn();
  message.setBody("Hello!");
  message.setHeader("cheese",123);
  Producer producer=endpoint.createProducer();
  producer.start();
  producer.process(exchange);
  boolean received=latch.await(5,TimeUnit.SECONDS);
  assertTrue("Did not receive the message!",received);
  assertNotNull(receivedExchange.getIn());
  assertEquals("!olleH",receivedExchange.getIn().getBody());
  producer.stop();
  container.stop();
  server.stop();
}
