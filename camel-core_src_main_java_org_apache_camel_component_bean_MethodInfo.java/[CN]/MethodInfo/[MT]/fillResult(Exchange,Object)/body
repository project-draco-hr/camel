{
  LOG.trace("Setting bean invocation result : {}",result);
  boolean out=ExchangeHelper.isOutCapable(exchange) || exchange.hasOut();
  Message old;
  if (out) {
    old=exchange.getOut();
    exchange.getOut().getHeaders().putAll(exchange.getIn().getHeaders());
    if (exchange.getIn().hasAttachments()) {
      exchange.getOut().getAttachments().putAll(exchange.getIn().getAttachments());
    }
  }
 else {
    old=exchange.getIn();
  }
  boolean copyNeeded=!(old.getClass().equals(DefaultMessage.class));
  if (copyNeeded) {
    Message msg=new DefaultMessage();
    msg.copyFrom(old);
    msg.setBody(result);
    ExchangeHelper.replaceMessage(exchange,msg,false);
  }
 else {
    old.setBody(result);
  }
}
