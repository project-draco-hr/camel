{
  ObjectHelper.notNull(session,"session");
  ScpConfiguration cfg=endpoint.getConfiguration();
  int timeout=cfg.getConnectTimeout();
  LOG.trace("Opening channel to {} with {} timeout...",cfg.remoteServerInformation(),timeout > 0 ? (Integer.toString(timeout) + " ms") : "no");
  String file=getRemoteFile(name,cfg);
  try {
    channel=(ChannelExec)session.openChannel("exec");
    channel.setCommand(getScpCommand(cfg,file));
    channel.connect(timeout);
    LOG.trace("Channel connected to {}",cfg.remoteServerInformation());
    try {
      write(channel,file,ExchangeHelper.getMandatoryInBody(exchange,InputStream.class));
    }
 catch (    InvalidPayloadException e) {
      throw new GenericFileOperationFailedException("Failed extract message body as InputStream",e);
    }
catch (    IOException e) {
      throw new GenericFileOperationFailedException("Failed to write file " + file,e);
    }
  }
 catch (  JSchException e) {
    LOG.warn("Failed to secure copy file " + file,e);
    return false;
  }
 finally {
    if (channel != null) {
      LOG.trace("Disconnecting 'exec' scp channel");
      channel.disconnect();
      channel=null;
      LOG.trace("Channel disconnected from {}",cfg.remoteServerInformation());
    }
  }
  return true;
}
