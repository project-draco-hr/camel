{
  LOG.trace("populateCamelHeaders: {}",request);
  headers.put(Exchange.HTTP_METHOD,request.getMethod().name());
  String s=request.getUri();
  if (s.contains("?")) {
    s=ObjectHelper.before(s,"?");
  }
  String http=configuration.isSsl() ? "https://" : "http://";
  if (!s.startsWith(http)) {
    if (configuration.getPort() != 80) {
      s=http + configuration.getHost() + ":"+ configuration.getPort()+ s;
    }
 else {
      s=http + configuration.getHost() + s;
    }
  }
  headers.put(Exchange.HTTP_URL,s);
  URI uri=new URI(request.getUri());
  headers.put(Exchange.HTTP_URI,uri.getPath());
  headers.put(Exchange.HTTP_QUERY,uri.getQuery());
  headers.put(Exchange.HTTP_RAW_QUERY,uri.getRawQuery());
  String path=uri.getPath();
  if (configuration.getPath() != null && path.startsWith(configuration.getPath())) {
    path=path.substring(configuration.getPath().length());
  }
  headers.put(Exchange.HTTP_PATH,path);
  if (LOG.isTraceEnabled()) {
    LOG.trace("HTTP-Method {}",request.getMethod().name());
    LOG.trace("HTTP-Uri {}",request.getUri());
  }
  for (  String name : request.headers().names()) {
    if (name.toLowerCase(Locale.US).equals("content-type")) {
      name=Exchange.CONTENT_TYPE;
    }
    if (name.toLowerCase(Locale.US).equals("authorization")) {
      String value=request.headers().get(name);
      if (value != null && value.trim().startsWith("Basic")) {
        if (headerFilterStrategy != null && !headerFilterStrategy.applyFilterToExternalHeaders(NettyHttpConstants.HTTP_AUTHENTICATION,"Basic",exchange)) {
          NettyHttpHelper.appendHeader(headers,NettyHttpConstants.HTTP_AUTHENTICATION,"Basic");
        }
      }
    }
    List<String> values=request.headers().getAll(name);
    Iterator<?> it=ObjectHelper.createIterator(values);
    while (it.hasNext()) {
      Object extracted=it.next();
      Object decoded=shouldUrlDecodeHeader(configuration,name,extracted,"UTF-8");
      LOG.trace("HTTP-header: {}",extracted);
      if (headerFilterStrategy != null && !headerFilterStrategy.applyFilterToExternalHeaders(name,decoded,exchange)) {
        NettyHttpHelper.appendHeader(headers,name,decoded);
      }
    }
  }
  if (request.getUri().contains("?")) {
    String query=ObjectHelper.after(request.getUri(),"?");
    Map<String,Object> uriParameters=URISupport.parseQuery(query,false,true);
    for (    Map.Entry<String,Object> entry : uriParameters.entrySet()) {
      String name=entry.getKey();
      Object values=entry.getValue();
      Iterator<?> it=ObjectHelper.createIterator(values);
      while (it.hasNext()) {
        Object extracted=it.next();
        Object decoded=shouldUrlDecodeHeader(configuration,name,extracted,"UTF-8");
        LOG.trace("URI-Parameter: {}",extracted);
        if (headerFilterStrategy != null && !headerFilterStrategy.applyFilterToExternalHeaders(name,decoded,exchange)) {
          NettyHttpHelper.appendHeader(headers,name,decoded);
        }
      }
    }
  }
  if (request.getMethod().name().equals("POST") && request.headers().get(Exchange.CONTENT_TYPE) != null && request.headers().get(Exchange.CONTENT_TYPE).startsWith(NettyHttpConstants.CONTENT_TYPE_WWW_FORM_URLENCODED) && !configuration.isBridgeEndpoint()) {
    String charset="UTF-8";
    String body=request.content().toString(Charset.forName(charset));
    if (ObjectHelper.isNotEmpty(body)) {
      for (      String param : body.split("&")) {
        String[] pair=param.split("=",2);
        if (pair.length == 2) {
          String name=shouldUrlDecodeHeader(configuration,"",pair[0],charset);
          String value=shouldUrlDecodeHeader(configuration,name,pair[1],charset);
          if (headerFilterStrategy != null && !headerFilterStrategy.applyFilterToExternalHeaders(name,value,exchange)) {
            NettyHttpHelper.appendHeader(headers,name,value);
          }
        }
 else {
          throw new IllegalArgumentException("Invalid parameter, expected to be a pair but was " + param);
        }
      }
    }
  }
}
