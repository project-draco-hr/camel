{
  ObjectHelper.notNull(dataFormat,"dataFormat");
  CachedOutputStream cos;
  ByteArrayOutputStream os;
  if (exchange.getContext().getStreamCachingStrategy().isEnabled()) {
    cos=new CachedOutputStream(exchange);
    os=null;
  }
 else {
    cos=null;
    os=new ByteArrayOutputStream();
  }
  Message in=exchange.getIn();
  Object body=in.getBody();
  Message out=exchange.getOut();
  out.copyFrom(in);
  try {
    if (cos != null) {
      dataFormat.marshal(exchange,body,cos);
      out.setBody(cos.newStreamCache());
    }
 else {
      dataFormat.marshal(exchange,body,os);
      byte[] data=os.toByteArray();
      out.setBody(data);
    }
  }
 catch (  Throwable e) {
    exchange.setOut(null);
    exchange.setException(e);
  }
  callback.done(true);
  return true;
}
