{
  CamelContext context=exchange != null ? exchange.getContext() : null;
  ClassLoader appcl=context != null ? context.getApplicationContextClassLoader() : null;
  T result;
  ClassLoader tccl=Thread.currentThread().getContextClassLoader();
  try {
    if (appcl != null && appcl != tccl) {
      LOG.debug("Switching TCCL to: {}",appcl);
      Thread.currentThread().setContextClassLoader(appcl);
    }
    String mapId=null;
    if (value != null) {
      Class<?> sourceType=value.getClass();
      ClassMappingMetadata metadata=getClassMappingMetadata(sourceType,type);
      if (metadata != null) {
        mapId=metadata.getMapId();
      }
    }
    result=mapper.map(value,type,mapId);
  }
  finally {
    if (appcl != null && appcl != tccl) {
      Thread.currentThread().setContextClassLoader(tccl);
      LOG.debug("Restored TCCL to: {}",tccl);
    }
  }
  return result;
}
