{
  String mapId=null;
  if (value != null) {
    Class<?> sourceType=value.getClass();
    Class<?> destType=type;
    ClassMappingMetadata metadata=mapper.getMappingMetadata().getClassMapping(sourceType,destType);
    if (metadata != null) {
      mapId=metadata.getMapId();
    }
  }
  if (exchange == null) {
    return mapper.map(value,type,mapId);
  }
  T answer=null;
  ClassLoader prev=Thread.currentThread().getContextClassLoader();
  ClassLoader contextCl=exchange.getContext().getApplicationContextClassLoader();
  if (contextCl != null) {
    LOG.debug("Switching TCCL to: {}.",contextCl);
    try {
      Thread.currentThread().setContextClassLoader(contextCl);
      answer=mapper.map(value,type,mapId);
    }
  finally {
      LOG.debug("Restored TCCL to: {}.",prev);
      Thread.currentThread().setContextClassLoader(prev);
    }
  }
 else {
    answer=mapper.map(value,type,mapId);
  }
  return answer;
}
