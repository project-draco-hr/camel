{
  assertEquals(0,cappedTestCollection.count());
  final MockEndpoint mock=getMockEndpoint("mock:test");
  db.getCollection(MongoDbTailTrackingConfig.DEFAULT_COLLECTION).drop();
  cappedTestCollection=db.createCollection(cappedTestCollectionName,BasicDBObjectBuilder.start().add("capped",true).add("size",1000000000).add("max",1000).get());
  cappedTestCollection.createIndex("increasing");
  addTestRoutes();
  context.startRoute("tailableCursorConsumer2");
  mock.expectedMessageCount(300);
  Thread t=new Thread(new Runnable(){
    @Override public void run(){
      for (int i=1; i <= 300; i++) {
        cappedTestCollection.insert(BasicDBObjectBuilder.start("increasing",i).add("string","value" + i).get(),WriteConcern.SAFE);
      }
    }
  }
);
  t.start();
  t.join();
  mock.assertIsSatisfied();
  mock.reset();
  context.stopRoute("tailableCursorConsumer2");
  while (context.getRouteStatus("tailableCursorConsumer2") != ServiceStatus.Stopped) {
  }
  context.startRoute("tailableCursorConsumer2");
  mock.expectedMessageCount(300);
  t=new Thread(new Runnable(){
    @Override public void run(){
      for (int i=301; i <= 600; i++) {
        cappedTestCollection.insert(BasicDBObjectBuilder.start("increasing",i).add("string","value" + i).get(),WriteConcern.SAFE);
      }
    }
  }
);
  t.start();
  t.join();
  mock.assertIsSatisfied();
  Object firstBody=mock.getExchanges().get(0).getIn().getBody();
  assertTrue(firstBody instanceof DBObject);
  assertEquals(301,((DBObject)firstBody).get("increasing"));
  assertEquals(300,db.getCollection(MongoDbTailTrackingConfig.DEFAULT_COLLECTION).findOne(new BasicDBObject("persistentId","darwin")).get("lastTrackingValue"));
  context.stopRoute("tailableCursorConsumer2");
  while (context.getRouteStatus("tailableCursorConsumer2") != ServiceStatus.Stopped) {
  }
  assertEquals(600,db.getCollection(MongoDbTailTrackingConfig.DEFAULT_COLLECTION).findOne(new BasicDBObject("persistentId","darwin")).get("lastTrackingValue"));
}
