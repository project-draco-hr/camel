{
synchronized (monitor) {
    try {
      Object handler=deferredRequestMap.get(transitionalID);
      if (handler == null) {
        return;
      }
      deferredRequestMap.remove(transitionalID);
      String correlationID=outMessage.getJMSMessageID();
      Object in=deferredReplyMap.get(correlationID);
      if (in != null && in instanceof Message) {
        Message inMessage=(Message)in;
        if (handler instanceof ReplyHandler) {
          ReplyHandler replyHandler=(ReplyHandler)handler;
          try {
            boolean complete=replyHandler.handle(inMessage);
            if (complete) {
              deferredReplyMap.remove(correlationID);
            }
          }
 catch (          JMSException e) {
            throw new FailedToProcessResponse(inMessage,e);
          }
        }
      }
 else {
        deferredRequestMap.put(correlationID,handler,getRequestTimeout());
      }
    }
 catch (    JMSException e) {
      throw new FailedToProcessResponse(outMessage,e);
    }
  }
}
