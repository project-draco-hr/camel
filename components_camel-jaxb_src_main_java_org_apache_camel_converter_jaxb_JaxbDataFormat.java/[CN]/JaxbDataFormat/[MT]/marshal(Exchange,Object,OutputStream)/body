{
  try {
    Marshaller marshaller=getContext().createMarshaller();
    if (nameSpacePrefixMapper != null) {
      marshaller.setProperty("com.sun.xml.bind.namespacePrefixMapper",nameSpacePrefixMapper);
    }
    if (isPrettyPrint()) {
      marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT,Boolean.TRUE);
    }
    String charset=exchange.getProperty(Exchange.CHARSET_NAME,String.class);
    if (charset == null) {
      charset=encoding;
    }
    if (charset != null) {
      marshaller.setProperty(Marshaller.JAXB_ENCODING,charset);
    }
    if (isFragment()) {
      marshaller.setProperty(Marshaller.JAXB_FRAGMENT,Boolean.TRUE);
    }
    marshal(exchange,graph,stream,marshaller);
  }
 catch (  JAXBException e) {
    throw new IOException(e);
  }
catch (  XMLStreamException e) {
    throw new IOException(e);
  }
}
