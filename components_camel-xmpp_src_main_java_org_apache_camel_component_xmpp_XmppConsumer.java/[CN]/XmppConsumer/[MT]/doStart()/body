{
  connection=endpoint.createConnection();
  chatManager=connection.getChatManager();
  chatManager.addChatListener(this);
  if (endpoint.getRoom() == null) {
    privateChat=chatManager.getThreadChat(endpoint.getChatId());
    if (privateChat != null) {
      LOG.debug("Adding listener to existing chat opened to " + privateChat.getParticipant());
      privateChat.addMessageListener(this);
    }
 else {
      privateChat=connection.getChatManager().createChat(endpoint.getParticipant(),endpoint.getChatId(),this);
      LOG.debug("Opening private chat to " + privateChat.getParticipant());
    }
  }
 else {
    final ToContainsFilter toFilter=new ToContainsFilter(endpoint.getParticipant());
    final AndFilter packetFilter=new AndFilter(new PacketTypeFilter(Presence.class),toFilter);
    connection.addPacketListener(this,packetFilter);
    muc=new MultiUserChat(connection,endpoint.resolveRoom(connection));
    muc.addMessageListener(this);
    DiscussionHistory history=new DiscussionHistory();
    history.setMaxChars(0);
    muc.join(endpoint.getNickname(),null,history,SmackConfiguration.getPacketReplyTimeout());
    LOG.info("Joined room: {} as: {}",muc.getRoom(),endpoint.getNickname());
  }
  super.doStart();
}
