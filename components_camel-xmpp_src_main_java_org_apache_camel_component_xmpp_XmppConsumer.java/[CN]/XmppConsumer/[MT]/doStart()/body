{
  connection=endpoint.createConnection();
  if (endpoint.getRoom() == null) {
    Chat privateChat=connection.getChatManager().getThreadChat(endpoint.getParticipant());
    if (privateChat != null) {
      LOG.debug("Adding listener to existing chat opened to " + privateChat.getParticipant());
      privateChat.addMessageListener(this);
    }
 else {
      privateChat=connection.getChatManager().createChat(endpoint.getParticipant(),endpoint.getParticipant(),this);
      LOG.debug("Opening private chat to " + privateChat.getParticipant());
    }
  }
 else {
    final ToContainsFilter toFilter=new ToContainsFilter(endpoint.getParticipant());
    final AndFilter packetFilter=new AndFilter(new PacketTypeFilter(Presence.class),toFilter);
    connection.addPacketListener(this,packetFilter);
    muc=new MultiUserChat(connection,endpoint.resolveRoom(connection));
    muc.addMessageListener(this);
    DiscussionHistory history=new DiscussionHistory();
    history.setMaxChars(0);
    muc.join(endpoint.getNickname(),null,history,SmackConfiguration.getPacketReplyTimeout());
    if (LOG.isInfoEnabled()) {
      LOG.info("Joined room: " + muc.getRoom() + " as: "+ endpoint.getNickname());
    }
  }
  super.doStart();
}
