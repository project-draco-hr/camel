{
  if (endpoint.getRoom() == null) {
    privateChat=endpoint.getConnection().createChat(endpoint.getParticipant());
    privateChat.addMessageListener(this);
    LOG.info("Open chat to " + privateChat.getParticipant());
  }
 else {
    muc=new MultiUserChat(endpoint.getConnection(),endpoint.resolveRoom());
    muc.addMessageListener(this);
    DiscussionHistory history=new DiscussionHistory();
    history.setMaxChars(0);
    muc.join(endpoint.getNickname(),null,history,SmackConfiguration.getPacketReplyTimeout());
    LOG.info("Joined room: " + muc.getRoom());
  }
  super.doStart();
}
