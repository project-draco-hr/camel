{
  notNull(getTemplate(),"template");
  if (isDeleteOutputFile()) {
    String fileName=ExchangeHelper.getMandatoryHeader(exchange,Exchange.XSLT_FILE_NAME,String.class);
    exchange.addOnCompletion(new XsltBuilderOnCompletion(fileName));
  }
  Transformer transformer=getTransformer();
  configureTransformer(transformer,exchange);
  transformer.setErrorListener(new DefaultTransformErrorHandler());
  ResultHandler resultHandler=resultHandlerFactory.createResult(exchange);
  Result result=resultHandler.getResult();
  exchange.setProperty("isXalanTransformer",isXalanTransformer(transformer));
  Message out=exchange.getOut();
  out.copyFrom(exchange.getIn());
  InputStream is=null;
  try {
    Source source;
    if (isInputStreamNeeded(exchange)) {
      is=exchange.getIn().getBody(InputStream.class);
      source=getSource(exchange,is);
    }
 else {
      Object body=exchange.getIn().getBody();
      source=getSource(exchange,body);
    }
    LOG.trace("Using {} as source",source);
    transformer.transform(source,result);
    LOG.trace("Transform complete with result {}",result);
    resultHandler.setBody(out);
  }
  finally {
    releaseTransformer(transformer);
    IOHelper.close(is);
  }
}
