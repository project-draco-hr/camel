{
  notNull(getTemplate(),"template");
  if (isDeleteOutputFile()) {
    String fileName=ExchangeHelper.getMandatoryHeader(exchange,Exchange.XSLT_FILE_NAME,String.class);
    exchange.addOnCompletion(new XsltBuilderOnCompletion(fileName));
  }
  Transformer transformer=getTemplate().newTransformer();
  configureTransformer(transformer,exchange);
  transformer.setErrorListener(new DefaultTransformErrorHandler());
  ResultHandler resultHandler=resultHandlerFactory.createResult(exchange);
  Result result=resultHandler.getResult();
  Message out=exchange.getOut();
  out.copyFrom(exchange.getIn());
  InputStream is=null;
  try {
    is=exchange.getIn().getBody(InputStream.class);
    Source source=getSource(exchange,is);
    transformer.transform(source,result);
    resultHandler.setBody(out);
  }
  finally {
    IOHelper.close(is);
  }
}
