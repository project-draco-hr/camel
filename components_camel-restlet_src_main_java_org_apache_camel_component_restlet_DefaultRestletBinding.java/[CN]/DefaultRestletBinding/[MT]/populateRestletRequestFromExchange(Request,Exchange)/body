{
  request.setReferrerRef("camel-restlet");
  final Method method=request.getMethod();
  MediaType mediaType=exchange.getIn().getHeader(Exchange.CONTENT_TYPE,MediaType.class);
  if (mediaType == null) {
    mediaType=MediaType.APPLICATION_WWW_FORM;
  }
  Form form=null;
  if ((Method.PUT == method || Method.POST == method) && MediaType.APPLICATION_WWW_FORM.equals(mediaType,true)) {
    form=new Form();
    if (exchange.getIn().getBody() instanceof Map) {
      try {
        Map pairs=exchange.getIn().getBody(Map.class);
        for (        Object key : pairs.keySet()) {
          Object value=pairs.get(key);
          form.add(key.toString(),value != null ? value.toString() : null);
        }
      }
 catch (      Exception ex) {
        LOG.error("body for " + MediaType.APPLICATION_WWW_FORM + " must be Map<String,String> or string format like name=bob&password=secRet",ex);
      }
    }
 else {
      String body=exchange.getIn().getBody(String.class);
      if (body != null) {
        List<NameValuePair> pairs=URLEncodedUtils.parse(body,Charset.forName(IOHelper.getCharsetName(exchange,true)));
        for (        NameValuePair p : pairs) {
          form.add(p.getName(),p.getValue());
        }
      }
    }
  }
  Series<Header> restletHeaders=(Series)request.getAttributes().get(HeaderConstants.ATTRIBUTE_HEADERS);
  if (restletHeaders == null) {
    restletHeaders=new Series<>(Header.class);
    request.getAttributes().put(HeaderConstants.ATTRIBUTE_HEADERS,restletHeaders);
  }
  String login=exchange.getIn().getHeader(RestletConstants.RESTLET_LOGIN,String.class);
  String password=exchange.getIn().getHeader(RestletConstants.RESTLET_PASSWORD,String.class);
  if (login != null && password != null) {
    ChallengeResponse authentication=new ChallengeResponse(ChallengeScheme.HTTP_BASIC,login,password);
    request.setChallengeResponse(authentication);
    LOG.debug("Basic HTTP Authentication has been applied");
  }
  for (  Map.Entry<String,Object> entry : exchange.getIn().getHeaders().entrySet()) {
    String key=entry.getKey();
    Object value=entry.getValue();
    if (!headerFilterStrategy.applyFilterToCamelHeaders(key,value,exchange)) {
      if (form != null) {
        if (key.startsWith("org.restlet.")) {
          request.getAttributes().put(key,value);
        }
 else {
          if (value instanceof Collection) {
            for (            Object v : (Collection<?>)value) {
              form.add(key,v.toString());
              if (!headerFilterStrategy.applyFilterToCamelHeaders(key,value,exchange)) {
                restletHeaders.set(key,value.toString());
              }
            }
          }
 else {
            form.add(key,value.toString());
            if (!headerFilterStrategy.applyFilterToCamelHeaders(key,value,exchange)) {
              restletHeaders.set(key,value.toString());
            }
          }
        }
      }
 else {
        if (!headerFilterStrategy.applyFilterToCamelHeaders(key,value,exchange)) {
          restletHeaders.set(key,value.toString());
        }
      }
      LOG.debug("Populate Restlet request from exchange header: {} value: {}",key,value);
    }
  }
  if (form != null) {
    request.setEntity(form.getWebRepresentation());
    LOG.debug("Populate Restlet {} request from exchange body as form using media type {}",method,mediaType);
  }
 else {
    if (request.getMethod() == Method.PUT || request.getMethod() == Method.POST) {
      Representation body=createRepresentationFromBody(exchange,mediaType);
      request.setEntity(body);
      LOG.debug("Populate Restlet {} request from exchange body: {} using media type {}",method,body,mediaType);
    }
 else {
      LOG.debug("Populate Restlet {} request from exchange using media type {}",method,mediaType);
      request.setEntity(new EmptyRepresentation());
    }
  }
  String accept=exchange.getIn().getHeader("Accept",String.class);
  if (accept != null) {
    MediaType acceptedMediaType=exchange.getContext().getTypeConverter().tryConvertTo(MediaType.class,exchange,accept);
    if (acceptedMediaType != null) {
      request.getClientInfo().getAcceptedMediaTypes().add(new Preference<MediaType>(acceptedMediaType));
    }
  }
  MediaType acceptedMediaType=exchange.getIn().getHeader(Exchange.ACCEPT_CONTENT_TYPE,MediaType.class);
  if (acceptedMediaType != null) {
    request.getClientInfo().getAcceptedMediaTypes().add(new Preference<MediaType>(acceptedMediaType));
  }
}
