{
  request.setReferrerRef("camel-restlet");
  String body=exchange.getIn().getBody(String.class);
  Form form=new Form();
  form.add(body,null);
  MediaType mediaType=exchange.getIn().getHeader(Exchange.CONTENT_TYPE,MediaType.class);
  if (mediaType == null) {
    mediaType=MediaType.APPLICATION_WWW_FORM;
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Populate Restlet request from exchange body: " + body + " using media type "+ mediaType);
  }
  String login=exchange.getIn().getHeader(RestletConstants.RESTLET_LOGIN,String.class);
  String password=exchange.getIn().getHeader(RestletConstants.RESTLET_PASSWORD,String.class);
  if (login != null && password != null) {
    ChallengeResponse authentication=new ChallengeResponse(ChallengeScheme.HTTP_BASIC,login,password);
    request.setChallengeResponse(authentication);
    if (LOG.isDebugEnabled()) {
      LOG.debug("Basic HTTP Authentication has been applied");
    }
  }
  for (  Map.Entry<String,Object> entry : exchange.getIn().getHeaders().entrySet()) {
    if (!headerFilterStrategy.applyFilterToCamelHeaders(entry.getKey(),entry.getValue(),exchange)) {
      if (request.getMethod() == Method.GET || (request.getMethod() == Method.POST && mediaType == MediaType.APPLICATION_WWW_FORM)) {
        if (entry.getKey().startsWith("org.restlet.")) {
          request.getAttributes().put(entry.getKey(),entry.getValue());
        }
 else {
          form.add(entry.getKey(),entry.getValue().toString());
        }
      }
 else {
        request.getAttributes().put(entry.getKey(),entry.getValue());
      }
      if (LOG.isDebugEnabled()) {
        LOG.debug("Populate Restlet request from exchange header: " + entry.getKey() + " value: "+ entry.getValue());
      }
    }
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Using Content Type: " + mediaType + " for POST data: "+ body);
  }
  if (request.getMethod() == Method.GET || (request.getMethod() == Method.POST && mediaType == MediaType.APPLICATION_WWW_FORM)) {
    request.setEntity(form.getWebRepresentation());
  }
 else {
    request.setEntity(body,mediaType);
  }
}
