{
  Message inMessage=exchange.getIn();
  for (  Map.Entry<String,Object> entry : request.getAttributes().entrySet()) {
    if (!headerFilterStrategy.applyFilterToExternalHeaders(entry.getKey(),entry.getValue(),exchange)) {
      inMessage.setHeader(entry.getKey(),entry.getValue());
      if (LOG.isDebugEnabled()) {
        LOG.debug("Populate exchange from Restlet request header: " + entry.getKey() + " value: "+ entry.getValue());
      }
    }
  }
  String query=request.getResourceRef().getQuery();
  if (query != null) {
    inMessage.setHeader(Exchange.HTTP_QUERY,query);
  }
  inMessage.setHeader(Exchange.HTTP_URI,request.getResourceRef().getIdentifier(true));
  inMessage.setHeader(Exchange.HTTP_METHOD,request.getMethod().toString());
  if (!request.isEntityAvailable()) {
    return;
  }
  if (request.getEntity().getMediaType() != null && request.getEntity().getMediaType().equals(MediaType.APPLICATION_WWW_FORM)) {
    Form form=new Form(request.getEntity());
    for (    Map.Entry<String,String> entry : form.getValuesMap().entrySet()) {
      if (entry.getValue() == null) {
        inMessage.setBody(entry.getKey());
        if (LOG.isDebugEnabled()) {
          LOG.debug("Populate exchange from Restlet request body: " + entry.getValue());
        }
      }
 else {
        if (!headerFilterStrategy.applyFilterToExternalHeaders(entry.getKey(),entry.getValue(),exchange)) {
          inMessage.setHeader(entry.getKey(),entry.getValue());
          if (LOG.isDebugEnabled()) {
            LOG.debug("Populate exchange from Restlet request user header: " + entry.getKey() + " value: "+ entry.getValue());
          }
        }
      }
    }
  }
 else {
    inMessage.setBody(request.getEntity().getStream());
  }
}
