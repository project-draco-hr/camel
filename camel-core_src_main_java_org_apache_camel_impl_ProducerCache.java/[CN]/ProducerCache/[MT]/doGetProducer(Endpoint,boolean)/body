{
  String key=endpoint.getEndpointUri();
  Producer answer=producers.get(key);
  if (pooled && answer == null) {
    answer=pool.acquire(endpoint);
  }
  if (answer == null) {
    try {
      answer=endpoint.createProducer();
      ServiceHelper.startService(answer);
    }
 catch (    Exception e) {
      throw new FailedToCreateProducerException(endpoint,e);
    }
    if (pooled && answer instanceof ServicePoolAware) {
      LOG.debug("Adding to producer service pool with key: {} for producer: {}",endpoint,answer);
      answer=pool.addAndAcquire(endpoint,answer);
    }
 else     if (answer.isSingleton()) {
      LOG.debug("Adding to producer cache with key: {} for producer: {}",endpoint,answer);
      producers.put(key,answer);
    }
  }
  return answer;
}
