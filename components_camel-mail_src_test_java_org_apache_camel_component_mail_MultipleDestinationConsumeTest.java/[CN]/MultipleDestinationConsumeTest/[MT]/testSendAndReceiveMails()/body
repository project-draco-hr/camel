{
  Mailbox.clearAll();
  MockEndpoint resultEndpoint=getMockEndpoint("mock:result");
  resultEndpoint.expectedMinimumMessageCount(1);
  MimeMessage message=new MimeMessage(mailSession);
  message.setText(body);
  message.setRecipients(Message.RecipientType.TO,new Address[]{new InternetAddress("james@localhost"),new InternetAddress("bar@localhost")});
  Transport.send(message);
  resultEndpoint.assertIsSatisfied();
  Exchange exchange=resultEndpoint.getReceivedExchanges().get(0);
  org.apache.camel.Message in=exchange.getIn();
  assertNotNull("Should have headers",in.getHeaders());
  MailExchange mailExchange=(MailExchange)exchange;
  Message inMessage=mailExchange.getIn().getMessage();
  assertNotNull("In message has no JavaMail message!",inMessage);
  String text=in.getBody(String.class);
  assertEquals("mail body",body,text);
  String to=in.getHeader("TO",String.class);
  assertEquals("TO Header","james@localhost, bar@localhost",to);
  Enumeration iter=inMessage.getAllHeaders();
  while (iter.hasMoreElements()) {
    Header header=(Header)iter.nextElement();
    String[] value=message.getHeader(header.getName());
    log.debug("Header: " + header.getName() + " has value: "+ ObjectHelper.asString(value));
  }
}
