{
  if (input == null) {
    return null;
  }
  if (input.indexOf(separator) == -1) {
    return new String[]{trim ? input.trim() : input};
  }
  List<String> answer=new ArrayList<String>();
  StringBuilder sb=new StringBuilder();
  boolean singleQuoted=false;
  boolean doubleQuoted=false;
  boolean skipLeadingWhitespace=true;
  for (int i=0; i < input.length(); i++) {
    char ch=input.charAt(i);
    if (ch == '\'') {
      singleQuoted=!singleQuoted;
      continue;
    }
 else     if (ch == '"') {
      doubleQuoted=!doubleQuoted;
      continue;
    }
 else     if (ch == ' ') {
      if (!singleQuoted && !doubleQuoted && skipLeadingWhitespace) {
        continue;
      }
    }
 else     if (ch == separator) {
      if (!singleQuoted && !doubleQuoted && sb.length() > 0) {
        String text=sb.toString();
        if (trim) {
          text=text.trim();
        }
        answer.add(text);
        sb.setLength(0);
        continue;
      }
    }
    sb.append(ch);
  }
  if (sb.length() > 0) {
    String text=sb.toString();
    if (trim) {
      text=text.trim();
    }
    answer.add(text);
  }
  return answer.toArray(new String[answer.size()]);
}
