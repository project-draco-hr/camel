{
  TypeConverter converter=exchange.getContext().getTypeConverter();
  Session session=openSession();
  String operation=determineOperation(exchange);
  try {
    if (JcrConstants.JCR_INSERT.equals(operation)) {
      Node base=findOrCreateNode(session.getRootNode(),getJcrEndpoint().getBase());
      Node node=findOrCreateNode(base,getNodeName(exchange));
      for (      String key : exchange.getProperties().keySet()) {
        Value value=converter.convertTo(Value.class,exchange,exchange.getProperty(key));
        node.setProperty(key,value);
      }
      node.addMixin("mix:referenceable");
      exchange.getOut().setBody(node.getIdentifier());
    }
 else     if (JcrConstants.JCR_GET_BY_ID.equals(operation)) {
      Node node=session.getNodeByIdentifier(exchange.getIn().getMandatoryBody(String.class));
      PropertyIterator properties=node.getProperties();
      while (properties.hasNext()) {
        Property property=properties.nextProperty();
        Class<?> aClass=classForJCRType(property);
        Object value=converter.convertTo(aClass,exchange,property.getValue());
        exchange.setProperty(property.getName(),value);
      }
    }
 else {
      throw new RuntimeException("Unsupported operation: " + operation);
    }
  }
  finally {
    session.save();
    if (session != null && session.isLive()) {
      session.logout();
    }
  }
}
