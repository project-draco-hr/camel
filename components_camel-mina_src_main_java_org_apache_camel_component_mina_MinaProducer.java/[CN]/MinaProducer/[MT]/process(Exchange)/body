{
  if (session == null && !lazySessionCreation) {
    throw new IllegalStateException("Not started yet!");
  }
  if (session == null || !session.isConnected()) {
    openConnection();
  }
  if (endpoint.getCharsetName() != null) {
    exchange.setProperty(Exchange.CHARSET_NAME,endpoint.getCharsetName());
  }
  Object body=MinaPayloadHelper.getIn(endpoint,exchange);
  if (body == null) {
    LOG.warn("No payload to send for exchange: " + exchange);
    return;
  }
  if (sync) {
    latch=new CountDownLatch(1);
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Writing body: " + body);
  }
  MinaHelper.writeBody(session,body,exchange);
  if (sync) {
    LOG.debug("Waiting for response");
    latch.await(timeout,TimeUnit.MILLISECONDS);
    if (latch.getCount() == 1) {
      throw new ExchangeTimedOutException(exchange,timeout);
    }
    ResponseHandler handler=(ResponseHandler)session.getHandler();
    if (handler.getCause() != null) {
      throw new CamelException("Response Handler had an exception",handler.getCause());
    }
 else {
      if (ExchangeHelper.isOutCapable(exchange)) {
        MinaPayloadHelper.setOut(exchange,handler.getMessage());
      }
 else {
        MinaPayloadHelper.setIn(exchange,handler.getMessage());
      }
    }
  }
}
