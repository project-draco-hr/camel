{
  if (session == null) {
    throw new IllegalStateException("Not started yet!");
  }
  if (!session.isConnected()) {
    doStart();
  }
  Object body=exchange.getIn().getBody();
  if (body == null) {
    LOG.warn("No payload for exchange: " + exchange);
  }
 else {
    if (ExchangeHelper.isOutCapable(exchange)) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("Writing body : " + body);
      }
      latch=new CountDownLatch(1);
      WriteFuture future=session.write(body);
      future.join();
      if (!future.isWritten()) {
        throw new RuntimeException("Timed out waiting for response: " + exchange);
      }
      latch.await(MAX_WAIT_RESPONSE,TimeUnit.MILLISECONDS);
      if (latch.getCount() == 1) {
        throw new RuntimeException("No response from server within " + MAX_WAIT_RESPONSE + " millisecs");
      }
      ResponseHandler handler=(ResponseHandler)session.getHandler();
      if (handler.getCause() != null) {
        throw new Exception("Response Handler had an exception",handler.getCause());
      }
 else {
        if (LOG.isDebugEnabled()) {
          LOG.debug("Handler message: " + handler.getMessage());
        }
        exchange.getOut().setBody(handler.getMessage());
      }
    }
 else {
      session.write(body);
    }
  }
}
