{
  if (type == null) {
    ObjectHelper.notNull(ref,"ref or dataFormat");
    DataFormat dataFormat=routeContext.getCamelContext().resolveDataFormatByRef(ref);
    if (dataFormat == null) {
      type=lookup(routeContext,ref,DataFormatDefinition.class);
      if (type == null) {
        type=routeContext.getDataFormat(ref);
      }
      if (type != null) {
        dataFormat=type.getDataFormat(routeContext);
      }
    }
    if (dataFormat == null) {
      throw new IllegalArgumentException("Cannot find data format in registry with ref: " + ref);
    }
    return dataFormat;
  }
 else {
    return type.getDataFormat(routeContext);
  }
}
