{
  InputStream payload=exchange.getIn().getBody(InputStream.class);
  try {
    if (endpoint.isAutoCreate()) {
      File file=new File(fileName);
      String directory=file.getParent();
      boolean absolute=file.isAbsolute();
      if (directory != null) {
        if (!operations.buildDirectory(directory,absolute)) {
          log.debug("Cannot build directory [" + directory + "] (could be because of denied permissions)");
        }
      }
    }
    if (log.isTraceEnabled()) {
      log.trace("About to write [" + fileName + "] to ["+ getEndpoint()+ "] from exchange ["+ exchange+ "]");
    }
    boolean success=operations.storeFile(fileName,exchange);
    if (!success) {
      throw new GenericFileOperationFailedException("Error writing file [" + fileName + "]");
    }
    if (log.isDebugEnabled()) {
      log.debug("Wrote [" + fileName + "] to ["+ getEndpoint()+ "]");
    }
  }
  finally {
    ObjectHelper.close(payload,"Closing payload",log);
  }
}
