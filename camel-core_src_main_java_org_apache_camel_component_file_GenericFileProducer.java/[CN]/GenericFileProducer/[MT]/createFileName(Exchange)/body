{
  String answer;
  String name=exchange.getIn().getHeader(Exchange.FILE_NAME,String.class);
  Expression expression=endpoint.getFileName();
  if (name != null) {
    if (name.indexOf("${") > -1) {
      if (log.isDebugEnabled()) {
        log.debug(Exchange.FILE_NAME + " contains a FileLanguage expression: " + name);
      }
      Language language=getEndpoint().getCamelContext().resolveLanguage("file");
      expression=language.createExpression(name);
    }
  }
  if (expression != null) {
    if (log.isDebugEnabled()) {
      log.debug("Filename evaluated as expression: " + expression);
    }
    name=expression.evaluate(exchange,String.class);
  }
  if (name != null && endpoint.isFlatten()) {
    int pos=name.lastIndexOf(getFileSeparator());
    if (pos == -1) {
      pos=name.lastIndexOf('/');
    }
    if (pos != -1) {
      name=name.substring(pos + 1);
    }
  }
  String endpointPath=endpoint.getConfiguration().getDirectory();
  String baseDir="";
  if (endpointPath.length() > 0) {
    baseDir=endpointPath + (endpointPath.endsWith(getFileSeparator()) ? "" : getFileSeparator());
  }
  if (name != null) {
    answer=baseDir + name;
  }
 else {
    answer=baseDir + endpoint.getGeneratedFileName(exchange.getIn());
  }
  answer=normalizePath(answer);
  return answer;
}
