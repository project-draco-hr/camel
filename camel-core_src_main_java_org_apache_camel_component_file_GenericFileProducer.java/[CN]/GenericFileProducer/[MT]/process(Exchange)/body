{
  Exchange fileExchange=endpoint.createExchange(exchange);
  endpoint.configureExchange(fileExchange);
  String target=createFileName(exchange);
  Lock lock;
synchronized (locks) {
    lock=locks.get(target);
    if (lock == null) {
      lock=new ReentrantLock();
      locks.put(target,lock);
    }
  }
  lock.lock();
  try {
    processExchange(fileExchange,target);
    ExchangeHelper.copyResults(exchange,fileExchange);
  }
  finally {
    lock.unlock();
  }
}
