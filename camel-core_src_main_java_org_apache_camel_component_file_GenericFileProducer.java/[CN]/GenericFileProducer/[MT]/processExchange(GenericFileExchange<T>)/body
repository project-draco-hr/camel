{
  if (log.isTraceEnabled()) {
    log.trace("Processing " + exchange);
  }
  String target=createFileName(exchange);
  boolean writeAsTempAndRename=ObjectHelper.isNotEmpty(getGenericFileEndpoint().getTempPrefix());
  String tempTarget=null;
  if (writeAsTempAndRename) {
    tempTarget=createTempFileName(target);
  }
  writeFile(exchange,tempTarget != null ? tempTarget : target);
  if (tempTarget != null) {
    if (log.isTraceEnabled()) {
      log.trace("Renaming file: " + tempTarget + " to: "+ target);
    }
    boolean renamed=operations.renameFile(tempTarget,target);
    if (!renamed) {
      throw new GenericFileOperationFailedException("Cannot rename file from: " + tempTarget + " to: "+ target);
    }
  }
  exchange.getIn().setHeader(FileComponent.HEADER_FILE_NAME_PRODUCED,target);
}
