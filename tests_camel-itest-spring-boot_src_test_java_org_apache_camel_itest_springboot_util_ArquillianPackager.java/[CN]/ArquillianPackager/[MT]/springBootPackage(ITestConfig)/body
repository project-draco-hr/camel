{
  ExtensionLoader extensionLoader=new ServiceExtensionLoader(Collections.singleton(getExtensionClassloader()));
  extensionLoader.addOverride(ZipExporter.class,SpringBootZipExporterImpl.class);
  ConfigurationBuilder builder=new ConfigurationBuilder().extensionLoader(extensionLoader);
  Configuration conf=builder.build();
  Domain domain=ShrinkWrap.createDomain(conf);
  JavaArchive ark=domain.getArchiveFactory().create(JavaArchive.class,"test.jar");
  ark=ark.addAsManifestResource("BOOT-MANIFEST.MF","MANIFEST.MF");
  ark=ark.addAsDirectories(LIB_FOLDER);
  if (!CLASSES_FOLDER.equals("")) {
    ark=ark.addAsDirectories(CLASSES_FOLDER);
  }
  if (config.getUseCustomLog()) {
    ark=ark.addAsResource("log4j2-spring.xml",CLASSES_FOLDER + "/log4j2.xml");
  }
  for (  Map.Entry<String,String> res : config.getResources().entrySet()) {
    ark=ark.addAsResource(res.getKey(),CLASSES_FOLDER + "/" + res.getValue());
  }
  String version=System.getProperty("version_org.apache.camel:camel-core");
  if (version == null) {
    config.getMavenVersion();
  }
  if (version == null) {
    List<MavenResolvedArtifact> resolved=Arrays.asList(resolver(config).loadPomFromFile("pom.xml").importRuntimeDependencies().resolve().withoutTransitivity().asResolvedArtifact());
    for (    MavenResolvedArtifact dep : resolved) {
      if (dep.getCoordinate().getGroupId().equals("org.apache.camel")) {
        version=dep.getCoordinate().getVersion();
        break;
      }
    }
  }
  debug("Resolved version: " + version);
  if (version == null) {
    throw new IllegalStateException("Cannot determine the current version of the camel component");
  }
  List<MavenDependencyExclusion> commonExclusions=new LinkedList<>();
  commonExclusions.add(MavenDependencies.createExclusion("org.slf4j","slf4j-log4j12"));
  commonExclusions.add(MavenDependencies.createExclusion("log4j","log4j"));
  commonExclusions.add(MavenDependencies.createExclusion("log4j","apache-log4j-extras"));
  commonExclusions.add(MavenDependencies.createExclusion("org.slf4j","slf4j-simple"));
  commonExclusions.add(MavenDependencies.createExclusion("org.slf4j","slf4j-jdk14"));
  commonExclusions.add(MavenDependencies.createExclusion("ch.qos.logback","logback-classic"));
  commonExclusions.add(MavenDependencies.createExclusion("ch.qos.logback","logback-core"));
  for (  String ex : config.getMavenExclusions()) {
    commonExclusions.add(MavenDependencies.createExclusion(ex));
  }
  MavenDependencyExclusion[] commonExclutionArray=commonExclusions.toArray(new MavenDependencyExclusion[]{});
  List<MavenDependency> moduleDependencies=new LinkedList<>();
  MavenCoordinate mainJar=MavenCoordinates.createCoordinate(config.getMavenGroup(),config.getModuleName(),version,PackagingType.JAR,null);
  MavenDependency mainDep=MavenDependencies.createDependency(mainJar,ScopeType.COMPILE,false,commonExclutionArray);
  moduleDependencies.add(mainDep);
  for (  String canonicalForm : config.getAdditionalDependencies()) {
    MavenCoordinate coord=MavenCoordinates.createCoordinate(canonicalForm);
    MavenDependency dep=MavenDependencies.createDependency(coord,ScopeType.RUNTIME,false);
    moduleDependencies.add(dep);
  }
  if (config.getIncludeProvidedDependencies() || config.getIncludeTestDependencies() || config.getUnitTestEnabled()) {
    List<ScopeType> scopes=new LinkedList<>();
    if (config.getIncludeTestDependencies() || config.getUnitTestEnabled()) {
      scopes.add(ScopeType.TEST);
    }
    if (config.getIncludeProvidedDependencies()) {
      scopes.add(ScopeType.PROVIDED);
    }
    List<MavenResolvedArtifact> moduleArtifacts=Arrays.asList(resolver(config).loadPomFromFile(config.getModuleBasePath() + "/pom.xml").importDependencies(scopes.toArray(new ScopeType[]{})).resolve().withoutTransitivity().asResolvedArtifact());
    for (    MavenResolvedArtifact art : moduleArtifacts) {
      MavenCoordinate c=art.getCoordinate();
      if (!validTestDependency(config,c)) {
        continue;
      }
      Set<String> pomExclusions=DependencyResolver.getExclusions(config.getModuleBasePath() + "/pom.xml",c.getGroupId(),c.getArtifactId());
      MavenDependencyExclusion[] artExclusions;
      if (pomExclusions.isEmpty()) {
        artExclusions=commonExclutionArray;
      }
 else {
        List<MavenDependencyExclusion> specificExclusions=new LinkedList<>(Arrays.asList(commonExclutionArray));
        for (        String spEx : pomExclusions) {
          specificExclusions.add(MavenDependencies.createExclusion(spEx));
        }
        artExclusions=specificExclusions.toArray(new MavenDependencyExclusion[]{});
      }
      MavenDependency dep=MavenDependencies.createDependency(c,ScopeType.RUNTIME,false,artExclusions);
      moduleDependencies.add(dep);
    }
  }
  List<File> dependencies=new LinkedList<>();
  dependencies.addAll(Arrays.asList(resolver(config).loadPomFromFile("pom.xml").importRuntimeDependencies().addDependencies(moduleDependencies).resolve().withTransitivity().asFile()));
  boolean needsSpringTest=excludeDependencyRegex(dependencies,"^camel-test-spring3-.*");
  if (needsSpringTest) {
    MavenDependency dep=MavenDependencies.createDependency("org.apache.camel:camel-test-spring:" + version,ScopeType.RUNTIME,false);
    dependencies=new LinkedList<>();
    dependencies.addAll(Arrays.asList(resolver(config).loadPomFromFile("pom.xml").importRuntimeDependencies().addDependencies(moduleDependencies).addDependencies(dep).resolve().withTransitivity().asFile()));
  }
  excludeDependencyRegex(dependencies,"^spring-boot-loader-[0-9].*");
  excludeDependencyRegex(dependencies,"^camel-test-spring3-.*");
  ark=addDependencies(ark,dependencies);
  ark=ark.addPackages(true,"org.jboss.shrinkwrap");
  ark=ark.addPackages(true,"org.apache.camel.itest.springboot");
  ark=addSpringbootPackage(ark,"org.apache.camel.itest.springboot");
  ark=ark.addPackages(true,"org.springframework.boot.loader");
  ClassPath.Builder external=ClassPath.builder().add(ark);
  external.addSystemProperty("javax.xml.accessExternalDTD","all");
  external.addSystemProperty("javax.xml.accessExternalSchema","all");
  if (config.getUnitTestEnabled()) {
    external.addSystemProperty("container.user.dir",new File(config.getModuleBasePath()).getCanonicalPath());
    external.addSystemProperty("container.test.resources.dir",new File(config.getModuleBasePath()).getCanonicalPath() + "/target/test-classes");
  }
  for (  Map.Entry<Object,Object> e : System.getProperties().entrySet()) {
    if (e.getKey() instanceof String && e.getValue() instanceof String) {
      String key=(String)e.getKey();
      if (key.startsWith(ITestConfigBuilder.CONFIG_PREFIX)) {
        external.addSystemProperty(key,(String)e.getValue());
      }
    }
  }
  for (  Map.Entry<String,String> e : config.getSystemProperties().entrySet()) {
    external.addSystemProperty(e.getKey(),e.getValue());
  }
  return external.build();
}
