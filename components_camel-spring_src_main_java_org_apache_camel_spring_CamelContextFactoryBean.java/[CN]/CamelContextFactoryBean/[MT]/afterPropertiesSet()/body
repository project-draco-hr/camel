{
  Debugger debugger=getBeanForType(Debugger.class);
  if (debugger != null) {
    getContext().addInterceptStrategy(debugger);
  }
  Tracer tracer=getBeanForType(Tracer.class);
  if (tracer != null) {
    TraceFormatter formatter=getBeanForType(TraceFormatter.class);
    if (formatter != null) {
      tracer.setFormatter(formatter);
    }
    getContext().addInterceptStrategy(tracer);
  }
  LifecycleStrategy lifecycleStrategy=getBeanForType(LifecycleStrategy.class);
  if (lifecycleStrategy != null) {
    getContext().setLifecycleStrategy(lifecycleStrategy);
  }
  Registry registry=getBeanForType(Registry.class);
  if (registry != null) {
    getContext().setRegistry(registry);
  }
  if (beanPostProcessor != null) {
    if (beanPostProcessor instanceof ApplicationContextAware) {
      ((ApplicationContextAware)beanPostProcessor).setApplicationContext(applicationContext);
    }
    if (beanPostProcessor instanceof CamelBeanPostProcessor) {
      ((CamelBeanPostProcessor)beanPostProcessor).setCamelContext(getContext());
    }
  }
  for (  RouteType route : routes) {
    for (    InterceptType intercept : intercepts) {
      List<ProcessorType<?>> outputs=new ArrayList<ProcessorType<?>>();
      List<ProcessorType<?>> exceptionHandlers=new ArrayList<ProcessorType<?>>();
      for (      ProcessorType output : route.getOutputs()) {
        if (output instanceof ExceptionType) {
          exceptionHandlers.add(output);
        }
 else {
          outputs.add(output);
        }
      }
      route.clearOutput();
      route.getOutputs().addAll(exceptionHandlers);
      InterceptType proxy=intercept.createProxy();
      route.addOutput(proxy);
      route.pushBlock(proxy.getProceed());
      int outputsSize=proxy.getOutputs().size();
      if (outputsSize > 0) {
        ProcessorType<?> processorType=proxy.getOutputs().get(outputsSize - 1);
        if (processorType instanceof ProceedType) {
          route.getOutputs().addAll(outputs);
        }
      }
    }
  }
  if (dataFormats != null) {
    getContext().setDataFormats(dataFormats.asMap());
  }
  getContext().addRouteDefinitions(routes);
  if (!isJmxEnabled() || (camelJMXAgent != null && camelJMXAgent.isDisabled() != null && camelJMXAgent.isDisabled())) {
    LOG.debug("JMXAgent disabled");
    getContext().setLifecycleStrategy(new DefaultLifecycleStrategy());
  }
 else   if (camelJMXAgent != null) {
    LOG.debug("JMXAgent enabled");
    if (lifecycleStrategy != null) {
      LOG.warn("lifecycleStrategy will be overriden by InstrumentationLifecycleStrategy");
    }
    DefaultInstrumentationAgent agent=new DefaultInstrumentationAgent();
    agent.setConnectorPort(camelJMXAgent.getConnectorPort());
    agent.setCreateConnector(camelJMXAgent.isCreateConnector());
    agent.setMBeanObjectDomainName(camelJMXAgent.getMbeanObjectDomainName());
    agent.setMBeanServerDefaultDomain(camelJMXAgent.getMbeanServerDefaultDomain());
    agent.setRegistryPort(camelJMXAgent.getRegistryPort());
    agent.setServiceUrlPath(camelJMXAgent.getServiceUrlPath());
    agent.setUsePlatformMBeanServer(camelJMXAgent.isUsePlatformMBeanServer());
    getContext().setLifecycleStrategy(new InstrumentationLifecycleStrategy(agent));
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Found JAXB created routes: " + getRoutes());
  }
  findRouteBuiders();
  installRoutes();
}
