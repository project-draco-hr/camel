{
  Debugger debugger=null;
  String[] names=getApplicationContext().getBeanNamesForType(Debugger.class,true,true);
  if (names.length == 1) {
    debugger=(Debugger)getApplicationContext().getBean(names[0],Debugger.class);
  }
  if (debugger == null) {
    ApplicationContext parentContext=getApplicationContext().getParent();
    if (parentContext != null) {
      names=parentContext.getBeanNamesForType(Debugger.class,true,true);
      if (names.length == 1) {
        debugger=(Debugger)parentContext.getBean(names[0],Debugger.class);
      }
    }
  }
  if (debugger != null) {
    getContext().addInterceptStrategy(debugger);
  }
  if (beanPostProcessor != null) {
    if (beanPostProcessor instanceof ApplicationContextAware) {
      ((ApplicationContextAware)beanPostProcessor).setApplicationContext(applicationContext);
    }
    if (beanPostProcessor instanceof CamelBeanPostProcessor) {
      ((CamelBeanPostProcessor)beanPostProcessor).setCamelContext(getContext());
    }
  }
  getContext().addRouteDefinitions(routes);
  if (instrumentationAgent == null && isJmxEnabled()) {
    SpringInstrumentationAgent agent=new SpringInstrumentationAgent();
    if (camelJMXAgent != null) {
      agent.enableJmx(camelJMXAgent.getJmxDomainName(),camelJMXAgent.getConnectorPath(),camelJMXAgent.getConnectorPort());
      if (camelJMXAgent.isCreateConnector() != null) {
        agent.setCreateConnector(camelJMXAgent.isCreateConnector());
      }
      if (camelJMXAgent.isUsePlatformMBeanServer() != null) {
        agent.setUsePlatformMBeanServer(camelJMXAgent.isUsePlatformMBeanServer());
      }
    }
 else {
      agent.enableJmx();
    }
    agent.setCamelContext(getContext());
    String name=getMbeanServer();
    if (name != null) {
      MBeanServer mbeanServer=(MBeanServer)getApplicationContext().getBean(name,MBeanServer.class);
      agent.setMBeanServer(mbeanServer);
    }
    instrumentationAgent=agent;
    instrumentationAgent.start();
  }
  LOG.debug("Found JAXB created routes: " + getRoutes());
  findRouteBuiders();
  installRoutes();
}
