{
  try {
    exchange.getUnitOfWork().beginTransactedBy(transactionKey);
    log.debug("Transaction begin ({}) for ExchangeId: {}",transactionKey,exchange.getExchangeId());
    doInTransactionTemplate(exchange);
    log.debug("Transaction commit ({}) for ExchangeId: {}",transactionKey,exchange.getExchangeId());
  }
 catch (  TransactionRollbackException e) {
    log.debug("Transaction rollback ({}) for ExchangeId: {} due exchange was marked for rollbackOnly",transactionKey,exchange.getExchangeId());
  }
catch (  Throwable e) {
    log.warn("Transaction rollback (" + transactionKey + ") for ExchangeId: "+ exchange.getExchangeId()+ " due exception: "+ e.getMessage());
    exchange.setException(e);
  }
 finally {
    exchange.getUnitOfWork().endTransactedBy(transactionKey);
  }
  Boolean onlyLast=(Boolean)exchange.removeProperty(Exchange.ROLLBACK_ONLY_LAST);
  if (onlyLast != null && onlyLast) {
    if (log.isDebugEnabled()) {
      Exception cause=exchange.getException();
      if (cause != null) {
        log.debug("Transaction rollback (" + transactionKey + ") for ExchangeId: "+ exchange.getExchangeId()+ " due exchange was marked for rollbackOnlyLast and due exception: ",cause);
      }
 else {
        log.debug("Transaction rollback ({}) for ExchangeId: {} due exchange was marked for rollbackOnlyLast",transactionKey,exchange.getExchangeId());
      }
    }
    exchange.setException(null);
  }
}
