{
  if (!endpoint.isDynamicity()) {
    return endpoint.getDbCollection();
  }
  String dynamicDB=exchange.getIn().getHeader(MongoDbConstants.DATABASE,String.class);
  String dynamicCollection=exchange.getIn().getHeader(MongoDbConstants.COLLECTION,String.class);
  @SuppressWarnings("unchecked") List<DBObject> dynamicIndex=exchange.getIn().getHeader(MongoDbConstants.COLLECTION_INDEX,List.class);
  DBCollection dbCol=null;
  if (dynamicDB == null && dynamicCollection == null) {
    dbCol=endpoint.getDbCollection();
  }
 else {
    DB db=null;
    if (dynamicDB == null) {
      db=endpoint.getDb();
    }
 else {
      db=endpoint.getMongoConnection().getDB(dynamicDB);
    }
    if (dynamicCollection == null) {
      dbCol=db.getCollection(endpoint.getCollection());
    }
 else {
      dbCol=db.getCollection(dynamicCollection);
      if (dynamicIndex == null) {
        endpoint.ensureIndex(dbCol,endpoint.createIndex());
      }
 else {
        endpoint.ensureIndex(dbCol,dynamicIndex);
      }
    }
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Dynamic database and/or collection selected: {}->{}",dbCol.getDB().getName(),dbCol.getName());
  }
  return dbCol;
}
