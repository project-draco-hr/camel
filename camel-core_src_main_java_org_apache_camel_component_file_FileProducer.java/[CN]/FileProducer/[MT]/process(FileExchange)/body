{
  ByteBuffer payload=exchange.getIn().getBody(ByteBuffer.class);
  if (payload == null) {
    InputStream in=ExchangeHelper.getMandatoryInBody(exchange,InputStream.class);
    payload=ExchangeHelper.convertToMandatoryType(exchange,ByteBuffer.class,in);
  }
  payload.flip();
  File file=createFileName(exchange);
  buildDirectory(file);
  if (log.isDebugEnabled()) {
    log.debug("Creating file: " + file);
  }
  try {
    FileChannel fc=new RandomAccessFile(file,"rw").getChannel();
    fc.position(fc.size());
    fc.write(payload);
    fc.close();
  }
 catch (  Throwable e) {
    log.error("Failed to write to File: " + file,e);
  }
}
