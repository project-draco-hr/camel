{
  InputStream in=ExchangeHelper.getMandatoryInBody(exchange,InputStream.class);
  File file=createFileName(exchange.getIn());
  buildDirectory(file);
  if (LOG.isDebugEnabled()) {
    LOG.debug("About to write to: " + file + " from exchange: "+ exchange);
  }
  FileChannel fc=null;
  try {
    if (getEndpoint().isAppend()) {
      fc=new RandomAccessFile(file,"rw").getChannel();
      fc.position(fc.size());
    }
 else {
      fc=new FileOutputStream(file).getChannel();
    }
    int size=getEndpoint().getBufferSize();
    byte[] buffer=new byte[size];
    ByteBuffer byteBuffer=ByteBuffer.wrap(buffer);
    while (true) {
      int count=in.read(buffer);
      if (count <= 0) {
        break;
      }
 else       if (count < size) {
        byteBuffer=ByteBuffer.wrap(buffer,0,count);
        fc.write(byteBuffer);
        break;
      }
 else {
        fc.write(byteBuffer);
        byteBuffer.clear();
      }
    }
  }
  finally {
    ObjectHelper.close(in,file.getName(),LOG);
    ObjectHelper.close(fc,file.getName(),LOG);
  }
}
