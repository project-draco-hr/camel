{
  File answer;
  String name=null;
  if (!endpoint.isIgnoreFileNameHeader()) {
    name=message.getHeader(FileComponent.HEADER_FILE_NAME,String.class);
  }
  Expression expression=endpoint.getExpression();
  if (name != null) {
    if (name.indexOf("${") > -1) {
      if (LOG.isDebugEnabled()) {
        LOG.debug(FileComponent.HEADER_FILE_NAME + " contains a FileLanguage expression: " + name);
      }
      expression=FileLanguage.file(name);
    }
  }
  if (expression != null) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Filename evaluated as expression: " + expression);
    }
    Object result=expression.evaluate(message.getExchange());
    name=message.getExchange().getContext().getTypeConverter().convertTo(String.class,result);
  }
  File endpointFile=endpoint.getFile();
  if (endpointFile.isDirectory()) {
    if (name != null) {
      answer=new File(endpointFile,name);
      if (answer.isDirectory()) {
        answer=new File(answer,endpoint.getGeneratedFileName(message));
      }
    }
 else {
      answer=new File(endpointFile,endpoint.getGeneratedFileName(message));
    }
  }
 else {
    if (name == null) {
      answer=endpointFile;
    }
 else {
      answer=new File(endpointFile,name);
    }
  }
  message.setHeader(FileComponent.HEADER_FILE_NAME_PRODUCED,answer.getAbsolutePath());
  return answer;
}
