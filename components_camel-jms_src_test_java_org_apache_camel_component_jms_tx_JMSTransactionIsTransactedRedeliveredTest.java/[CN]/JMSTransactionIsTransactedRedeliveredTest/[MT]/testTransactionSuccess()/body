{
  context.getRouteDefinitions().get(0).adviceWith(context,new AdviceWithRouteBuilder(){
    @Override public void configure() throws Exception {
      onException(AssertionError.class).to("log:error","mock:error");
    }
  }
);
  context.start();
  MockEndpoint error=getMockEndpoint("mock:error");
  error.expectedMessageCount(0);
  MockEndpoint mock=getMockEndpoint("mock:result");
  mock.expectedMessageCount(1);
  mock.expectedBodiesReceived("Bye World");
  mock.message(0).header("count").isEqualTo(3);
  template.sendBody("activemq:queue:okay","Hello World");
  mock.assertIsSatisfied();
  error.assertIsSatisfied();
  Thread.sleep(500);
  ObjectName name=ObjectName.getInstance("org.apache.camel:context=camel-1,type=routes,name=\"myRoute\"");
  Long total=(Long)getMBeanServer().getAttribute(name,"ExchangesTotal");
  assertEquals(3,total.intValue());
  Long completed=(Long)getMBeanServer().getAttribute(name,"ExchangesCompleted");
  assertEquals(1,completed.intValue());
  Long failed=(Long)getMBeanServer().getAttribute(name,"ExchangesFailed");
  assertEquals(2,failed.intValue());
  Long redeliveries=(Long)getMBeanServer().getAttribute(name,"Redeliveries");
  assertEquals(0,redeliveries.intValue());
  Long externalRedeliveries=(Long)getMBeanServer().getAttribute(name,"ExternalRedeliveries");
  assertEquals(2,externalRedeliveries.intValue());
}
