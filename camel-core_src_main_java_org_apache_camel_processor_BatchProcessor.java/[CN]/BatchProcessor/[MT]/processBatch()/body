{
  long start=System.currentTimeMillis();
  long end=start + batchTimeout;
  for (int i=0; !isBatchCompleted(i); i++) {
    long timeout=end - System.currentTimeMillis();
    if (timeout < 0L) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("batch timeout expired at batch index: " + i);
      }
      break;
    }
    Exchange exchange=consumer.receive(timeout);
    if (exchange == null) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("receive with timeout: " + timeout + " expired at batch index: "+ i);
      }
      break;
    }
    collection.add(exchange);
  }
  Iterator<Exchange> iter=collection.iterator();
  while (iter.hasNext()) {
    Exchange exchange=iter.next();
    iter.remove();
    processExchange(exchange);
  }
}
