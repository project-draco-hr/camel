{
  queueLock.lock();
  try {
    do {
      try {
        if (!exchangeEnqueued) {
          exchangeEnqueuedCondition.await(batchTimeout,TimeUnit.MILLISECONDS);
        }
        if (!exchangeEnqueued) {
          drainQueueTo(collection,batchSize);
        }
 else {
          exchangeEnqueued=false;
          while (isInBatchCompleted(queue.size())) {
            drainQueueTo(collection,batchSize);
          }
          if (!isOutBatchCompleted()) {
            continue;
          }
        }
        queueLock.unlock();
        try {
          try {
            sendExchanges();
          }
 catch (          Throwable t) {
            if (t instanceof Exception) {
              getExceptionHandler().handleException(t);
            }
 else {
              getExceptionHandler().handleException(new CamelException(t));
            }
          }
        }
  finally {
          queueLock.lock();
        }
      }
 catch (      InterruptedException e) {
        break;
      }
    }
 while (isRunAllowed());
  }
  finally {
    queueLock.unlock();
  }
}
