{
  Exchange grouped=null;
  Iterator<Exchange> iter=collection.iterator();
  while (iter.hasNext()) {
    Exchange exchange=iter.next();
    iter.remove();
    if (!groupExchanges) {
      processExchange(exchange);
    }
 else {
      if (grouped == null) {
        grouped=new DefaultExchange(exchange);
      }
      List<Exchange> list=grouped.getProperty(Exchange.GROUPED_EXCHANGE,List.class);
      if (list == null) {
        list=new ArrayList<Exchange>();
        grouped.setProperty(Exchange.GROUPED_EXCHANGE,list);
      }
      list.add(exchange);
    }
  }
  if (grouped != null) {
    processExchange(grouped);
  }
}
