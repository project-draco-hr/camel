{
  LOG.trace("Marshal from value {} to type {}",value,type);
  T answer=null;
  if (parentTypeConverter != null) {
    JAXBContext context=createContext(value.getClass());
    Marshaller marshaller=context.createMarshaller();
    Writer buffer=new StringWriter();
    if (isPrettyPrint()) {
      marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT,Boolean.TRUE);
    }
    if (exchange != null && exchange.getProperty(Exchange.CHARSET_NAME,String.class) != null) {
      marshaller.setProperty(Marshaller.JAXB_ENCODING,exchange.getProperty(Exchange.CHARSET_NAME,String.class));
    }
    if (needFiltering(exchange)) {
      XMLStreamWriter writer=exchange.getContext().getTypeConverter().convertTo(XMLStreamWriter.class,buffer);
      FilteringXmlStreamWriter filteringWriter=new FilteringXmlStreamWriter(writer);
      marshaller.marshal(value,filteringWriter);
    }
 else {
      marshaller.marshal(value,buffer);
    }
    answer=parentTypeConverter.convertTo(type,buffer.toString());
  }
  return answer;
}
