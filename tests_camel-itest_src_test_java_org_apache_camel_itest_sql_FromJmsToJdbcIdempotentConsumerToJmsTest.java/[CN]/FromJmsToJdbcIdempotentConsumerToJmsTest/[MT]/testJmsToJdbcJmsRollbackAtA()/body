{
  checkInitialState();
  NotifyBuilder notify=new NotifyBuilder(context).whenDone(7).create();
  getMockEndpoint("mock:a").expectedMessageCount(7);
  getMockEndpoint("mock:a").whenAnyExchangeReceived(new Processor(){
    @Override public void process(    Exchange exchange) throws Exception {
      throw new ConnectException("Forced cannot connect to database");
    }
  }
);
  getMockEndpoint("mock:b").expectedMessageCount(0);
  template.sendBodyAndHeader("activemq:queue:inbox","A","uid",123);
  assertMockEndpointsSatisfied();
  assertTrue("Should complete 7 message",notify.matchesMockWaitTime());
  assertEquals(0,jdbcTemplate.queryForInt("select count(*) from CAMEL_MESSAGEPROCESSED"));
  assertNull(consumer.receiveBody("activemq:queue:outbox",3000));
  assertEquals("A",consumer.receiveBody("activemq:queue:ActiveMQ.DLQ",3000));
}
