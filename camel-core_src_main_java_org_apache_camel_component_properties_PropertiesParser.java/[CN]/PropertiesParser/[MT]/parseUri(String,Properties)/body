{
  String answer=uri;
  boolean done=false;
  List<String> visited=new ArrayList<String>();
  while (!done) {
    List<String> replaced=new ArrayList<String>();
    answer=doParseUri(answer,properties,replaced);
    for (    String replace : replaced) {
      if (visited.contains(replace)) {
        throw new IllegalArgumentException("Circular reference detected with key [" + replace + "] in uri "+ uri);
      }
    }
    visited.addAll(replaced);
    done=!answer.contains(PREFIX_TOKEN);
  }
  return answer;
}
