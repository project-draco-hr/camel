{
  Class<?> testClass=getTestClass();
  try {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Loading ApplicationContext for locations [" + StringUtils.arrayToCommaDelimitedString(locations) + "].");
    }
    GenericApplicationContext context=createContext(testClass);
    (new XmlBeanDefinitionReader(context)).loadBeanDefinitions(locations);
    AnnotationConfigUtils.registerAnnotationConfigProcessors(context);
    handleDisableJmx(context,testClass);
    SpringCamelContext.setNoStart(true);
    context.refresh();
    context.registerShutdownHook();
    SpringCamelContext.setNoStart(false);
    handleProvidesBreakpoint(context,testClass);
    handleShutdownTimeout(context,testClass);
    handleMockEndpoints(context,testClass);
    handleLazyLoadTypeConverters(context,testClass);
    handleCamelContextStartup(context,testClass);
    return context;
  }
  finally {
    SpringCamelContext.setNoStart(false);
    if (testClass.isAnnotationPresent(DisableJmx.class)) {
      if (CamelSpringTestHelper.getOriginalJmxDisabled() == null) {
        System.clearProperty(JmxSystemPropertyKeys.DISABLED);
      }
 else {
        System.setProperty(JmxSystemPropertyKeys.DISABLED,CamelSpringTestHelper.getOriginalJmxDisabled());
      }
    }
  }
}
