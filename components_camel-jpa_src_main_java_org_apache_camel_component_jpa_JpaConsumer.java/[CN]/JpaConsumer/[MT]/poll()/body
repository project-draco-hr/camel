{
  template.execute(new JpaCallback(){
    public Object doInJpa(    EntityManager entityManager) throws PersistenceException {
      Queue<DataHolder> answer=new LinkedList<DataHolder>();
      Query query=getQueryFactory().createQuery(entityManager);
      configureParameters(query);
      List<Object> results=CastUtils.cast(query.getResultList());
      for (      Object result : results) {
        DataHolder holder=new DataHolder();
        holder.manager=entityManager;
        holder.result=result;
        holder.exchange=createExchange(result);
        answer.add(holder);
      }
      try {
        processBatch(CastUtils.cast(answer));
      }
 catch (      Exception e) {
        throw new PersistenceException(e);
      }
      entityManager.flush();
      return null;
    }
  }
);
}
