{
  template.execute(new JpaCallback(){
    public Object doInJpa(    EntityManager entityManager) throws PersistenceException {
      Query query=getQueryFactory().createQuery(entityManager);
      configureParameters(query);
      List results=query.getResultList();
      for (      Object result : results) {
        if (log.isDebugEnabled()) {
          log.debug("Processing new entity: " + result);
        }
        if (lockEntity(result,entityManager)) {
          Exchange exchange=createExchange(result);
          try {
            getProcessor().process(exchange);
          }
 catch (          Exception e) {
            throw new PersistenceException(e);
          }
          getDeleteHandler().deleteObject(entityManager,result);
        }
      }
      entityManager.flush();
      return null;
    }
  }
);
}
