{
  boolean streamTreatment=true;
  Object xml=graph instanceof String ? null : exchange.getContext().getTypeConverter().convertTo(InputStream.class,exchange,graph);
  if (xml == null) {
    xml=exchange.getContext().getTypeConverter().mandatoryConvertTo(String.class,exchange,graph);
    streamTreatment=false;
  }
  JSON json;
  if (streamTreatment) {
    json=serializer.readFromStream((InputStream)xml);
  }
 else {
    json=serializer.read((String)xml);
  }
  String encoding=IOHelper.getCharsetName(exchange,false);
  if (encoding == null) {
    encoding=getEncoding();
  }
  OutputStreamWriter osw=null;
  if (encoding != null) {
    osw=new OutputStreamWriter(stream,encoding);
  }
 else {
    osw=new OutputStreamWriter(stream);
  }
  json.write(osw);
  osw.flush();
}
