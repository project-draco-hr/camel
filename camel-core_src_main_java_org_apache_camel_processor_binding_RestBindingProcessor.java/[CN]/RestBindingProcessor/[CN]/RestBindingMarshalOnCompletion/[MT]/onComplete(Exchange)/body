{
  boolean isXml=false;
  boolean isJson=false;
  String contentType=ExchangeHelper.getContentType(exchange);
  if (contentType != null) {
    isXml=contentType.toLowerCase(Locale.US).contains("xml");
    isJson=contentType.toLowerCase(Locale.US).contains("json");
  }
  if (!isXml && !isJson) {
    isXml=produces != null && produces.toLowerCase(Locale.US).contains("xml");
    isJson=produces != null && produces.toLowerCase(Locale.US).contains("json");
  }
  ExchangeHelper.prepareOutToIn(exchange);
  if (!isXml && !isJson) {
    String body=MessageHelper.extractBodyAsString(exchange.getIn());
    isXml=body.startsWith("<") || body.contains("xml");
    isJson=!isXml;
  }
  isXml&=bindingMode.equals("auto") || bindingMode.contains("xml");
  isJson&=bindingMode.equals("auto") || bindingMode.contains("json");
  try {
    if (isXml && xmlMmarshal != null) {
      xmlMmarshal.process(exchange);
    }
 else     if (isJson && jsonMmarshal != null) {
      jsonMmarshal.process(exchange);
    }
  }
 catch (  Throwable e) {
    exchange.setException(e);
  }
}
