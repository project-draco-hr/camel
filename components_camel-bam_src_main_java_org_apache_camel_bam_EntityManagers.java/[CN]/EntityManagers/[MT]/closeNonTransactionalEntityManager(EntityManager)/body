{
  boolean isTransactional=TransactionSynchronizationManager.hasResource(entityManager.getEntityManagerFactory());
  if (entityManager != null && isTransactional) {
    entityManager.close();
  }
}
