{
  MockEndpoint result=getMockEndpoint("mock:result");
  result.expectedBodiesReceived("inputx+inputy+inputz");
  String url;
  if (isParallel) {
    url="direct:parallel";
  }
 else {
    url="direct:sequential";
  }
  Exchange exchange=template.request(url,new Processor(){
    public void process(    Exchange exchange){
      Message in=exchange.getIn();
      in.setBody("input");
      in.setHeader("foo","bar");
    }
  }
);
  assertNotNull("We should get result here",exchange);
  assertEquals("Can't get the right result","inputx+inputy+inputz",exchange.getOut().getBody(String.class));
  assertMockEndpointsSatisfied();
}
