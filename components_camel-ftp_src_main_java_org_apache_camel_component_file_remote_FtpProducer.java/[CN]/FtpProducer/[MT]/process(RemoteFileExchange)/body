{
  InputStream payload=exchange.getIn().getBody(InputStream.class);
  try {
    String fileName=createFileName(exchange.getIn(),endpoint.getConfiguration());
    int lastPathIndex=fileName.lastIndexOf('/');
    if (lastPathIndex != -1) {
      String directory=fileName.substring(0,lastPathIndex);
      if (!buildDirectory(client,directory)) {
        LOG.warn("Couldn't build directory: " + directory + " (either permissions deny it, or it already exists)");
      }
    }
    final boolean success=client.storeFile(fileName,payload);
    if (!success) {
      throw new RuntimeCamelException("Error sending file: " + fileName);
    }
    RemoteFileConfiguration config=endpoint.getConfiguration();
    LOG.info("Sent: " + fileName + " to "+ config.toString().substring(0,config.toString().indexOf(config.getFile())));
  }
  finally {
    if (payload != null) {
      payload.close();
    }
  }
}
