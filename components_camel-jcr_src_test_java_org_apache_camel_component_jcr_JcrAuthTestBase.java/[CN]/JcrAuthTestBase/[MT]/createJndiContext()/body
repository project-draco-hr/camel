{
  Context context=super.createJndiContext();
  File config=new File(CONFIG_FILE);
  if (!config.exists())   throw new Exception("missing config file: " + config.getPath());
  repository=new TransientRepository(CONFIG_FILE,"target/repository_with_auth");
  SessionImpl session=(SessionImpl)repository.login(new SimpleCredentials("admin","admin".toCharArray()));
  UserManager userManager=session.getUserManager();
  User user=(User)userManager.getAuthorizable("test");
  if (user == null)   user=userManager.createUser("test","quatloos");
  String permissionsPath=session.getRootNode().getPath();
  AccessControlManager accessControlManager=session.getAccessControlManager();
  AccessControlPolicyIterator acls=accessControlManager.getApplicablePolicies(permissionsPath);
  if (acls.hasNext()) {
    JackrabbitAccessControlList acl=(JackrabbitAccessControlList)acls.nextAccessControlPolicy();
    acl.addEntry(user.getPrincipal(),accessControlManager.getSupportedPrivileges(permissionsPath),true);
    accessControlManager.setPolicy(permissionsPath,acl);
  }
 else {
    throw new Exception("could not set access control for path " + permissionsPath);
  }
  session.save();
  session.logout();
  context.bind("repository",repository);
  return context;
}
