{
  Object result=maxRequestsPerPeriodExpression.evaluate(exchange,Object.class);
  if (maximumRequestsPerPeriod == 0 && result == null) {
    throw new RuntimeExchangeException("The max requests per period expression was evaluated as null: " + maxRequestsPerPeriodExpression,exchange);
  }
  Long longValue=exchange.getContext().getTypeConverter().convertTo(Long.class,result);
  if (longValue != null) {
    if (maximumRequestsPerPeriod > 0 && longValue.longValue() != maximumRequestsPerPeriod) {
      log.debug("Throttler changed maximum requests per period from {} to {}",maximumRequestsPerPeriod,longValue);
    }
    if (maximumRequestsPerPeriod > longValue) {
      slot.capacity=0;
    }
    maximumRequestsPerPeriod=longValue;
  }
  if (maximumRequestsPerPeriod <= 0) {
    throw new IllegalStateException("The maximumRequestsPerPeriod must be a positive number, was: " + maximumRequestsPerPeriod);
  }
  TimeSlot slot=nextSlot();
  if (!slot.isActive()) {
    long delay=slot.startTime - currentSystemTime();
    return delay;
  }
 else {
    return 0;
  }
}
