{
  long now=currentSystemTime();
  if (startTimeMillis == 0) {
    startTimeMillis=now;
  }
  if (now - startTimeMillis > timePeriodMillis) {
    requestCount=1;
    startTimeMillis=now;
  }
 else {
    if (++requestCount > maximumRequestsPerPeriod) {
      long time=startTimeMillis + timePeriodMillis;
      waitUntil(time,exchange);
    }
  }
}
