{
  if (processor == null) {
    return;
  }
  if (!onComplete && !onFailure) {
    return;
  }
  exchange.getUnitOfWork().addSynchronization(new SynchronizationAdapter(){
    @Override public void onComplete(    Exchange exchange){
      if (!onComplete) {
        return;
      }
      if (onWhen != null && !onWhen.matches(exchange)) {
        return;
      }
      final Exchange copy=prepareExchange(exchange);
      getExecutorService().submit(new Callable<Exchange>(){
        public Exchange call() throws Exception {
          if (LOG.isDebugEnabled()) {
            LOG.debug("Processing onComplete: " + copy);
          }
          processor.process(copy);
          return copy;
        }
      }
);
    }
    public void onFailure(    Exchange exchange){
      if (!onFailure) {
        return;
      }
      if (onWhen != null && !onWhen.matches(exchange)) {
        return;
      }
      final Exchange copy=prepareExchange(exchange);
      copy.setException(null);
      getExecutorService().submit(new Callable<Exchange>(){
        public Exchange call() throws Exception {
          if (LOG.isDebugEnabled()) {
            LOG.debug("Processing onFailure: " + copy);
          }
          processor.process(copy);
          return copy;
        }
      }
);
    }
    @Override public String toString(){
      if (onComplete && onFailure) {
        return "onCompleteOrFailure";
      }
 else       if (onComplete) {
        return "onCompleteOnly";
      }
 else {
        return "onFailureOnly";
      }
    }
  }
);
}
