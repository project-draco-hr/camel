{
  final String messageId=messageIdExpression.evaluate(exchange,String.class);
  if (messageId == null) {
    throw new NoMessageIdException(exchange,messageIdExpression);
  }
  boolean newKey;
  if (eager) {
    newKey=idempotentRepository.add(messageId);
  }
 else {
    newKey=!idempotentRepository.contains(messageId);
  }
  if (!newKey) {
    onDuplicateMessage(exchange,messageId);
    callback.done(true);
    return true;
  }
  exchange.addOnCompletion(new IdempotentOnCompletion(idempotentRepository,messageId,eager));
  return processor.process(exchange,callback);
}
