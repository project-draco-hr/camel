{
  String messageId=messageIdExpression.evaluate(exchange,String.class);
  if (messageId == null) {
    throw new NoMessageIdException(exchange,messageIdExpression);
  }
  if (idempotentRepository.contains(messageId)) {
    onDuplicateMessage(exchange,messageId);
  }
 else {
    processor.process(exchange);
    if (!exchange.isFailed()) {
      onCompletedMessage(exchange,messageId);
    }
 else {
      onFailedMessage(exchange,messageId);
    }
  }
}
