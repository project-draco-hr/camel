{
  File tmpZip=File.createTempFile(source.getName(),null);
  tmpZip.delete();
  if (!source.renameTo(tmpZip)) {
    throw new IOException("Cannot create temp file: " + source.getName());
  }
  FileInputStream fis=new FileInputStream(tmpZip);
  ZipInputStream zin=new ZipInputStream(fis);
  ZipOutputStream out=new ZipOutputStream(new FileOutputStream(source));
  try {
    out.putNextEntry(new ZipEntry(entryName));
    out.write(buffer,0,length);
    out.closeEntry();
    for (ZipEntry ze=zin.getNextEntry(); ze != null; ze=zin.getNextEntry()) {
      out.putNextEntry(ze);
      for (int read=zin.read(buffer); read > -1; read=zin.read(buffer)) {
        out.write(buffer,0,read);
      }
      out.closeEntry();
    }
  }
  finally {
    IOHelper.close(fis,zin,out);
  }
  tmpZip.delete();
}
