{
  FileChannel out=null;
  try {
    out=prepareOutputFileChannel(target,out);
    if (LOG.isTraceEnabled()) {
      LOG.trace("Using InputStream to transfer from: " + in + " to: "+ out);
    }
    int size=endpoint.getBufferSize();
    byte[] buffer=new byte[size];
    ByteBuffer byteBuffer=ByteBuffer.wrap(buffer);
    while (true) {
      int count=in.read(buffer);
      if (count <= 0) {
        break;
      }
 else       if (count < size) {
        byteBuffer=ByteBuffer.wrap(buffer,0,count);
        out.write(byteBuffer);
        break;
      }
 else {
        out.write(byteBuffer);
        byteBuffer.clear();
      }
    }
  }
  finally {
    ObjectHelper.close(in,target.getName(),LOG);
    ObjectHelper.close(out,target.getName(),LOG);
  }
}
