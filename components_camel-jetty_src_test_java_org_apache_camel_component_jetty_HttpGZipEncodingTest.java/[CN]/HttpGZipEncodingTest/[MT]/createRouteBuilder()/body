{
  return new RouteBuilder(){
    public void configure(){
      port1=getPort();
      port2=getNextPort();
      errorHandler(noErrorHandler());
      from("direct:gzip").marshal().gzip().setProperty(Exchange.SKIP_GZIP_ENCODING,ExpressionBuilder.constantExpression(Boolean.TRUE)).to("http://localhost:" + port1 + "/gzip").unmarshal().gzip();
      from("jetty:http://localhost:" + port1 + "/gzip").process(new Processor(){
        public void process(        Exchange exchange) throws Exception {
          HttpServletRequest request=exchange.getIn().getHeader(Exchange.HTTP_SERVLET_REQUEST,HttpServletRequest.class);
          if ("POST".equals(request.getMethod())) {
            String requestBody=exchange.getIn().getBody(String.class);
            assertEquals("Get a wrong request string","<Hello>World</Hello>",requestBody);
          }
          exchange.getOut().setHeader(Exchange.CONTENT_ENCODING,"gzip");
          String header=exchange.getIn().getHeader("Accept-Encoding",String.class);
          if (header != null && header.indexOf("gzip") > -1) {
            exchange.getOut().setBody("<b>Hello World for gzip</b>");
          }
 else {
            exchange.getOut().setBody("<b>Hello World</b>");
          }
        }
      }
);
      from("jetty:http://localhost:" + port2 + "/route?bridgeEndpoint=true").to("http://localhost:" + port1 + "/gzip?bridgeEndpoint=true");
    }
  }
;
}
