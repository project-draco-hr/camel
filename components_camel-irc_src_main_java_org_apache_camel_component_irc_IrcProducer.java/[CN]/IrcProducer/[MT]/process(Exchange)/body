{
  final String msg=exchange.getIn().getBody(String.class);
  final String targetChannel=exchange.getIn().getHeader(IrcConstants.IRC_TARGET,String.class);
  if (!connection.isConnected()) {
    throw new RuntimeCamelException("Lost connection to " + connection.getHost());
  }
  if (isMessageACommand(msg)) {
    LOG.debug("Sending command: {}",msg);
    connection.send(msg);
  }
 else   if (targetChannel != null) {
    LOG.debug("Sending to: {} message: {}",targetChannel,msg);
    connection.doPrivmsg(targetChannel,msg);
  }
 else {
    for (    String channel : endpoint.getConfiguration().getChannels()) {
      LOG.debug("Sending to: {} message: {}",channel,msg);
      connection.doPrivmsg(channel,msg);
    }
  }
}
