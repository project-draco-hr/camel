{
  final String msg=exchange.getIn().getBody(String.class);
  final String targetChannel=exchange.getIn().getHeader(IrcConstants.IRC_TARGET,String.class);
  if (!connection.isConnected()) {
    throw new RuntimeCamelException("Lost connection to " + connection.getHost());
  }
  if (isMessageACommand(msg)) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Sending command: " + msg);
    }
    connection.send(msg);
  }
 else   if (targetChannel != null) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Sending to: " + targetChannel + " message: "+ msg);
    }
    connection.doPrivmsg(targetChannel,msg);
  }
 else {
    for (    String channel : endpoint.getConfiguration().getChannels()) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("Sending to: " + channel + " message: "+ msg);
      }
      connection.doPrivmsg(channel,msg);
    }
  }
}
