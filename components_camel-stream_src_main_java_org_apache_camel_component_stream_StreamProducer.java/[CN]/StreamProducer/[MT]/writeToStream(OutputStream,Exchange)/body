{
  Object body=exchange.getIn().getBody();
  if (body == null) {
    log.debug("Body is null, cannot write it to the stream.");
    return;
  }
  if (!(body instanceof String)) {
    byte[] bytes=exchange.getIn().getBody(byte[].class);
    if (bytes != null) {
      LOG.debug("Writing as byte[]: {} to {}",bytes,outputStream);
      outputStream.write(bytes);
      return;
    }
  }
  String s=exchange.getIn().getMandatoryBody(String.class);
  Charset charset=endpoint.getCharset();
  Writer writer=new OutputStreamWriter(outputStream,charset);
  BufferedWriter bw=IOHelper.buffered(writer);
  if (LOG.isDebugEnabled()) {
    LOG.debug("Writing as text: {} to {} using encoding: {}",new Object[]{body,outputStream,charset});
  }
  bw.write(s);
  bw.write(System.lineSeparator());
  bw.flush();
}
