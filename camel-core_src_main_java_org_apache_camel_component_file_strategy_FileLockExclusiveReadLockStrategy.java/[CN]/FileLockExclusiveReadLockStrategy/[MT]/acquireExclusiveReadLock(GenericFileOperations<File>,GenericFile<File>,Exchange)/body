{
  File target=new File(file.getAbsoluteFilePath());
  if (LOG.isTraceEnabled()) {
    LOG.trace("Waiting for exclusive read lock to file: " + target);
  }
  try {
    FileChannel channel=new RandomAccessFile(target,"rw").getChannel();
    long start=System.currentTimeMillis();
    boolean exclusive=false;
    while (!exclusive) {
      if (timeout > 0) {
        long delta=System.currentTimeMillis() - start;
        if (delta > timeout) {
          LOG.warn("Cannot acquire read lock within " + timeout + " millis. Will skip the file: "+ target);
          return false;
        }
      }
      FileLock lock=null;
      try {
        lock=timeout > 0 ? channel.tryLock() : channel.lock();
      }
 catch (      IllegalStateException ex) {
      }
      if (lock != null) {
        if (LOG.isTraceEnabled()) {
          LOG.trace("Acquired exclusive read lock: " + lock + " to file: "+ target);
        }
        exchange.setProperty("CamelFileLock",lock);
        exchange.setProperty("CamelFileLockName",target.getName());
        exclusive=true;
      }
 else {
        boolean interrupted=sleep();
        if (interrupted) {
          return false;
        }
      }
    }
  }
 catch (  IOException e) {
    if (timeout == 0) {
      throw e;
    }
    if (LOG.isDebugEnabled()) {
      LOG.debug("Cannot acquire read lock. Will try again.",e);
    }
    boolean interrupted=sleep();
    if (interrupted) {
      return false;
    }
  }
  return true;
}
