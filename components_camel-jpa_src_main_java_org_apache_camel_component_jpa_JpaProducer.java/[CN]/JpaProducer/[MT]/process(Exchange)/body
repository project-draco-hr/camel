{
  exchange.getIn().setHeader(JpaConstants.JPA_TEMPLATE,endpoint.getTemplate());
  final Object values=expression.evaluate(exchange,Object.class);
  if (values != null) {
    template.execute(new JpaCallback(){
      public Object doInJpa(      EntityManager entityManager) throws PersistenceException {
        Iterator iter=ObjectHelper.createIterator(values);
        while (iter.hasNext()) {
          Object value=iter.next();
          if (endpoint.isUsePersist()) {
            entityManager.persist(value);
          }
 else {
            entityManager.merge(value);
          }
        }
        if (endpoint.isFlushOnSend()) {
          entityManager.flush();
        }
        return null;
      }
    }
);
  }
  exchange.getIn().removeHeader(JpaConstants.JPA_TEMPLATE);
}
