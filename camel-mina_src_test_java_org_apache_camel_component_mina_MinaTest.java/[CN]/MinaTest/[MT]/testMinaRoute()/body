{
  final CountDownLatch latch=new CountDownLatch(1);
  CamelContext container=new DefaultCamelContext<Exchange>();
  container.setRoutes(new RouteBuilder(){
    public void configure(){
      from("mina:vm:8080").process(new Processor<MinaExchange>(){
        public void onExchange(        MinaExchange e){
          System.out.println("Received exchange: " + e.getIn());
          latch.countDown();
        }
      }
);
    }
  }
);
  container.activateEndpoints();
  Endpoint<MinaExchange> endpoint=container.resolveEndpoint("mina:vm:8080");
  MinaExchange exchange=endpoint.createExchange();
  Message message=exchange.getIn();
  message.setBody("Hello there!");
  message.getHeaders().setHeader("cheese",123);
  endpoint.onExchange(exchange);
  boolean received=latch.await(5,TimeUnit.SECONDS);
  assertTrue("Did not receive the message!",received);
  container.deactivateEndpoints();
}
