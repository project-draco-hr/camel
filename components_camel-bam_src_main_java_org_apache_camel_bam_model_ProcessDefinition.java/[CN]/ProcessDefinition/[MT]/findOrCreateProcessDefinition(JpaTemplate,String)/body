{
  EntityManager entityManager=null;
  try {
    entityManager=resolveEntityManager(template.getEntityManagerFactory());
    String definitionsQuery="select x from " + QueryUtils.getTypeName(ProcessDefinition.class) + " x where x.name = :processName";
    List<ProcessDefinition> list=entityManager.createQuery(definitionsQuery,ProcessDefinition.class).setParameter("processName",processName).getResultList();
    if (!list.isEmpty()) {
      return list.get(0);
    }
 else {
      ProcessDefinition answer=new ProcessDefinition();
      answer.setName(processName);
      template.persist(answer);
      return answer;
    }
  }
  finally {
    closeNonTransactionalEntityManager(entityManager);
  }
}
