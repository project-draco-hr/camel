{
  BacklogTracer backlogTracer=BacklogTracer.getBacklogTracer(camelContext);
  if (backlogTracer == null) {
    backlogTracer=(BacklogTracer)camelContext.getDefaultBacklogTracer();
  }
  if (format == null || "text".equals(format)) {
    JAXBContext context=JAXBContext.newInstance(MessageDump.class);
    Unmarshaller unmarshaller=context.createUnmarshaller();
    SimpleDateFormat sdf=new SimpleDateFormat(BacklogTracerEventMessage.TIMESTAMP_FORMAT);
    List<BacklogTracerEventMessage> events;
    if (pattern != null) {
      events=backlogTracer.dumpTracedMessages(pattern);
    }
 else {
      events=backlogTracer.dumpAllTracedMessages();
    }
    for (    BacklogTracerEventMessage event : events) {
      MessageDump msg=(MessageDump)unmarshaller.unmarshal(new StringReader(event.getMessageAsXml()));
      String breadcrumb=getBreadcrumbId(msg.getHeaders());
      out.println("#" + event.getUid() + "\tTimestamp:\t"+ sdf.format(event.getTimestamp()));
      if (breadcrumb != null) {
        out.println("Breadcrumb: " + breadcrumb);
      }
      out.println("ExchangeId: " + event.getExchangeId());
      if (event.getToNode() != null) {
        out.println("Route: " + event.getRouteId() + "\t--> "+ event.getToNode());
      }
 else {
        out.println("Route: " + event.getRouteId());
      }
      String body=msg.getBody().getValue();
      if (bodySize != null && bodySize > 0) {
        if (body.length() > bodySize) {
          body=body.substring(0,bodySize);
        }
      }
      out.println(body);
      out.println("");
    }
  }
 else   if ("xml".equals(format)) {
    if (pattern != null) {
      out.println("BacklogTracer messages:\n" + backlogTracer.dumpTracedMessages(pattern));
    }
 else {
      out.println("BacklogTracer messages:\n" + backlogTracer.dumpAllTracedMessagesAsXml());
    }
    return null;
  }
  return null;
}
