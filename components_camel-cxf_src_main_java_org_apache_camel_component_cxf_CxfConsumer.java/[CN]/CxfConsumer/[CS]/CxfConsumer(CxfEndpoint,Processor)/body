{
  super(endpoint,processor);
  ServerFactoryBean svrBean=endpoint.createServerFactoryBean();
  svrBean.setInvoker(new Invoker(){
    public Object invoke(    Exchange cxfExchange,    Object o){
      if (LOG.isTraceEnabled()) {
        LOG.trace("Received CXF Request: " + cxfExchange);
      }
      CxfEndpoint endpoint=(CxfEndpoint)getEndpoint();
      CxfBinding binding=endpoint.getCxfBinding();
      org.apache.camel.Exchange camelExchange=endpoint.createExchange();
      DataFormat dataFormat=endpoint.getDataFormat();
      BindingOperationInfo boi=cxfExchange.getBindingOperationInfo();
      if (dataFormat == DataFormat.PAYLOAD && boi.isUnwrapped()) {
        boi=boi.getWrappedOperation();
        cxfExchange.put(BindingOperationInfo.class,boi);
      }
      if (boi != null) {
        camelExchange.setProperty(BindingOperationInfo.class.getName(),boi);
        if (LOG.isTraceEnabled()) {
          LOG.trace("Set exchange property: BindingOperationInfo: " + boi);
        }
      }
      camelExchange.setProperty(CxfConstants.DATA_FORMAT_PROPERTY,dataFormat);
      if (LOG.isTraceEnabled()) {
        LOG.trace("Set Exchange property: " + DataFormat.class.getName() + "="+ dataFormat);
      }
      camelExchange.setProperty(Message.MTOM_ENABLED,String.valueOf(endpoint.isMtomEnabled()));
      binding.populateExchangeFromCxfRequest(cxfExchange,camelExchange);
      Map<String,Object> context=new HashMap<String,Object>();
      binding.extractJaxWsContext(cxfExchange,context);
      if (LOG.isTraceEnabled()) {
        LOG.trace("Processing +++ START +++");
      }
      try {
        getProcessor().process(camelExchange);
      }
 catch (      Exception e) {
        throw new Fault(e);
      }
      if (LOG.isTraceEnabled()) {
        LOG.trace("Processing +++ END +++");
      }
      checkFailure(camelExchange);
      if (camelExchange.getPattern().isOutCapable()) {
        binding.populateCxfResponseFromExchange(camelExchange,cxfExchange);
      }
      checkFailure(camelExchange);
      binding.copyJaxWsContext(cxfExchange,context);
      return null;
    }
    private void checkFailure(    org.apache.camel.Exchange camelExchange) throws Fault {
      final Throwable t;
      if (camelExchange.isFailed()) {
        t=(camelExchange.hasOut() && camelExchange.getOut().isFault()) ? camelExchange.getOut().getBody(Throwable.class) : camelExchange.getException();
        if (t instanceof Fault) {
          throw (Fault)t;
        }
 else         if (t != null) {
          Fault fault=new Fault(t);
          if (fault.getMessage() == null) {
            fault.setMessage(t.getClass().getSimpleName());
          }
          WebFault faultAnnotation=t.getClass().getAnnotation(WebFault.class);
          Object faultInfo=null;
          try {
            Method method=t.getClass().getMethod("getFaultInfo",new Class[0]);
            faultInfo=method.invoke(t,new Object[0]);
          }
 catch (          Exception e) {
          }
          if (faultAnnotation != null && faultInfo == null) {
            Element detail=fault.getOrCreateDetail();
            Element faultDetails=detail.getOwnerDocument().createElementNS(faultAnnotation.targetNamespace(),faultAnnotation.name());
            detail.appendChild(faultDetails);
          }
          throw fault;
        }
      }
    }
  }
);
  server=svrBean.create();
}
