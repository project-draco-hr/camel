{
  MinaEndpoint endpoint=map.get(uri);
  if (endpoint == null) {
    String remainingUrl=uri.substring("mina:".length());
    URI u=new URI(remainingUrl);
    String protocol=u.getScheme();
    if (protocol.equals("tcp")) {
      endpoint=createSocketEndpoint(uri,u);
    }
 else     if (protocol.equals("udp") || protocol.equals("mcast") || protocol.equals("multicast")) {
      endpoint=createDatagramEndpoint(uri,u);
    }
 else     if (protocol.equals("vm")) {
      endpoint=createVmEndpoint(uri,u);
    }
 else {
      throw new IOException("Unrecognised MINA protocol: " + protocol + " for uri: "+ uri);
    }
    map.put(uri,endpoint);
  }
  return endpoint;
}
