{
  DataSource target=null;
  DataSource ds=resolveAndRemoveReferenceParameter(parameters,"dataSource",DataSource.class);
  if (ds != null) {
    target=ds;
  }
  String dataSourceRef=getAndRemoveParameter(parameters,"dataSourceRef",String.class);
  if (target == null && dataSourceRef != null) {
    target=CamelContextHelper.mandatoryLookup(getCamelContext(),dataSourceRef,DataSource.class);
  }
  if (target == null) {
    target=getDataSource();
  }
  if (target == null) {
    throw new IllegalArgumentException("DataSource must be configured");
  }
  JdbcTemplate jdbcTemplate=new JdbcTemplate(target);
  IntrospectionSupport.setProperties(jdbcTemplate,parameters,"template.");
  String elsqlName=remaining;
  String resUri=resourceUri;
  String[] part=remaining.split("/");
  if (part.length == 2) {
    elsqlName=part[0];
    resUri=part[1];
  }
 else   if (part.length > 2) {
    throw new IllegalArgumentException("Invalid uri. Must by elsql:elsqlName/resourceUri, was: " + uri);
  }
  ElsqlEndpoint endpoint=new ElsqlEndpoint(uri,this,jdbcTemplate,elsqlName,resUri);
  endpoint.setDataSource(ds);
  endpoint.setDataSourceRef(dataSourceRef);
  endpoint.setElSqlConfig(elSqlConfig);
  return endpoint;
}
