{
  if (scriptText == null && scriptResource == null) {
    throw new IllegalArgumentException("Neither scriptText or scriptResource are specified");
  }
  ScriptEngineHolder holder=engineHolder.get();
  if (holder == null) {
    holder=new ScriptEngineHolder();
    engineHolder.set(holder);
  }
  holder=engineHolder.get();
  if (holder.engine == null) {
    holder.engine=createScriptEngine();
    engineHolders.put(Thread.currentThread(),holder);
  }
  if (compiledScript == null) {
    if (holder.engine instanceof Compilable && !isBeanShell()) {
      compileScript((Compilable)holder.engine,exchange);
    }
  }
}
