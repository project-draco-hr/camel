{
  Map<String,Object> createHeaders=new HashMap<String,Object>();
  createHeaders.put(JcloudsConstants.OPERATION,JcloudsConstants.CREATE_NODE);
  createHeaders.put(JcloudsConstants.IMAGE_ID,"1");
  createHeaders.put(JcloudsConstants.GROUP,"default");
  Map<String,Object> runScriptHeaders=new HashMap<String,Object>();
  runScriptHeaders.put(JcloudsConstants.OPERATION,JcloudsConstants.RUN_SCRIPT);
  Map<String,Object> destroyHeaders=new HashMap<String,Object>();
  destroyHeaders.put(JcloudsConstants.OPERATION,JcloudsConstants.DESTROY_NODE);
  Set<? extends NodeMetadata> nodeMetadatas=(Set<? extends NodeMetadata>)template.requestBodyAndHeaders("direct:in-out","Some message",createHeaders);
  assertEquals("There should be a node running",1,nodeMetadatas.size());
  for (  NodeMetadata nodeMetadata : nodeMetadatas) {
    runScriptHeaders.put(JcloudsConstants.NODE_ID,nodeMetadata.getId());
    destroyHeaders.put(JcloudsConstants.NODE_ID,nodeMetadata.getId());
    template.requestBodyAndHeaders("direct:in-out","Some message",runScriptHeaders);
    template.sendBodyAndHeaders("direct:in-out","Some message",destroyHeaders);
  }
}
