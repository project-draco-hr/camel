{
  if (strategyRef != null) {
    aggregationStrategy=routeContext.mandatoryLookup(strategyRef,AggregationStrategy.class);
  }
  if (aggregationStrategy == null) {
    aggregationStrategy=new UseLatestAggregationStrategy();
  }
  boolean shutdownThreadPool=ProcessorDefinitionHelper.willCreateNewThreadPool(routeContext,this,isParallelProcessing());
  ExecutorService threadPool=ProcessorDefinitionHelper.getConfiguredExecutorService(routeContext,"Multicast",this,isParallelProcessing());
  long timeout=getTimeout() != null ? getTimeout() : 0;
  if (timeout > 0 && !isParallelProcessing()) {
    throw new IllegalArgumentException("Timeout is used but ParallelProcessing has not been enabled.");
  }
  if (onPrepareRef != null) {
    onPrepare=CamelContextHelper.mandatoryLookup(routeContext.getCamelContext(),onPrepareRef,Processor.class);
  }
  MulticastProcessor answer=new MulticastProcessor(routeContext.getCamelContext(),list,aggregationStrategy,isParallelProcessing(),threadPool,shutdownThreadPool,isStreaming(),isStopOnException(),timeout,onPrepare,isShareUnitOfWork());
  if (isShareUnitOfWork()) {
    CamelInternalProcessor internalProcessor=new CamelInternalProcessor(answer);
    internalProcessor.addTask(new CamelInternalProcessor.SubUnitOfWorkProcessorTask());
    return internalProcessor;
  }
  return answer;
}
