{
  this.exchange=exchange;
  variableResolver.setExchange(exchange);
  try {
    Object document=getDocument(exchange);
    if (resultQName != null) {
      if (document instanceof InputSource) {
        InputSource inputSource=(InputSource)document;
        return getExpression().evaluate(inputSource,resultQName);
      }
 else       if (document instanceof DOMSource) {
        DOMSource source=(DOMSource)document;
        return getExpression().evaluate(source.getNode(),resultQName);
      }
 else {
        return getExpression().evaluate(document,resultQName);
      }
    }
 else {
      if (document instanceof InputSource) {
        InputSource inputSource=(InputSource)document;
        return getExpression().evaluate(inputSource);
      }
 else       if (document instanceof DOMSource) {
        DOMSource source=(DOMSource)document;
        return getExpression().evaluate(source.getNode());
      }
 else {
        return getExpression().evaluate(document);
      }
    }
  }
 catch (  XPathExpressionException e) {
    throw new InvalidXPathExpression(getText(),e);
  }
catch (  XPathFactoryConfigurationException e) {
    throw new InvalidXPathExpression(getText(),e);
  }
}
