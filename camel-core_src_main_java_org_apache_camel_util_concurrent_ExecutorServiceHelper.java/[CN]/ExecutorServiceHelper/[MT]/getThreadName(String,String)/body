{
  if (pattern == null) {
    pattern=DEFAULT_PATTERN;
  }
  if (name.indexOf("$") > -1) {
    name=name.replaceAll("\\$","CAMEL_REPLACE_ME");
  }
  String longName=name;
  String shortName=name.contains("?") ? ObjectHelper.before(name,"?") : name;
  String answer=pattern.replaceFirst("\\$\\{counter\\}","" + nextThreadCounter());
  answer=answer.replaceFirst("\\$\\{longName\\}",longName);
  answer=answer.replaceFirst("\\$\\{name\\}",shortName);
  if (answer.indexOf("$") > -1 || answer.indexOf("${") > -1 || answer.indexOf("}") > -1) {
    throw new IllegalArgumentException("Pattern is invalid: " + pattern);
  }
  if (answer.indexOf("CAMEL_REPLACE_ME") > -1) {
    answer=answer.replaceAll("CAMEL_REPLACE_ME","\\$");
  }
  return answer;
}
