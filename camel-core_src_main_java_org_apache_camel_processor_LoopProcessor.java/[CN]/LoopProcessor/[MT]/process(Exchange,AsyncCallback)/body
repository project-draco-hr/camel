{
  AtomicInteger index=new AtomicInteger();
  AtomicInteger count=new AtomicInteger();
  String text=expression.evaluate(exchange,String.class);
  try {
    int num=ExchangeHelper.convertToMandatoryType(exchange,Integer.class,text);
    count.set(num);
  }
 catch (  NoTypeConversionAvailableException e) {
    exchange.setException(e);
    callback.done(true);
    return true;
  }
  final Exchange original=exchange;
  Exchange target=exchange;
  exchange.setProperty(Exchange.LOOP_SIZE,count);
  while (index.get() < count.get()) {
    target=prepareExchange(exchange,index.get(),original);
    boolean sync=process(target,callback,index,count,original);
    if (!sync) {
      LOG.trace("Processing exchangeId: {} is continued being processed asynchronously",target.getExchangeId());
      return false;
    }
    LOG.trace("Processing exchangeId: {} is continued being processed synchronously",target.getExchangeId());
    if (!continueProcessing(target,"so breaking out of loop",LOG)) {
      break;
    }
    index.getAndIncrement();
  }
  ExchangeHelper.copyResults(exchange,target);
  LOG.trace("Processing complete for exchangeId: {} >>> {}",exchange.getExchangeId(),exchange);
  callback.done(true);
  return true;
}
