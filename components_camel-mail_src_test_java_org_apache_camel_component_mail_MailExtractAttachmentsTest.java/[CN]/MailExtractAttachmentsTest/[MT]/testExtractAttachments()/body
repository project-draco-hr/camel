{
  Mailbox.clearAll();
  Endpoint endpoint=context.getEndpoint("smtp://james@mymailserver.com?password=secret");
  Exchange exchange=endpoint.createExchange();
  Message in=exchange.getIn();
  in.setBody("Hello World");
  in.addAttachment("logo.jpeg",new DataHandler(new FileDataSource("src/test/data/logo.jpeg")));
  in.addAttachment("license.txt",new DataHandler(new FileDataSource("src/main/resources/META-INF/LICENSE.txt")));
  Producer producer=endpoint.createProducer();
  producer.start();
  producer.process(exchange);
  Thread.sleep(2000);
  MockEndpoint mock=getMockEndpoint("mock:split");
  mock.expectedMessageCount(2);
  mock.assertIsSatisfied();
  Message first=mock.getReceivedExchanges().get(0).getIn();
  Message second=mock.getReceivedExchanges().get(1).getIn();
  assertEquals(0,first.getAttachments().size());
  assertEquals(0,second.getAttachments().size());
  assertEquals("logo.jpeg",first.getHeader("CamelSplitAttachmentName"));
  assertEquals("license.txt",second.getHeader("CamelSplitAttachmentName"));
  byte[] expected1=IOUtils.toByteArray(new FileDataSource("src/test/data/logo.jpeg").getInputStream());
  byte[] expected2=IOUtils.toByteArray(new FileDataSource("src/main/resources/META-INF/LICENSE.txt").getInputStream());
  assertArrayEquals(expected1,(byte[])first.getBody());
  assertArrayEquals(expected2,(byte[])second.getBody());
}
