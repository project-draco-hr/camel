{
  URI dispatchUri=null;
  List<URI> consumerUris=getInnerContextConsumerList(endpoint.getConfig().getInnerContext());
  if (consumerUris.isEmpty()) {
    throw new CamelException("No routes found for dispatch in Routebox");
  }
 else   if (consumerUris.size() == 1) {
    dispatchUri=consumerUris.get(0);
  }
 else {
    if (!endpoint.getConfig().getDispatchMap().isEmpty()) {
      if (endpoint.getConfig().getDispatchMap().containsKey(exchange.getIn().getHeader("ROUTE_DISPATCH_KEY"))) {
        dispatchUri=new URI(endpoint.getConfig().getDispatchMap().get(exchange.getIn().getHeader("ROUTE_DISPATCH_KEY")));
      }
 else {
        throw new CamelException("No matching entry found in Dispatch Map for ROUTE_DISPATCH_KEY: " + exchange.getIn().getHeader("ROUTE_DISPATCH_KEY"));
      }
    }
 else {
      dispatchUri=endpoint.getConfig().getDispatchStrategy().selectDestinationUri(consumerUris,exchange);
      if (dispatchUri == null) {
        throw new CamelException("No matching inner routes found for Operation");
      }
    }
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Dispatch URI set to: " + dispatchUri.toASCIIString());
  }
  return dispatchUri;
}
