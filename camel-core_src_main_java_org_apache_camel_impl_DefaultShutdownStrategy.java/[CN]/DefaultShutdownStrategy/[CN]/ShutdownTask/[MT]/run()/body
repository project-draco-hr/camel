{
  LOG.debug("There are {} routes to {}",routes.size(),suspendOnly ? "suspend" : "shutdown");
  List<ShutdownDeferredConsumer> deferredConsumers=new ArrayList<ShutdownDeferredConsumer>();
  for (  RouteStartupOrder order : routes) {
    ShutdownRoute shutdownRoute=order.getRoute().getRouteContext().getShutdownRoute();
    ShutdownRunningTask shutdownRunningTask=order.getRoute().getRouteContext().getShutdownRunningTask();
    if (LOG.isTraceEnabled()) {
      LOG.trace("{}{} with options [{},{}]",new Object[]{suspendOnly ? "Suspending route: " : "Shutting down route: ",order.getRoute().getId(),shutdownRoute,shutdownRunningTask});
    }
    for (    Consumer consumer : order.getInputs()) {
      boolean suspend=false;
      boolean shutdown=shutdownRoute != ShutdownRoute.Defer;
      if (shutdown) {
        if (consumer instanceof ShutdownAware) {
          shutdown=!((ShutdownAware)consumer).deferShutdown(shutdownRunningTask);
        }
        if (shutdown && consumer instanceof SuspendableService) {
          suspend=true;
        }
      }
      if (suspend) {
        suspendNow(consumer);
        deferredConsumers.add(new ShutdownDeferredConsumer(order.getRoute(),consumer));
        LOG.debug("Route: {} suspended and shutdown deferred, was consuming from: {}",order.getRoute().getId(),order.getRoute().getEndpoint());
      }
 else       if (shutdown) {
        shutdownNow(consumer);
        LOG.info("Route: {} shutdown complete, was consuming from: {}",order.getRoute().getId(),order.getRoute().getEndpoint());
      }
 else {
        deferredConsumers.add(new ShutdownDeferredConsumer(order.getRoute(),consumer));
        LOG.debug("Route: " + order.getRoute().getId() + (suspendOnly ? " shutdown deferred." : " suspension deferred."));
      }
    }
  }
  boolean done=false;
  long loopDelaySeconds=1;
  long loopCount=0;
  while (!done) {
    int size=0;
    for (    RouteStartupOrder order : routes) {
      for (      Consumer consumer : order.getInputs()) {
        int inflight=context.getInflightRepository().size(consumer.getEndpoint());
        if (consumer instanceof ShutdownAware) {
          inflight+=((ShutdownAware)consumer).getPendingExchangesSize();
        }
        if (inflight > 0) {
          size+=inflight;
          LOG.trace("{} inflight and pending exchanges for consumer: {}",inflight,consumer);
        }
      }
    }
    if (size > 0) {
      try {
        LOG.info("Waiting as there are still " + size + " inflight and pending exchanges to complete, timeout in "+ (TimeUnit.SECONDS.convert(getTimeout(),getTimeUnit()) - (loopCount++ * loopDelaySeconds))+ " seconds.");
        Thread.sleep(loopDelaySeconds * 1000);
      }
 catch (      InterruptedException e) {
        if (abortAfterTimeout) {
          LOG.warn("Interrupted while waiting during graceful shutdown, will abort.");
          return;
        }
 else {
          LOG.warn("Interrupted while waiting during graceful shutdown, will force shutdown now.");
          break;
        }
      }
    }
 else {
      done=true;
    }
  }
  for (  ShutdownDeferredConsumer deferred : deferredConsumers) {
    Consumer consumer=deferred.getConsumer();
    if (consumer instanceof ShutdownAware) {
      LOG.trace("Route: {} preparing to shutdown.",deferred.getRoute().getId());
      ((ShutdownAware)consumer).prepareShutdown();
      LOG.debug("Route: {} preparing to shutdown complete.",deferred.getRoute().getId());
    }
  }
  for (  ShutdownDeferredConsumer deferred : deferredConsumers) {
    Consumer consumer=deferred.getConsumer();
    if (suspendOnly) {
      suspendNow(consumer);
      LOG.info("Route: {} suspend complete, was consuming from: {}",deferred.getRoute().getId(),deferred.getConsumer().getEndpoint());
    }
 else {
      shutdownNow(consumer);
      LOG.info("Route: {} shutdown complete, was consuming from: {}",deferred.getRoute().getId(),deferred.getConsumer().getEndpoint());
    }
  }
}
