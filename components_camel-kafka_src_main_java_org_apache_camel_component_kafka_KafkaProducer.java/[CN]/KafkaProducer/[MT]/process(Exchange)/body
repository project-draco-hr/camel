{
  String topic=endpoint.getTopic();
  if (!endpoint.isBridgeEndpoint()) {
    topic=exchange.getIn().getHeader(KafkaConstants.TOPIC,endpoint.getTopic(),String.class);
  }
  if (topic == null) {
    throw new CamelExchangeException("No topic key set",exchange);
  }
  K partitionKey=(K)exchange.getIn().getHeader(KafkaConstants.PARTITION_KEY);
  boolean hasPartitionKey=partitionKey != null;
  K messageKey=(K)exchange.getIn().getHeader(KafkaConstants.KEY);
  boolean hasMessageKey=messageKey != null;
  V msg=(V)exchange.getIn().getBody();
  KeyedMessage<K,V> data;
  if (hasPartitionKey && hasMessageKey) {
    data=new KeyedMessage<K,V>(topic,messageKey,partitionKey,msg);
  }
 else   if (hasPartitionKey) {
    data=new KeyedMessage<K,V>(topic,partitionKey,msg);
  }
 else   if (hasMessageKey) {
    data=new KeyedMessage<K,V>(topic,messageKey,msg);
  }
 else {
    log.warn("No message key or partition key set");
    data=new KeyedMessage<K,V>(topic,messageKey,partitionKey,msg);
  }
  producer.send(data);
}
