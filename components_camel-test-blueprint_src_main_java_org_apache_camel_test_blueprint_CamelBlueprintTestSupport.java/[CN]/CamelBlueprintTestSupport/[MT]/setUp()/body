{
  String symbolicName=getClass().getSimpleName();
  this.bundleContext=CamelBlueprintHelper.createBundleContext(symbolicName,getBlueprintDescriptor(),true,getBundleFilter(),getBundleVersion(),getBundleDirectives());
  Properties extra=useOverridePropertiesWithPropertiesComponent();
  if (extra != null) {
    bundleContext.registerService(PropertiesComponent.OVERRIDE_PROPERTIES,extra,null);
  }
  String[] file=loadConfigAdminConfigurationFile();
  if (file != null && file.length != 2) {
    throw new IllegalArgumentException("The returned String[] from loadConfigAdminConfigurationFile must be of length 2, was " + file.length);
  }
  if (file != null && file[0] != null) {
    Dictionary props=new Properties();
    File load=new File(file[0]);
    log.debug("Loading properties from OSGi config admin file: {}",load);
    org.apache.felix.utils.properties.Properties cfg=new org.apache.felix.utils.properties.Properties(load);
    for (    Map.Entry entry : cfg.entrySet()) {
      props.put(entry.getKey(),entry.getValue());
    }
    ConfigurationAdmin configAdmin=getOsgiService(ConfigurationAdmin.class);
    if (configAdmin != null) {
      Configuration config=configAdmin.getConfiguration(file[1]);
      log.info("Updating ConfigAdmin {} by overriding properties {}",config,props);
      config.update(props);
    }
  }
  Dictionary props=new Properties();
  String pid=useOverridePropertiesWithConfigAdmin(props);
  if (pid != null) {
    ConfigurationAdmin configAdmin=getOsgiService(ConfigurationAdmin.class);
    Configuration config=configAdmin.getConfiguration(pid);
    if (config == null) {
      throw new IllegalArgumentException("Cannot find configuration with pid " + pid + " in OSGi ConfigurationAdmin service.");
    }
    log.info("Updating ConfigAdmin {} by overriding properties {}",config,props);
    config.update(props);
  }
  super.setUp();
  log.debug("Waiting for BlueprintContainer to be published with symbolicName: {}",symbolicName);
  getOsgiService(BlueprintContainer.class,"(osgi.blueprint.container.symbolicname=" + symbolicName + ")");
}
