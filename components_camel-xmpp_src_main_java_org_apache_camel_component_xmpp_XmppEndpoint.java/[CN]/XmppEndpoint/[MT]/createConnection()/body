{
  if (connection != null && connection.isConnected()) {
    return connection;
  }
  if (connection == null) {
    connection=createConnectionInternal();
  }
  connection.connect();
  connection.addPacketListener(new XmppLogger("INBOUND"),new PacketFilter(){
    public boolean accept(    Packet packet){
      return true;
    }
  }
);
  connection.addPacketSendingListener(new XmppLogger("OUTBOUND"),new PacketFilter(){
    public boolean accept(    Packet packet){
      return true;
    }
  }
);
  if (!connection.isAuthenticated()) {
    if (user != null) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("Logging in to XMPP as user: {} on connection: {}",user,getConnectionMessage(connection));
      }
      if (password == null) {
        LOG.warn("No password configured for user: {} on connection: {}",user,getConnectionMessage(connection));
      }
      if (createAccount) {
        AccountManager accountManager=AccountManager.getInstance(connection);
        accountManager.createAccount(user,password);
      }
      if (login) {
        if (resource != null) {
          connection.login(user,password,resource);
        }
 else {
          connection.login(user,password);
        }
      }
    }
 else {
      if (LOG.isDebugEnabled()) {
        LOG.debug("Logging in anonymously to XMPP on connection: {}",getConnectionMessage(connection));
      }
      connection.loginAnonymously();
    }
  }
  return connection;
}
