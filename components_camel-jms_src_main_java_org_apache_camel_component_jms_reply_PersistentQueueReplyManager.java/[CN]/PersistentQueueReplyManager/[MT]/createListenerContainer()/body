{
  DefaultMessageListenerContainer answer;
  String replyToSelectorName=endpoint.getReplyToDestinationSelectorName();
  if (replyToSelectorName != null) {
    replyToSelectorValue="ID:" + new BigInteger(24 * 8,new Random()).toString(16);
    String fixedMessageSelector=replyToSelectorName + "='" + replyToSelectorValue+ "'";
    answer=new PersistentQueueMessageListenerContainer(fixedMessageSelector);
  }
 else {
    dynamicMessageSelector=new MessageSelectorCreator();
    answer=new PersistentQueueMessageListenerContainer(dynamicMessageSelector);
  }
  answer.setConnectionFactory(endpoint.getListenerConnectionFactory());
  DestinationResolver resolver=endpoint.getDestinationResolver();
  if (resolver == null) {
    resolver=answer.getDestinationResolver();
  }
  answer.setDestinationResolver(new DestinationResolverDelegate(resolver));
  answer.setDestinationName(endpoint.getReplyTo());
  answer.setAutoStartup(true);
  answer.setMessageListener(this);
  answer.setPubSubDomain(false);
  answer.setSubscriptionDurable(false);
  answer.setConcurrentConsumers(endpoint.getConcurrentConsumers());
  ExceptionListener exceptionListener=endpoint.getExceptionListener();
  if (exceptionListener != null) {
    answer.setExceptionListener(exceptionListener);
  }
  answer.setSessionTransacted(endpoint.isTransacted());
  if (endpoint.isTransacted()) {
    answer.setSessionAcknowledgeMode(Session.SESSION_TRANSACTED);
  }
 else {
    if (endpoint.getAcknowledgementMode() >= 0) {
      answer.setSessionAcknowledgeMode(endpoint.getAcknowledgementMode());
    }
 else     if (endpoint.getAcknowledgementModeName() != null) {
      answer.setSessionAcknowledgeModeName(endpoint.getAcknowledgementModeName());
    }
  }
  answer.setConcurrentConsumers(1);
  answer.setCacheLevel(DefaultMessageListenerContainer.CACHE_SESSION);
  if (endpoint.getReceiveTimeout() >= 0) {
    answer.setReceiveTimeout(endpoint.getReceiveTimeout());
  }
  if (endpoint.getRecoveryInterval() >= 0) {
    answer.setRecoveryInterval(endpoint.getRecoveryInterval());
  }
  TaskExecutor taskExecutor=endpoint.getTaskExecutor();
  if (taskExecutor != null) {
    answer.setTaskExecutor(taskExecutor);
  }
  PlatformTransactionManager tm=endpoint.getTransactionManager();
  if (tm != null) {
    answer.setTransactionManager(tm);
  }
 else   if (endpoint.isTransacted()) {
    throw new IllegalArgumentException("Property transacted is enabled but a transactionManager was not injected!");
  }
  if (endpoint.getTransactionName() != null) {
    answer.setTransactionName(endpoint.getTransactionName());
  }
  if (endpoint.getTransactionTimeout() >= 0) {
    answer.setTransactionTimeout(endpoint.getTransactionTimeout());
  }
  return answer;
}
