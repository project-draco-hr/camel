{
  Throwable e=exchange.getException();
  exchange.setProperty(Exchange.EXCEPTION_CAUGHT,e);
  ExceptionType exceptionPolicy=getExceptionPolicy(exchange,e);
  if (exceptionPolicy != null) {
    data.currentRedeliveryPolicy=exceptionPolicy.createRedeliveryPolicy(exchange.getContext(),data.currentRedeliveryPolicy);
    data.handledPredicate=exceptionPolicy.getHandledPolicy();
    data.retryUntilPredicate=exceptionPolicy.getRetryUntilPolicy();
    Processor processor=exceptionPolicy.getErrorHandler();
    if (processor != null) {
      data.failureProcessor=processor;
    }
    processor=exceptionPolicy.getOnRedelivery();
    if (processor != null) {
      data.onRedeliveryProcessor=processor;
    }
  }
  String msg="Failed delivery for exchangeId: " + exchange.getExchangeId() + ". On delivery attempt: "+ data.redeliveryCounter+ " caught: "+ e;
  logFailedDelivery(true,exchange,msg,data,e);
  data.redeliveryCounter=incrementRedeliveryCounter(exchange,e);
}
