{
  File camelMetaDir=new File(outDir,"META-INF/services/org/apache/camel/");
  Map<String,String> javaTypes=new HashMap<String,String>();
  StringBuilder buffer=new StringBuilder();
  int count=0;
  for (  Resource r : project.getBuild().getResources()) {
    File f=new File(r.getDirectory());
    if (!f.exists()) {
      f=new File(project.getBasedir(),r.getDirectory());
    }
    f=new File(f,"META-INF/services/org/apache/camel/dataformat");
    if (f.exists() && f.isDirectory()) {
      File[] files=f.listFiles();
      if (files != null) {
        for (        File file : files) {
          String name=file.getName();
          if (name.charAt(0) != '.') {
            count++;
            if (buffer.length() > 0) {
              buffer.append(" ");
            }
            buffer.append(name);
          }
          try {
            String text=loadText(new FileInputStream(file));
            Map<String,String> map=parseAsMap(text);
            String javaType=map.get("class");
            if (javaType != null) {
              javaTypes.put(name,javaType);
            }
          }
 catch (          IOException e) {
            throw new MojoExecutionException("Failed to read file " + file + ". Reason: "+ e,e);
          }
        }
      }
    }
  }
  getLog().debug("Java types found " + javaTypes);
  if (count > 0) {
    Properties properties=new Properties();
    String names=buffer.toString();
    properties.put("dataFormats",names);
    properties.put("groupId",project.getGroupId());
    properties.put("artifactId",project.getArtifactId());
    properties.put("version",project.getVersion());
    properties.put("projectName",project.getName());
    properties.put("projectDescription",project.getDescription());
    camelMetaDir.mkdirs();
    File outFile=new File(camelMetaDir,"dataformat.properties");
    try {
      properties.store(new FileWriter(outFile),"Generated by camel-package-maven-plugin");
      getLog().info("Generated " + outFile + " containing "+ count+ " Camel "+ (count > 1 ? "dataformats: " : "dataformat: ")+ names);
      if (projectHelper != null) {
        List<String> includes=new ArrayList<String>();
        includes.add("**/dataformat.properties");
        projectHelper.addResource(this.project,outDir.getPath(),includes,new ArrayList<String>());
        projectHelper.attachArtifact(this.project,"properties","camelDataFormat",outFile);
      }
    }
 catch (    IOException e) {
      throw new MojoExecutionException("Failed to write properties to " + outFile + ". Reason: "+ e,e);
    }
  }
 else {
    getLog().debug("No META-INF/services/org/apache/camel/dataformat directory found. Are you sure you have created a Camel data format?");
  }
}
