{
  LOG.trace("Adding attachments +++ start +++");
  int i=0;
  for (  Map.Entry<String,Attachment> entry : exchange.getIn().getAttachmentObjects().entrySet()) {
    String attachmentFilename=entry.getKey();
    Attachment attachment=entry.getValue();
    if (LOG.isTraceEnabled()) {
      LOG.trace("Attachment #{}: Disposition: {}",i,partDisposition);
      LOG.trace("Attachment #{}: DataHandler: {}",i,attachment.getDataHandler());
      LOG.trace("Attachment #{}: FileName: {}",i,attachmentFilename);
    }
    if (attachment != null) {
      if (shouldAddAttachment(exchange,attachmentFilename,attachment.getDataHandler())) {
        BodyPart messageBodyPart=new MimeBodyPart();
        messageBodyPart.setDataHandler(attachment.getDataHandler());
        for (        String headerName : attachment.getHeaderNames()) {
          List<String> values=attachment.getHeaderAsList(headerName);
          for (          String value : values) {
            messageBodyPart.setHeader(headerName,value);
          }
        }
        if (attachmentFilename.toLowerCase().startsWith("cid:")) {
          messageBodyPart.addHeader("Content-ID","<" + attachmentFilename.substring(4) + ">");
          messageBodyPart.setFileName(attachmentFilename.substring(4));
        }
 else {
          messageBodyPart.setFileName(attachmentFilename);
        }
        LOG.trace("Attachment #" + i + ": ContentType: "+ messageBodyPart.getContentType());
        if (contentTypeResolver != null) {
          String contentType=contentTypeResolver.resolveContentType(attachmentFilename);
          LOG.trace("Attachment #" + i + ": Using content type resolver: "+ contentTypeResolver+ " resolved content type as: "+ contentType);
          if (contentType != null) {
            String value=contentType + "; name=" + attachmentFilename;
            messageBodyPart.setHeader("Content-Type",value);
            LOG.trace("Attachment #" + i + ": ContentType: "+ messageBodyPart.getContentType());
          }
        }
        resolveContentTransferEncoding(encodingResolver,i,messageBodyPart);
        messageBodyPart.setDisposition(partDisposition);
        multipart.addBodyPart(messageBodyPart);
      }
 else {
        LOG.trace("shouldAddAttachment: false");
      }
    }
 else {
      LOG.warn("Cannot add attachment: " + attachmentFilename + " as DataHandler is null");
    }
    i++;
  }
  LOG.trace("Adding attachments +++ done +++");
}
