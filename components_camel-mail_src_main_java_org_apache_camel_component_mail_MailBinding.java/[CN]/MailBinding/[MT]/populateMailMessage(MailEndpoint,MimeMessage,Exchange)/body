{
  if (hasRecipientHeaders(exchange.getIn())) {
    setRecipientFromCamelMessage(mimeMessage,exchange,exchange.getIn());
  }
 else {
    setRecipientFromEndpointConfiguration(mimeMessage,endpoint);
  }
  if (mimeMessage.getAllRecipients() == null) {
    throw new IllegalArgumentException("The mail message does not have any recipients set.");
  }
  appendHeadersFromCamelMessage(mimeMessage,exchange,exchange.getIn());
  if (empty(mimeMessage.getFrom())) {
    String from=endpoint.getConfiguration().getFrom();
    mimeMessage.setFrom(new InternetAddress(from));
  }
  if (hasAlternativeBody(endpoint.getConfiguration(),exchange.getIn())) {
    createMultipartAlternativeMessage(mimeMessage,exchange.getIn(),endpoint.getConfiguration());
  }
 else {
    if (exchange.getIn().hasAttachments()) {
      appendAttachmentsFromCamel(mimeMessage,exchange.getIn(),endpoint.getConfiguration());
    }
 else {
      String contentType=populateContentType(endpoint,mimeMessage,exchange);
      if (contentType == null) {
        mimeMessage.setText(exchange.getIn().getBody(String.class));
      }
 else       if (contentType.startsWith("text/plain")) {
        String charset=ObjectHelper.after(contentType,"charset=");
        if (charset != null) {
          mimeMessage.setText(exchange.getIn().getBody(String.class),charset);
        }
 else {
          mimeMessage.setText(exchange.getIn().getBody(String.class));
        }
      }
 else {
        DataSource ds=new ByteArrayDataSource(exchange.getIn().getBody(String.class),contentType);
        mimeMessage.setDataHandler(new DataHandler(ds));
      }
    }
  }
}
