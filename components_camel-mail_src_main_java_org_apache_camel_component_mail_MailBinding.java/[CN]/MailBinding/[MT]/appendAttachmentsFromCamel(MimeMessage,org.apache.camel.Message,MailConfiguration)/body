{
  MimeMultipart multipart=new MimeMultipart();
  multipart.setSubType("mixed");
  MimeBodyPart textBodyPart=new MimeBodyPart();
  textBodyPart.setContent(camelMessage.getBody(String.class),configuration.getContentType());
  multipart.addBodyPart(textBodyPart);
  for (  Map.Entry<String,DataHandler> entry : camelMessage.getAttachments().entrySet()) {
    String attachmentFilename=entry.getKey();
    DataHandler handler=entry.getValue();
    if (handler != null) {
      if (shouldOutputAttachment(camelMessage,attachmentFilename,handler)) {
        BodyPart messageBodyPart=new MimeBodyPart();
        messageBodyPart.setDataHandler(handler);
        messageBodyPart.setFileName(attachmentFilename);
        messageBodyPart.setDisposition(Part.ATTACHMENT);
        multipart.addBodyPart(messageBodyPart);
      }
    }
  }
  mimeMessage.setContent(multipart);
}
