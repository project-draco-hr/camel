{
  HttpContext context=conn.getContext();
  HttpResponse response=conn.getHttpResponse();
  ServerConnState connState=(ServerConnState)context.getAttribute(CONN_STATE);
  ContentOutputBuffer buffer=connState.getOutbuffer();
  connState.setOutputState(ServerConnState.RESPONSE_BODY_STREAM);
  try {
    buffer.produceContent(encoder);
    if (encoder.isCompleted()) {
      connState.setOutputState(ServerConnState.RESPONSE_BODY_DONE);
      connState.resetOutput();
      if (!this.connStrategy.keepAlive(response,context)) {
        conn.close();
      }
 else {
        conn.requestInput();
      }
    }
  }
 catch (  IOException ex) {
    shutdownConnection(conn,ex);
    if (this.eventListener != null) {
      this.eventListener.fatalIOException(ex,conn);
    }
  }
}
