{
  Expression exp=exchange.getIn().getHeader(Exchange.LANGUAGE_SCRIPT,Expression.class);
  if (exp == null) {
    String script=exchange.getIn().getHeader(Exchange.LANGUAGE_SCRIPT,String.class);
    if (script != null) {
      exp=getEndpoint().getLanguage().createExpression(script);
    }
  }
  if (exp == null) {
    exp=getEndpoint().getExpression();
  }
  ObjectHelper.notNull(exp,"expression");
  Object result=exp.evaluate(exchange,Object.class);
  log.debug("Evaluated expression as: {} with: {}",result,exchange);
  if (getEndpoint().isTransform()) {
    if (exchange.hasOut()) {
      exchange.getOut().setBody(result);
    }
 else {
      exchange.getIn().setBody(result);
    }
  }
}
