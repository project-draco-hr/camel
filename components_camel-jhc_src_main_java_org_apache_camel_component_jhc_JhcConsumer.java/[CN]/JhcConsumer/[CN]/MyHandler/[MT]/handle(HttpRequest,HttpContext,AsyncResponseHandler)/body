{
  final Exchange exchange=getEndpoint().createExchange();
  exchange.getIn().setHeader(Exchange.HTTP_URI,request.getRequestLine().getUri());
  if (request instanceof HttpEntityEnclosingRequest) {
    exchange.getIn().setHeader(Exchange.CONTENT_TYPE,((HttpEntityEnclosingRequest)request).getEntity().getContentType());
    exchange.getIn().setBody(((HttpEntityEnclosingRequest)request).getEntity());
  }
  try {
    getProcessor().process(exchange);
  }
 catch (  Exception e) {
    throw new HttpException("Get the exception when processing the exchange",e);
  }
  LOG.debug("handleExchange");
  ProtocolVersion httpVersion=(HttpVersion)request.getRequestLine().getProtocolVersion();
  Integer responseCode=exchange.getOut().getHeader(Exchange.HTTP_RESPONSE_CODE,Integer.class);
  if (responseCode == null) {
    responseCode=HttpStatus.SC_OK;
  }
  HttpResponse response=responseFactory.newHttpResponse(httpVersion,responseCode,context);
  response.setParams(params);
  HttpEntity entity=exchange.getOut().getBody(HttpEntity.class);
  String contentType=MessageHelper.getContentType(exchange.getOut());
  if (contentType != null && entity instanceof AbstractHttpEntity) {
    ((AbstractHttpEntity)entity).setContentType(contentType);
  }
  response.setEntity(entity);
  response.setParams(getEndpoint().getParams());
  try {
    handler.sendResponse(response);
  }
 catch (  Exception e) {
    LOG.info("Get exception when send the reponse" + e);
  }
}
