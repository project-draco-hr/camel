{
  String uri=NettyHttpHelper.createURL(exchange,getEndpoint());
  URI u=NettyHttpHelper.createURI(exchange,uri,getEndpoint());
  final HttpRequest request=getEndpoint().getNettyHttpBinding().toNettyRequest(exchange.getIn(),u.toString(),getConfiguration());
  String actualUri=request.uri();
  exchange.getIn().setHeader(Exchange.HTTP_URL,actualUri);
  if (!HttpUtil.isKeepAlive(request)) {
    exchange.setProperty(NettyConstants.NETTY_CLOSE_CHANNEL_WHEN_COMPLETE,true);
  }
  if (getConfiguration().isBridgeEndpoint()) {
    exchange.getIn().removeHeader("host");
  }
  exchange.addOnCompletion(new SynchronizationAdapter(){
    @Override public void onDone(    Exchange exchange){
      if (request instanceof ReferenceCounted) {
        if (((ReferenceCounted)request).refCnt() > 0) {
          log.debug("Releasing Netty HttpRequest ByteBuf");
          ReferenceCountUtil.release(request);
        }
      }
    }
  }
);
  return request;
}
