{
  try {
    NettyHttpMessage nettyMessage=exchange.hasOut() ? exchange.getOut(NettyHttpMessage.class) : exchange.getIn(NettyHttpMessage.class);
    if (nettyMessage != null) {
      FullHttpResponse response=nettyMessage.getHttpResponse();
      if (response != null) {
        response.content().retain();
        String actualUrl=exchange.getIn().getHeader(Exchange.HTTP_URL,String.class);
        int code=response.getStatus() != null ? response.getStatus().code() : -1;
        log.debug("Http responseCode: {}",code);
        if (code >= 300 && getConfiguration().isThrowExceptionOnFailure()) {
          Exception cause=NettyHttpHelper.populateNettyHttpOperationFailedException(exchange,actualUrl,response,code,getConfiguration().isTransferException());
          exchange.setException(cause);
        }
      }
    }
  }
  finally {
    callback.done(doneSync);
  }
}
