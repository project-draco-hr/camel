{
  counter=0;
  MBeanServer mbeanServer=context.getManagementStrategy().getManagementAgent().getMBeanServer();
  Set<ObjectName> set=mbeanServer.queryNames(new ObjectName("*:type=errorhandlers,*"),null);
  assertEquals(1,set.size());
  ObjectName on=set.iterator().next();
  mbeanServer.setAttribute(on,new Attribute("MaximumRedeliveries",3));
  Integer max=(Integer)mbeanServer.getAttribute(on,"MaximumRedeliveries");
  assertEquals(3,max.intValue());
  mbeanServer.setAttribute(on,new Attribute("MaximumRedeliveryDelay",Long.valueOf("20000")));
  Long delay=(Long)mbeanServer.getAttribute(on,"MaximumRedeliveryDelay");
  assertEquals(20000,delay.longValue());
  mbeanServer.setAttribute(on,new Attribute("RedeliveryDelay",Long.valueOf("250")));
  delay=(Long)mbeanServer.getAttribute(on,"RedeliveryDelay");
  assertEquals(250,delay.longValue());
  String camelId=(String)mbeanServer.getAttribute(on,"CamelId");
  assertEquals("camel-1",camelId);
  Double backoff=(Double)mbeanServer.getAttribute(on,"BackOffMultiplier");
  assertNotNull(backoff);
  Double cf=(Double)mbeanServer.getAttribute(on,"CollisionAvoidanceFactor");
  assertNotNull(cf);
  Double cp=(Double)mbeanServer.getAttribute(on,"CollisionAvoidancePercent");
  assertNotNull(cp);
  String dp=(String)mbeanServer.getAttribute(on,"DelayPattern");
  assertNull(dp);
  String ell=(String)mbeanServer.getAttribute(on,"RetriesExhaustedLogLevel");
  assertEquals(LoggingLevel.DEBUG.name(),ell);
  String rll=(String)mbeanServer.getAttribute(on,"RetryAttemptedLogLevel");
  assertEquals(LoggingLevel.DEBUG.name(),rll);
  Boolean lst=(Boolean)mbeanServer.getAttribute(on,"LogStackTrace");
  assertEquals(false,lst.booleanValue());
  Boolean uca=(Boolean)mbeanServer.getAttribute(on,"UseCollisionAvoidance");
  assertEquals(false,uca.booleanValue());
  Boolean uebf=(Boolean)mbeanServer.getAttribute(on,"UseExponentialBackOff");
  assertEquals(false,uebf.booleanValue());
  MockEndpoint mock=getMockEndpoint("mock:result");
  mock.expectedMessageCount(1);
  template.sendBody("direct:start","Hello World");
  assertEquals(3,counter);
  assertMockEndpointsSatisfied();
  counter=0;
  mock.reset();
  mock.expectedMessageCount(0);
  mbeanServer.setAttribute(on,new Attribute("MaximumRedeliveries",0));
  try {
    template.sendBody("direct:start","Bye World");
    fail("Should have thrown exception");
  }
 catch (  CamelExecutionException e) {
    IllegalArgumentException cause=assertIsInstanceOf(IllegalArgumentException.class,e.getCause());
    assertEquals("Forced",cause.getMessage());
  }
  assertEquals(1,counter);
  max=(Integer)mbeanServer.getAttribute(on,"MaximumRedeliveries");
  assertEquals(0,max.intValue());
}
