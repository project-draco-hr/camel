{
  RemoteFileConfiguration config=getConfiguration().copy();
  if (uri.indexOf("?") != -1) {
    uri=uri.substring(0,uri.indexOf("?"));
  }
  config.configure(new URI(uri));
  final RemoteFileEndpoint endpoint;
  if ("ftp".equals(config.getProtocol())) {
    endpoint=new FtpEndpoint(uri,this,config);
  }
 else   if ("sftp".equals(config.getProtocol())) {
    endpoint=new SftpEndpoint(uri,this,config);
  }
 else {
    throw new RuntimeCamelException("Unsupported protocol: " + config.getProtocol());
  }
  configureFTPClientConfig(parameters,endpoint);
  setProperties(endpoint.getConfiguration(),parameters);
  return endpoint;
}
