{
  ObjectMetadata objectMetadata=new ObjectMetadata();
  Long contentLength=exchange.getIn().getHeader(S3Constants.CONTENT_LENGTH,Long.class);
  if (contentLength != null) {
    objectMetadata.setContentLength(contentLength);
  }
  String contentType=exchange.getIn().getHeader(S3Constants.CONTENT_TYPE,String.class);
  if (contentType != null) {
    objectMetadata.setContentType(contentType);
  }
  String cacheControl=exchange.getIn().getHeader(S3Constants.CACHE_CONTROL,String.class);
  if (cacheControl != null) {
    objectMetadata.setCacheControl(cacheControl);
  }
  String contentDisposition=exchange.getIn().getHeader(S3Constants.CONTENT_DISPOSITION,String.class);
  if (contentDisposition != null) {
    objectMetadata.setContentDisposition(contentDisposition);
  }
  String contentEncoding=exchange.getIn().getHeader(S3Constants.CONTENT_ENCODING,String.class);
  if (contentEncoding != null) {
    objectMetadata.setContentEncoding(contentEncoding);
  }
  String contentMD5=exchange.getIn().getHeader(S3Constants.CONTENT_MD5,String.class);
  if (contentMD5 != null) {
    objectMetadata.setContentMD5(contentMD5);
  }
  Date lastModified=exchange.getIn().getHeader(S3Constants.LAST_MODIFIED,Date.class);
  if (lastModified != null) {
    objectMetadata.setLastModified(lastModified);
  }
  PutObjectRequest putObjectRequest=new PutObjectRequest(getConfiguration().getBucketName(),determineKey(exchange),exchange.getIn().getMandatoryBody(InputStream.class),objectMetadata);
  String storageClass=determineStorageClass(exchange);
  if (storageClass != null) {
    putObjectRequest.setStorageClass(storageClass);
  }
  LOG.trace("Put object [{}] from exchange [{}]...",putObjectRequest,exchange);
  PutObjectResult putObjectResult=getEndpoint().getS3Client().putObject(putObjectRequest);
  LOG.trace("Received result [{}]",putObjectResult);
  Message message=getMessageForResponse(exchange);
  message.setHeader(S3Constants.E_TAG,putObjectResult.getETag());
  if (putObjectResult.getVersionId() != null) {
    message.setHeader(S3Constants.VERSION_ID,putObjectResult.getVersionId());
  }
}
