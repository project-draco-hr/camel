{
  int messagesPolled=0;
  while (isPollAllowed()) {
    Exchange exchange;
    if (timeout == 0) {
      exchange=pollingConsumer.receiveNoWait();
    }
 else     if (timeout < 0) {
      exchange=pollingConsumer.receive();
    }
 else {
      exchange=pollingConsumer.receive(timeout);
    }
    if (exchange == null) {
      break;
    }
    messagesPolled++;
    log.trace("Polled {} {}",messagesPolled,exchange);
    if (exchange.hasOut()) {
      Exchange newExchange=getEndpoint().createExchange();
      newExchange.getIn().copyFrom(exchange.getOut());
      exchange=newExchange;
    }
    getProcessor().process(exchange);
  }
  return messagesPolled;
}
