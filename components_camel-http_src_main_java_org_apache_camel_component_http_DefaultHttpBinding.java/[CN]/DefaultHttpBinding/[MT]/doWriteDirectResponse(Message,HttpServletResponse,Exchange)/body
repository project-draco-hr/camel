{
  String contentType=message.getHeader(Exchange.CONTENT_TYPE,String.class);
  if (contentType != null && HttpConstants.CONTENT_TYPE_JAVA_SERIALIZED_OBJECT.equals(contentType)) {
    try {
      Object object=message.getMandatoryBody(Serializable.class);
      HttpHelper.writeObjectToServletResponse(response,object);
      return;
    }
 catch (    InvalidPayloadException e) {
      throw new IOException(e);
    }
  }
  InputStream is=null;
  if (checkChunked(message,exchange)) {
    is=message.getBody(InputStream.class);
  }
  if (is != null) {
    ServletOutputStream os=response.getOutputStream();
    try {
      IOHelper.copy(is,os);
    }
  finally {
      IOHelper.close(os,is);
    }
  }
 else {
    String data=message.getBody(String.class);
    if (data != null) {
      String charset=IOHelper.getCharsetName(exchange,true);
      final int dataByteLength=data.getBytes(charset).length;
      response.setCharacterEncoding(charset);
      response.setContentLength(dataByteLength);
      response.getWriter().print(data);
      response.getWriter().flush();
    }
  }
}
