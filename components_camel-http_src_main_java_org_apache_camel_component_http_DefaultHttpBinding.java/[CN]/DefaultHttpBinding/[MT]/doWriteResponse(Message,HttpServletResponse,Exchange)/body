{
  if (message.getHeader(HttpConstants.HTTP_RESPONSE_CODE) != null) {
    int code=message.getHeader(HttpConstants.HTTP_RESPONSE_CODE,Integer.class);
    response.setStatus(code);
  }
  if (message.getHeader("Content-Type") != null) {
    String contentType=message.getHeader("Content-Type",String.class);
    response.setContentType(contentType);
  }
  for (  String key : message.getHeaders().keySet()) {
    String value=message.getHeader(key,String.class);
    if (headerFilterStrategy != null && !headerFilterStrategy.applyFilterToCamelHeaders(key,value,exchange)) {
      response.setHeader(key,value);
    }
  }
  if (message.getBody() != null) {
    InputStream is=message.getBody(InputStream.class);
    if (is != null) {
      ServletOutputStream os=response.getOutputStream();
      try {
        ByteArrayOutputStream initialArray=new ByteArrayOutputStream();
        int c;
        while ((c=is.read()) >= 0) {
          initialArray.write(c);
        }
        byte[] processedArray=processReponseContent(message,initialArray.toByteArray(),response);
        os.write(processedArray);
        response.setContentLength(processedArray.length);
        os.flush();
      }
  finally {
        os.close();
        is.close();
      }
    }
 else {
      String data=message.getBody(String.class);
      if (data != null) {
        response.setContentLength(data.length());
        response.getWriter().print(data);
        response.getWriter().flush();
      }
    }
  }
}
