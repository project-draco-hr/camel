{
  if (exchange.isFailed()) {
    Message fault=exchange.getFault(false);
    if (fault != null) {
      doWriteFaultResponse(fault,response,exchange);
    }
 else {
      doWriteExceptionResponse(exchange.getException(),response);
    }
  }
 else {
    copyProtocolHeaders(exchange.getIn(),exchange.getOut());
    Message out=exchange.getOut();
    if (out != null) {
      doWriteResponse(out,response,exchange);
    }
  }
}
