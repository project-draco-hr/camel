{
  if (exchange.isFailed()) {
    if (exchange.hasFault()) {
      doWriteFaultResponse(exchange.getFault(),response,exchange);
    }
 else {
      doWriteExceptionResponse(exchange.getException(),response);
    }
  }
 else {
    copyProtocolHeaders(exchange.getIn(),exchange.getOut());
    Message out=exchange.getOut();
    if (out != null) {
      doWriteResponse(out,response,exchange);
    }
  }
}
