{
  if (message.getHeader(HttpProducer.HTTP_RESPONSE_CODE) != null) {
    int code=message.getHeader(HttpProducer.HTTP_RESPONSE_CODE,Integer.class);
    response.setStatus(code);
  }
  if (message.getHeader("Content-Type") != null) {
    String contentType=message.getHeader("Content-Type",String.class);
    response.setContentType(contentType);
  }
  for (  String key : message.getHeaders().keySet()) {
    String value=message.getHeader(key,String.class);
    if (headerFilterStrategy != null && !headerFilterStrategy.applyFilterToCamelHeaders(key,value)) {
      response.setHeader(key,value);
    }
  }
  if (message.getBody() != null) {
    InputStream is=message.getBody(InputStream.class);
    int length=0;
    if (is != null) {
      ServletOutputStream os=null;
      try {
        os=response.getOutputStream();
        int c;
        while ((c=is.read()) >= 0) {
          os.write(c);
          length++;
        }
        response.setContentLength(length);
        os.flush();
      }
  finally {
        os.close();
        is.close();
      }
    }
 else {
      String data=message.getBody(String.class);
      if (data != null) {
        response.setContentLength(data.length());
        response.getWriter().print(data);
        response.getWriter().flush();
      }
    }
  }
}
