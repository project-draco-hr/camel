{
  Mailbox.clearAll();
  Endpoint endpoint=context.getEndpoint("smtp://james@mymailserver.com?password=secret");
  Exchange exchange=endpoint.createExchange();
  Message in=exchange.getIn();
  in.setBody("Hello World");
  in.addAttachment("logo.jpeg",new DataHandler(new FileDataSource("src/test/data/logo.jpeg")));
  in.addAttachment("license.txt",new DataHandler(new FileDataSource("src/main/resources/META-INF/LICENSE.txt")));
  Producer producer=endpoint.createProducer();
  producer.start();
  producer.process(exchange);
  Thread.sleep(2000);
  MockEndpoint mock=getMockEndpoint("mock:split");
  mock.expectedMessageCount(2);
  mock.assertIsSatisfied();
  Message first=mock.getReceivedExchanges().get(0).getIn();
  Message second=mock.getReceivedExchanges().get(1).getIn();
  assertEquals(1,first.getAttachments().size());
  assertEquals(1,second.getAttachments().size());
  String file1=first.getAttachments().keySet().iterator().next();
  String file2=second.getAttachments().keySet().iterator().next();
  boolean logo=file1.equals("logo.jpeg") || file2.equals("logo.jpeg");
  boolean license=file1.equals("license.txt") || file2.equals("license.txt");
  assertTrue("Should have logo.jpeg file attachment",logo);
  assertTrue("Should have license.txt file attachment",license);
}
