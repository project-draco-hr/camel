{
  Mailbox.clearAll();
  Endpoint endpoint=context.getEndpoint("smtp://james@mymailserver.com?password=secret");
  Exchange exchange=endpoint.createExchange();
  Message in=exchange.getIn();
  in.setBody("Hello World");
  in.addAttachment("logo.jpeg",new DataHandler(new FileDataSource("src/test/data/logo.jpeg")));
  in.addAttachment("license.txt",new DataHandler(new FileDataSource("src/main/resources/META-INF/LICENSE.txt")));
  Producer producer=endpoint.createProducer();
  producer.start();
  producer.process(exchange);
  Thread.sleep(2000);
  MockEndpoint mock=getMockEndpoint("mock:split");
  mock.expectedMessageCount(2);
  mock.assertIsSatisfied();
  Message first=mock.getReceivedExchanges().get(0).getIn();
  Message second=mock.getReceivedExchanges().get(1).getIn();
  assertEquals(1,first.getAttachments().size());
  assertEquals("logo.jpeg",first.getAttachments().keySet().iterator().next());
  assertEquals(1,second.getAttachments().size());
  assertEquals("license.txt",second.getAttachments().keySet().iterator().next());
}
