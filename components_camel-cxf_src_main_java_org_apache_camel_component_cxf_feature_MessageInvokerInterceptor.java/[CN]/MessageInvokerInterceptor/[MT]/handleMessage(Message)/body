{
  final Exchange exchange=message.getExchange();
  final Endpoint endpoint=exchange.get(Endpoint.class);
  final Service service=endpoint.getService();
  final MessageInvoker invoker=(MessageInvoker)service.getInvoker();
  Runnable invocation=new Runnable(){
    public void run(){
      Exchange runableEx=message.getExchange();
      invoker.invoke(runableEx);
      if (!exchange.isOneWay()) {
        Endpoint ep=exchange.get(Endpoint.class);
        Message outMessage=runableEx.getOutMessage();
        if (outMessage == null) {
          outMessage=ep.getBinding().createMessage();
          exchange.setOutMessage(outMessage);
        }
      }
    }
  }
;
  Executor executor=getExecutor(endpoint);
  if (exchange.get(Executor.class) == executor) {
    invocation.run();
  }
 else {
    exchange.put(Executor.class,executor);
    executor.execute(invocation);
  }
}
