{
  HttpOperationFailedException answer;
  String uri=httpExchange.getUrl();
  Map<String,String> headers=getSimpleMap(httpExchange.getResponseHeaders());
  Object responseBody=extractResponseBody(exchange,httpExchange);
  if (transferException && responseBody != null && responseBody instanceof Exception) {
    return (Exception)responseBody;
  }
  String copy=null;
  if (responseBody != null) {
    copy=exchange.getContext().getTypeConverter().convertTo(String.class,exchange,responseBody);
  }
  if (responseCode >= 300 && responseCode < 400) {
    Collection<String> loc=httpExchange.getResponseHeaders().get("location");
    if (loc != null && !loc.isEmpty()) {
      String locationHeader=loc.iterator().next();
      answer=new HttpOperationFailedException(uri,responseCode,null,locationHeader,headers,copy);
    }
 else {
      answer=new HttpOperationFailedException(uri,responseCode,null,null,headers,copy);
    }
  }
 else {
    answer=new HttpOperationFailedException(uri,responseCode,null,null,headers,copy);
  }
  return answer;
}
