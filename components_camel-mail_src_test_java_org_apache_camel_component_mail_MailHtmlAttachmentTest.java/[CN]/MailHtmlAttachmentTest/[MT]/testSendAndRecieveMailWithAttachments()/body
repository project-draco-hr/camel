{
  Endpoint endpoint=context.getEndpoint("smtp://james@mymailserver.com?password=secret&contentType=text/html");
  Exchange exchange=endpoint.createExchange();
  Message in=exchange.getIn();
  in.setBody("<html><body><h1>Hello</h1>World</body></html>");
  in.addAttachment("logo.jpeg",new DataHandler(new FileDataSource("src/test/data/logo.jpeg")));
  Producer producer=endpoint.createProducer();
  producer.start();
  producer.process(exchange);
  Thread.sleep(1500);
  MockEndpoint mock=getMockEndpoint("mock:result");
  mock.expectedMessageCount(1);
  Exchange out=mock.assertExchangeReceived(0);
  mock.assertIsSatisfied();
  assertEquals("<html><body><h1>Hello</h1>World</body></html>",out.getIn().getBody(String.class));
  Map<String,DataHandler> attachments=out.getIn().getAttachments();
  assertNotNull("Should have attachments",attachments);
  assertEquals(1,attachments.size());
  DataHandler handler=out.getIn().getAttachment("logo.jpeg");
  assertNotNull("The logo should be there",handler);
  assertEquals("image/jpeg; name=logo.jpeg",handler.getContentType());
  producer.stop();
}
