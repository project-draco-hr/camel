{
  Cipher cipher=cryptoProvider == null ? Cipher.getInstance(algorithm) : Cipher.getInstance(algorithm,cryptoProvider);
  if (key == null) {
    throw new IllegalStateException("A valid encryption key is required. Either configure the CryptoDataFormat " + "with a key or provide one in a header using the header name 'CamelCryptoKey'");
  }
  if (mode == ENCRYPT_MODE || mode == DECRYPT_MODE) {
    if (iv != null) {
      cipher.init(mode,key,new IvParameterSpec(iv));
    }
 else     if (parameterSpec != null) {
      cipher.init(mode,key,parameterSpec);
    }
 else {
      cipher.init(mode,key);
    }
  }
  return cipher;
}
