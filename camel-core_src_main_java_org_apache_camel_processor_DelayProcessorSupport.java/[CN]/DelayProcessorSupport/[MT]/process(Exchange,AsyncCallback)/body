{
  if (!isRunAllowed()) {
    exchange.setException(new RejectedExecutionException("Run is not allowed"));
    callback.done(true);
    return true;
  }
  long delay;
  try {
    delay=calculateDelay(exchange);
    if (delay <= 0) {
      log.trace("No delay for exchangeId: {}",exchange.getExchangeId());
      return super.process(exchange,callback);
    }
  }
 catch (  Throwable e) {
    exchange.setException(e);
    callback.done(true);
    return true;
  }
  if (!isAsyncDelayed() || exchange.isTransacted()) {
    try {
      delay(delay,exchange);
      return super.process(exchange,callback);
    }
 catch (    Exception e) {
      exchange.setException(e);
      callback.done(true);
      return true;
    }
  }
 else {
    ProcessCall call=new ProcessCall(exchange,callback);
    try {
      log.trace("Scheduling delayed task to run in {} millis for exchangeId: {}",delay,exchange.getExchangeId());
      executorService.schedule(call,delay,TimeUnit.MILLISECONDS);
      return false;
    }
 catch (    RejectedExecutionException e) {
      if (isCallerRunsWhenRejected()) {
        if (!isRunAllowed()) {
          exchange.setException(new RejectedExecutionException());
        }
 else {
          log.debug("Scheduling rejected task, so letting caller run, delaying at first for {} millis for exchangeId: {}",delay,exchange.getExchangeId());
          try {
            delay(delay,exchange);
          }
 catch (          InterruptedException ie) {
            exchange.setException(ie);
          }
          return super.process(exchange,callback);
        }
      }
 else {
        exchange.setException(e);
      }
      callback.done(true);
      return true;
    }
  }
}
