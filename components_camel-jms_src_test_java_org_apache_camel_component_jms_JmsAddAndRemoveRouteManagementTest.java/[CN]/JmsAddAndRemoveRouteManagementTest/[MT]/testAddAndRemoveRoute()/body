{
  MBeanServer mbeanServer=getMBeanServer();
  Set<ObjectName> before=mbeanServer.queryNames(new ObjectName("*:type=threadpools,*"),null);
  getMockEndpoint("mock:result").expectedMessageCount(1);
  context.addRoutes(new RouteBuilder(){
    @Override public void configure() throws Exception {
      from("activemq:queue:in").routeId("myNewRoute").to("activemq:queue:foo");
    }
  }
);
  Set<ObjectName> during=mbeanServer.queryNames(new ObjectName("*:type=threadpools,*"),null);
  assertEquals("There should be one more thread pool in JMX",before.size() + 1,during.size());
  template.sendBody("activemq:queue:in","Hello World");
  assertMockEndpointsSatisfied();
  context.stopRoute("myNewRoute");
  context.removeRoute("myNewRoute");
  Set<ObjectName> after=mbeanServer.queryNames(new ObjectName("*:type=threadpools,*"),null);
  assertEquals("Should have removed all thread pools from removed route",before.size(),after.size());
}
