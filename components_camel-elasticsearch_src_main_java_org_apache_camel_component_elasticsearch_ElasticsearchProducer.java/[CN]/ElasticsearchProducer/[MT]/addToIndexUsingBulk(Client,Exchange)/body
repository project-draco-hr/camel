{
  String indexName=exchange.getIn().getHeader(ElasticsearchConfiguration.PARAM_INDEX_NAME,String.class);
  if (indexName == null) {
    indexName=getEndpoint().getConfig().getIndexName();
  }
  String indexType=exchange.getIn().getHeader(ElasticsearchConfiguration.PARAM_INDEX_TYPE,String.class);
  if (indexType == null) {
    indexType=getEndpoint().getConfig().getIndexType();
  }
  log.debug("Preparing Bulk Request");
  BulkRequestBuilder bulkRequest=client.prepareBulk();
  List<?> body=exchange.getIn().getBody(List.class);
  for (  Object document : body) {
    IndexRequestBuilder prepareIndex=client.prepareIndex(indexName,indexType);
    log.trace("Indexing document : {}",document);
    if (!setIndexRequestSource(document,prepareIndex)) {
      throw new ExpectedBodyTypeException(exchange,XContentBuilder.class);
    }
    bulkRequest.add(prepareIndex);
  }
  ListenableActionFuture<BulkResponse> future=bulkRequest.execute();
  BulkResponse bulkResponse=future.actionGet();
  List<String> indexedIds=new LinkedList<String>();
  for (  BulkItemResponse response : bulkResponse.getItems()) {
    indexedIds.add(response.getId());
  }
  log.debug("List of successfully indexed document ids : {}",indexedIds);
  exchange.getIn().setBody(indexedIds);
}
