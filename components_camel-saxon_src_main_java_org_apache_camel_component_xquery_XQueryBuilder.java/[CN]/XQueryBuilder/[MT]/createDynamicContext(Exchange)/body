{
  Configuration config=getConfiguration();
  DynamicQueryContext dynamicQueryContext=new DynamicQueryContext(config);
  Message in=exchange.getIn();
  Item item=in.getBody(Item.class);
  if (item != null) {
    dynamicQueryContext.setContextItem(item);
  }
 else {
    Object body=in.getBody();
    InputStream is=null;
    try {
      Source source;
      if (isInputStreamNeeded(exchange)) {
        is=exchange.getIn().getBody(InputStream.class);
        source=getSource(exchange,is);
      }
 else {
        source=getSource(exchange,body);
      }
      if (source == null) {
        if (body instanceof WrappedFile) {
          is=exchange.getContext().getTypeConverter().convertTo(InputStream.class,body);
          source=converter.toDOMSource(is);
        }
 else         if (body instanceof BeanInvocation) {
          BeanInvocation bi=exchange.getContext().getTypeConverter().convertTo(BeanInvocation.class,body);
          if (bi.getArgs() != null && bi.getArgs().length == 1 && bi.getArgs()[0] == null) {
            source=null;
          }
        }
      }
      if (source == null) {
        throw new NoTypeConversionAvailableException(body,Source.class);
      }
      DocumentInfo doc=getStaticQueryContext().buildDocument(source);
      dynamicQueryContext.setContextItem(doc);
    }
  finally {
      IOHelper.close(is);
    }
  }
  configureQuery(dynamicQueryContext,exchange);
  MessageHelper.resetStreamCache(exchange.getIn());
  return dynamicQueryContext;
}
