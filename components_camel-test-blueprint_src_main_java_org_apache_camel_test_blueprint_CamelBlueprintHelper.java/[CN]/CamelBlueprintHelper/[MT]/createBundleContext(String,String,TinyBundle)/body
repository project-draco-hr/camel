{
  String uid="" + System.currentTimeMillis();
  String tempDir="target/bundles/" + uid;
  System.setProperty("org.osgi.framework.storage",tempDir);
  System.setProperty("org.apache.aries.blueprint.synchronous","false");
  createDirectory(tempDir);
  createDirectory("target/test-bundles");
  List<BundleDescriptor> bundles=getBundleDescriptors(bundleFilter);
  if (bundle != null) {
    String jarName=name.toLowerCase(Locale.ENGLISH) + "-" + uid+ ".jar";
    bundles.add(getBundleDescriptor("target/test-bundles/" + jarName,bundle));
  }
  if (LOG.isDebugEnabled()) {
    for (int i=0; i < bundles.size(); i++) {
      BundleDescriptor desc=bundles.get(i);
      LOG.debug("Bundle #{} -> {}",i,desc);
    }
  }
  Map<String,Object> config=new HashMap<String,Object>();
  config.put(PojoServiceRegistryFactory.BUNDLE_DESCRIPTORS,bundles);
  PojoServiceRegistry reg=new PojoServiceRegistryFactoryImpl().newPojoServiceRegistry(config);
  return reg.getBundleContext();
}
