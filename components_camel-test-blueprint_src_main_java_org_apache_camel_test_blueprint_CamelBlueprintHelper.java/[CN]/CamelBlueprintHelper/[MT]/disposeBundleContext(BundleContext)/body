{
  try {
    if (bundleContext != null) {
      List<Bundle> bundles=new ArrayList<Bundle>();
      bundles.addAll(Arrays.asList(bundleContext.getBundles()));
      Collections.reverse(bundles);
      for (      Bundle bundle : bundles) {
        LOG.debug("Stopping bundle {}",bundle);
        bundle.stop();
      }
    }
  }
 catch (  Exception e) {
    IllegalStateException ise=ObjectHelper.getException(IllegalStateException.class,e);
    if (ise != null) {
      LOG.debug("Error during disposing BundleContext. This exception will be ignored.",e);
    }
 else {
      LOG.warn("Error during disposing BundleContext. This exception will be ignored.",e);
    }
  }
 finally {
    String tempDir=System.clearProperty("org.osgi.framework.storage");
    if (tempDir != null) {
      LOG.info("Deleting work directory {}",tempDir);
      deleteDirectory(tempDir);
    }
  }
}
