{
  deleteDirectory("target/bundles");
  createDirectory("target/bundles");
  System.setProperty("org.osgi.framework.storage","target/bundles/" + System.currentTimeMillis());
  List<BundleDescriptor> bundles=getBundleDescriptors(bundleFilter);
  if (includeTestBundle) {
    TinyBundle bundle=createTestBundle(name,testBundleVersion,descriptors);
    String jarName=name.toLowerCase();
    bundles.add(getBundleDescriptor("target/bundles/" + jarName + ".jar",bundle));
  }
  if (LOG.isDebugEnabled()) {
    for (int i=0; i < bundles.size(); i++) {
      BundleDescriptor desc=bundles.get(i);
      LOG.debug("Bundle #{} -> {}",i,desc);
    }
  }
  Map<String,List<BundleDescriptor>> config=new HashMap<String,List<BundleDescriptor>>();
  config.put(PojoServiceRegistryFactory.BUNDLE_DESCRIPTORS,bundles);
  PojoServiceRegistry reg=new PojoServiceRegistryFactoryImpl().newPojoServiceRegistry(config);
  return reg.getBundleContext();
}
