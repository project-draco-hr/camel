{
  if (log.isTraceEnabled()) {
    log.trace("pollDirectory from fileName: " + fileName);
  }
  File directory=new File(fileName);
  if (!directory.exists() || !directory.isDirectory()) {
    if (log.isDebugEnabled()) {
      log.debug("Cannot poll as directory does not exists or its not a directory: " + directory);
    }
    if (getEndpoint().isDirectoryMustExist()) {
      throw new GenericFileOperationFailedException("Directory does not exist: " + directory);
    }
    return true;
  }
  if (log.isTraceEnabled()) {
    log.trace("Polling directory: " + directory.getPath());
  }
  File[] files=directory.listFiles();
  if (files == null || files.length == 0) {
    if (log.isTraceEnabled()) {
      log.trace("No files found in directory: " + directory.getPath());
    }
    return true;
  }
 else {
    if (log.isTraceEnabled()) {
      log.trace("Found " + files.length + " in directory: "+ directory.getPath());
    }
  }
  for (  File file : files) {
    if (!canPollMoreFiles(fileList)) {
      return false;
    }
    if (log.isTraceEnabled()) {
      log.trace("Found file: " + file + " [isAbsolute: "+ file.isAbsolute()+ ", isDirectory: "+ file.isDirectory()+ ", isFile: "+ file.isFile()+ ", isHidden: "+ file.isHidden()+ "]");
    }
    GenericFile<File> gf=asGenericFile(endpointPath,file);
    if (file.isDirectory()) {
      if (endpoint.isRecursive() && isValidFile(gf,true)) {
        String subDirectory=fileName + File.separator + file.getName();
        boolean canPollMore=pollDirectory(subDirectory,fileList);
        if (!canPollMore) {
          return false;
        }
      }
    }
 else {
      if (isValidFile(gf,false)) {
        if (isInProgress(gf)) {
          if (log.isTraceEnabled()) {
            log.trace("Skipping as file is already in progress: " + gf.getFileName());
          }
        }
 else {
          if (log.isTraceEnabled()) {
            log.trace("Adding valid file: " + file);
          }
          fileList.add(gf);
        }
      }
    }
  }
  return true;
}
