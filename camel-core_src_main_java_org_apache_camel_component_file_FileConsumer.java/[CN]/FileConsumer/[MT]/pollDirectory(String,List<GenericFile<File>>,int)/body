{
  log.trace("pollDirectory from fileName: {}",fileName);
  depth++;
  File directory=new File(fileName);
  if (!directory.exists() || !directory.isDirectory()) {
    log.debug("Cannot poll as directory does not exists or its not a directory: {}",directory);
    if (getEndpoint().isDirectoryMustExist()) {
      throw new GenericFileOperationFailedException("Directory does not exist: " + directory);
    }
    return true;
  }
  log.trace("Polling directory: {}",directory.getPath());
  File[] dirFiles=directory.listFiles();
  if (dirFiles == null || dirFiles.length == 0) {
    if (log.isTraceEnabled()) {
      log.trace("No files found in directory: {}",directory.getPath());
    }
    return true;
  }
 else {
    if (log.isTraceEnabled()) {
      log.trace("Found {} in directory: {}",dirFiles.length,directory.getPath());
    }
  }
  List<File> files=Arrays.asList(dirFiles);
  for (  File file : dirFiles) {
    if (!canPollMoreFiles(fileList)) {
      return false;
    }
    if (log.isTraceEnabled()) {
      log.trace("Found file: {} [isAbsolute: {}, isDirectory: {}, isFile: {}, isHidden: {}]",new Object[]{file,file.isAbsolute(),file.isDirectory(),file.isFile(),file.isHidden()});
    }
    GenericFile<File> gf=asGenericFile(endpointPath,file,getEndpoint().getCharset(),getEndpoint().isProbeContentType());
    if (file.isDirectory()) {
      if (endpoint.isRecursive() && depth < endpoint.getMaxDepth() && isValidFile(gf,true,files)) {
        String subDirectory=fileName + File.separator + file.getName();
        boolean canPollMore=pollDirectory(subDirectory,fileList,depth);
        if (!canPollMore) {
          return false;
        }
      }
    }
 else {
      if (depth >= endpoint.minDepth && isValidFile(gf,false,files)) {
        log.trace("Adding valid file: {}",file);
        if (extendedAttributes != null) {
          Path path=file.toPath();
          Map<String,Object> allAttributes=new HashMap<>();
          for (          String attribute : extendedAttributes) {
            try {
              String prefix=null;
              if (attribute.endsWith(":*")) {
                prefix=attribute.substring(0,attribute.length() - 1);
              }
 else               if (attribute.equals("*")) {
                prefix="basic:";
              }
              if (ObjectHelper.isNotEmpty(prefix)) {
                Map<String,Object> attributes=Files.readAttributes(path,attribute);
                if (attributes != null) {
                  for (                  Map.Entry<String,Object> entry : attributes.entrySet()) {
                    allAttributes.put(prefix + entry.getKey(),entry.getValue());
                  }
                }
              }
 else               if (!attribute.contains(":")) {
                allAttributes.put("basic:" + attribute,Files.getAttribute(path,attribute));
              }
 else {
                allAttributes.put(attribute,Files.getAttribute(path,attribute));
              }
            }
 catch (            IOException e) {
              if (log.isDebugEnabled()) {
                log.debug("Unable to read attribute {} on file {}",attribute,file,e);
              }
            }
          }
          gf.setExtendedAttributes(allAttributes);
        }
        fileList.add(gf);
      }
    }
  }
  return true;
}
