{
  List<File> files=new ArrayList<File>();
  scanFilesToPoll(endpoint.getFile(),true,files);
  if (endpoint.getFileSorter() != null) {
    Collections.sort(files,endpoint.getFileSorter());
  }
  List<FileExchange> exchanges=new ArrayList<FileExchange>(files.size());
  for (  File file : files) {
    FileExchange exchange=endpoint.createExchange(file);
    endpoint.configureMessage(file,exchange.getIn());
    exchanges.add(exchange);
  }
  if (endpoint.getExchangeSorter() != null) {
    Collections.sort(exchanges,endpoint.getExchangeSorter());
  }
  int total=exchanges.size();
  for (int index=0; index < total; index++) {
    FileExchange exchange=exchanges.get(index);
    exchange.getIn().setHeader(FileComponent.HEADER_FILE_BATCH_INDEX,index);
    exchange.getIn().setHeader(FileComponent.HEADER_FILE_BATCH_TOTAL,total);
    processExchange(exchange);
  }
}
