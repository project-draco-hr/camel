{
  try {
    HttpConsumer consumer=resolve(request);
    if (consumer == null) {
      response.sendError(HttpServletResponse.SC_NOT_FOUND);
      return;
    }
    final Continuation continuation=ContinuationSupport.getContinuation(request,null);
    if (continuation.isNew()) {
      final HttpExchange exchange=new HttpExchange(consumer.getEndpoint(),request,response);
      boolean sync=consumer.getAsyncProcessor().process(exchange,new AsyncCallback(){
        public void done(        boolean sync){
          if (sync) {
            return;
          }
          continuation.setObject(exchange);
          continuation.resume();
        }
      }
);
      if (!sync) {
        continuation.suspend(0);
      }
      consumer.getBinding().writeResponse(exchange);
      return;
    }
    if (continuation.isResumed()) {
      HttpExchange exchange=(HttpExchange)continuation.getObject();
      consumer.getBinding().writeResponse(exchange);
      return;
    }
  }
 catch (  Exception e) {
    throw new ServletException(e);
  }
}
