{
  String routeId=routeContext != null ? routeContext.getRoute().idOrCreate(routeContext.getCamelContext().getNodeIdFactory()) : null;
  CamelInternalProcessor internal=new CamelInternalProcessor(processor);
  UnitOfWork parent=exchange.getProperty(Exchange.PARENT_UNIT_OF_WORK,UnitOfWork.class);
  if (parent != null) {
    internal.addAdvice(new CamelInternalProcessor.ChildUnitOfWorkProcessorAdvice(routeId,parent));
  }
 else {
    internal.addAdvice(new CamelInternalProcessor.UnitOfWorkProcessorAdvice(routeId));
  }
  if (routeContext != null) {
    internal.addAdvice(new CamelInternalProcessor.RouteContextAdvice(routeContext));
  }
  return internal;
}
