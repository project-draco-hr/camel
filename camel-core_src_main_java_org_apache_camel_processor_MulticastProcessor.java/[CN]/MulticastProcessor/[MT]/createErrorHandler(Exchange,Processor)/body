{
  Processor answer=processor;
  if (exchange.getUnitOfWork() != null && exchange.getUnitOfWork().getRouteContext() != null) {
    RouteContext routeContext=exchange.getUnitOfWork().getRouteContext();
    final PreparedErrorHandler key=new PreparedErrorHandler(routeContext,processor);
    answer=errorHandlers.get(key);
    if (answer != null) {
      if (LOG.isTraceEnabled()) {
        LOG.trace("Using existing error handler for: " + processor);
      }
      return answer;
    }
    if (LOG.isTraceEnabled()) {
      LOG.trace("Creating error handler for: " + processor);
    }
    ErrorHandlerBuilder builder=routeContext.getRoute().getErrorHandlerBuilder();
    try {
      processor=builder.createErrorHandler(routeContext,processor);
      answer=new UnitOfWorkProcessor(processor);
    }
 catch (    Exception e) {
      throw ObjectHelper.wrapRuntimeCamelException(e);
    }
    errorHandlers.putIfAbsent(key,answer);
  }
  return answer;
}
