{
  if (latch != null) {
    latch.await(10,TimeUnit.SECONDS);
  }
 else   if (expectedCount == 0) {
    if (timeoutForEmptyEndpoints > 0) {
      Thread.sleep(timeoutForEmptyEndpoints);
    }
  }
  if (expectedCount >= 0) {
    int receivedCounter=getReceivedCounter();
    assertEquals("Expected message count",expectedCount,receivedCounter);
  }
  for (  Runnable test : tests) {
    test.run();
  }
  for (  Throwable failure : failures) {
    if (failure != null) {
      log.error("Caught: " + failure,failure);
      throw new AssertionError("Failed due to caught exception: " + failure);
    }
  }
}
