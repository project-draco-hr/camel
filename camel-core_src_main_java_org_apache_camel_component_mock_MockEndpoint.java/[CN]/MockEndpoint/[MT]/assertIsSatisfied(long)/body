{
  if (expectedCount >= 0) {
    if (expectedCount != getReceivedCounter()) {
      if (expectedCount == 0) {
        if (timeoutForEmptyEndpoints > 0) {
          log.debug("Sleeping for: " + timeoutForEmptyEndpoints + " millis to check there really are no messages received");
          Thread.sleep(timeoutForEmptyEndpoints);
        }
      }
 else {
        if (latch == null) {
          fail("Should have a latch!");
        }
        log.debug("Waiting on the latch for: " + defaulResultWaitMillis + " millis");
        latch.await(defaulResultWaitMillis,TimeUnit.MILLISECONDS);
      }
    }
    assertEquals("Received message count",expectedCount,getReceivedCounter());
  }
  if (expectedMinimumCount >= 0) {
    int receivedCounter=getReceivedCounter();
    assertTrue("Received message count " + receivedCounter + ", expected at least "+ expectedCount,expectedCount <= receivedCounter);
  }
  for (  Runnable test : tests) {
    test.run();
  }
  for (  Throwable failure : failures) {
    if (failure != null) {
      log.error("Caught on " + getEndpointUri() + " Exception: "+ failure,failure);
      fail("Failed due to caught exception: " + failure);
    }
  }
}
