{
  flush();
  ByteArrayOutputStream bout=(ByteArrayOutputStream)currentStream;
  if (outputDir == null) {
    tempFile=FileUtil.createTempFile("cos",".tmp");
  }
 else {
    tempFile=FileUtil.createTempFile("cos",".tmp",outputDir);
  }
  LOG.trace("Creating temporary stream cache file: {}",tempFile);
  try {
    currentStream=createOutputStream(tempFile);
    bout.writeTo(currentStream);
  }
  finally {
    inMemory=false;
  }
}
