{
  flush();
  if (totalLength < limit || limit == -1) {
    writeCacheTo(out);
    return;
  }
  int count=0;
  if (inmem) {
    if (currentStream instanceof ByteArrayOutputStream) {
      byte bytes[]=((ByteArrayOutputStream)currentStream).toByteArray();
      out.append(IOHelper.newStringFromBytes(bytes,0,limit));
    }
 else {
      throw new IOException("Unknown format of currentStream");
    }
  }
 else {
    FileInputStream fin=new FileInputStream(tempFile);
    byte bytes[]=new byte[1024];
    int x=fin.read(bytes);
    while (x != -1) {
      if ((count + x) > limit) {
        x=limit - count;
      }
      out.append(IOHelper.newStringFromBytes(bytes,0,x));
      count+=x;
      if (count >= limit) {
        x=-1;
      }
 else {
        x=fin.read(bytes);
      }
    }
    fin.close();
  }
}
