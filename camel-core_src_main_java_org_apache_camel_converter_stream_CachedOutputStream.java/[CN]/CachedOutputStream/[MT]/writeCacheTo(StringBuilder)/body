{
  flush();
  if (inMemory) {
    if (currentStream instanceof ByteArrayOutputStream) {
      byte[] bytes=((ByteArrayOutputStream)currentStream).toByteArray();
      out.append(IOHelper.newStringFromBytes(bytes));
    }
 else {
      throw new IOException("Unknown format of currentStream: " + currentStream);
    }
  }
 else {
    FileInputStream fin=new FileInputStream(tempFile);
    byte bytes[]=new byte[1024];
    int x=fin.read(bytes);
    while (x != -1) {
      out.append(IOHelper.newStringFromBytes(bytes,0,x));
      x=fin.read(bytes);
    }
    fin.close();
  }
}
