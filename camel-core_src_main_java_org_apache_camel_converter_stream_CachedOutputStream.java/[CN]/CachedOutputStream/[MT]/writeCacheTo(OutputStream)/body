{
  flush();
  if (inMemory) {
    if (currentStream instanceof ByteArrayOutputStream) {
      ((ByteArrayOutputStream)currentStream).writeTo(out);
    }
 else {
      throw new IOException("Unknown format of currentStream");
    }
  }
 else {
    FileInputStream fin=new FileInputStream(tempFile);
    IOHelper.copyAndCloseInput(fin,out);
  }
}
