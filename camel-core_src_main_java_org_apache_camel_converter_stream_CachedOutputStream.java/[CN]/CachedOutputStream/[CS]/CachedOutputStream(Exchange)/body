{
  String hold=exchange.getContext().getProperties().get(THRESHOLD);
  String dir=exchange.getContext().getProperties().get(TEMP_DIR);
  if (hold != null) {
    this.threshold=exchange.getContext().getTypeConverter().convertTo(Long.class,hold);
  }
  if (dir != null) {
    this.outputDir=exchange.getContext().getTypeConverter().convertTo(File.class,dir);
  }
  exchange.addOnCompletion(new SynchronizationAdapter(){
    @Override public void onDone(    Exchange exchange){
      try {
        if (tempFile != null) {
          boolean deleted=tempFile.delete();
          if (!deleted) {
            LOG.warn("Cannot delete temporary cache file: " + tempFile);
          }
 else           if (LOG.isTraceEnabled()) {
            LOG.trace("Deleted temporary cache file: " + tempFile);
          }
          tempFile=null;
        }
      }
 catch (      Exception e) {
        LOG.warn("Error deleting temporary cache file: " + tempFile,e);
      }
    }
    @Override public String toString(){
      return "OnCompletion[CachedOutputStream]";
    }
  }
);
}
