{
  String queryHeader=exchange.getIn().getHeader(SqlConstants.SQL_QUERY,String.class);
  jdbcTemplate.execute(queryHeader != null ? queryHeader : query,new PreparedStatementCallback<Map<?,?>>(){
    public Map<?,?> doInPreparedStatement(    PreparedStatement ps) throws SQLException, DataAccessException {
      int argNumber=1;
      int expected=ps.getParameterMetaData().getParameterCount();
      if (expected > 0 && exchange.getIn().getBody() != null) {
        Iterator<?> iterator=exchange.getIn().getBody(Iterator.class);
        while (iterator != null && iterator.hasNext()) {
          Object value=iterator.next();
          log.trace("Setting parameter #{} with value: {}",argNumber,value);
          ps.setObject(argNumber,value);
          argNumber++;
        }
      }
      if (argNumber - 1 != expected) {
        throw new SQLException("Number of parameters mismatch. Expected: " + expected + ", was:"+ (argNumber - 1));
      }
      boolean isResultSet=ps.execute();
      if (isResultSet) {
        RowMapperResultSetExtractor<Map<String,Object>> mapper=new RowMapperResultSetExtractor<Map<String,Object>>(new ColumnMapRowMapper());
        List<Map<String,Object>> result=mapper.extractData(ps.getResultSet());
        exchange.getOut().setBody(result);
        exchange.getIn().setHeader(SqlConstants.SQL_ROW_COUNT,result.size());
        exchange.getOut().setHeaders(exchange.getIn().getHeaders());
      }
 else {
        exchange.getIn().setHeader(SqlConstants.SQL_UPDATE_COUNT,ps.getUpdateCount());
      }
      return null;
    }
  }
);
}
