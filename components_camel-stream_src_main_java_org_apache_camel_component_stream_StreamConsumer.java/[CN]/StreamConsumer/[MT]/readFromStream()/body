{
  Charset charset=endpoint.getCharset();
  BufferedReader br=new BufferedReader(new InputStreamReader(inputStream,charset));
  String line;
  if (endpoint.isScanStream()) {
    while (isRunAllowed()) {
      line=br.readLine();
      if (LOG.isTraceEnabled()) {
        LOG.trace("Read line: " + line);
      }
      boolean eos=line == null;
      if (!eos && isRunAllowed()) {
        processLine(line);
      }
      try {
        Thread.sleep(endpoint.getScanStreamDelay());
      }
 catch (      InterruptedException e) {
        Thread.currentThread().interrupt();
        break;
      }
    }
  }
 else {
    boolean eos=false;
    while (!eos && isRunAllowed()) {
      if (endpoint.getPromptMessage() != null) {
        doPromptMessage();
      }
      line=br.readLine();
      if (LOG.isTraceEnabled()) {
        LOG.trace("Read line: " + line);
      }
      eos=line == null;
      if (!eos && isRunAllowed()) {
        processLine(line);
      }
    }
  }
}
