{
  String answer=text;
  boolean done=false;
  List<String> visited=new ArrayList<String>();
  while (!done) {
    List<String> replaced=new ArrayList<String>();
    answer=doParseUri(answer,properties,replaced,prefixToken,suffixToken,propertyPrefix,propertySuffix,fallbackToUnaugmentedProperty);
    for (    String replace : replaced) {
      if (visited.contains(replace)) {
        throw new IllegalArgumentException("Circular reference detected with key [" + replace + "] from text: "+ text);
      }
    }
    visited.addAll(replaced);
    done=findTokenPosition(answer,0,prefixToken) == -1;
  }
  return answer;
}
