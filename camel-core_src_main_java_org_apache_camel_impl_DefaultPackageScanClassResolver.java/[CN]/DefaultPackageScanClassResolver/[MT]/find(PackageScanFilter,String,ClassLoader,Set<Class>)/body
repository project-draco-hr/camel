{
  if (LOG.isTraceEnabled()) {
    LOG.trace("Searching for: " + test + " in package: "+ packageName+ " using classloader: "+ loader.getClass().getName());
  }
  Enumeration<URL> urls;
  try {
    urls=getResources(loader,packageName);
    if (!urls.hasMoreElements()) {
      LOG.trace("No URLs returned by classloader");
    }
  }
 catch (  IOException ioe) {
    LOG.warn("Could not read package: " + packageName,ioe);
    return;
  }
  while (urls.hasMoreElements()) {
    URL url=null;
    try {
      url=urls.nextElement();
      if (LOG.isTraceEnabled()) {
        LOG.trace("URL from classloader: " + url);
      }
      String urlPath=url.getFile();
      urlPath=URLDecoder.decode(urlPath,"UTF-8");
      if (LOG.isTraceEnabled()) {
        LOG.trace("Decoded urlPath: " + urlPath);
      }
      if (urlPath.startsWith("file:")) {
        urlPath=urlPath.substring(5);
      }
      if (url.toString().startsWith("bundle:") || urlPath.startsWith("bundle:")) {
        LOG.trace("It's a virtual osgi bundle, skipping");
        continue;
      }
      if (urlPath.indexOf('!') > 0) {
        urlPath=urlPath.substring(0,urlPath.indexOf('!'));
      }
      if (LOG.isTraceEnabled()) {
        LOG.trace("Scanning for classes in [" + urlPath + "] matching criteria: "+ test);
      }
      File file=new File(urlPath);
      if (file.isDirectory()) {
        if (LOG.isDebugEnabled()) {
          LOG.debug("Loading from directory: " + file);
        }
        loadImplementationsInDirectory(test,packageName,file,classes);
      }
 else {
        InputStream stream;
        if (urlPath.startsWith("http:")) {
          LOG.debug("The current jar is accessed via http");
          URL urlStream=new URL(urlPath);
          URLConnection con=urlStream.openConnection();
          con.setUseCaches(false);
          stream=con.getInputStream();
        }
 else {
          stream=new FileInputStream(file);
        }
        if (LOG.isDebugEnabled()) {
          LOG.debug("Loading from jar: " + file);
        }
        loadImplementationsInJar(test,packageName,stream,urlPath,classes);
      }
    }
 catch (    IOException ioe) {
      LOG.warn("Could not read entries in url: " + url,ioe);
    }
  }
}
