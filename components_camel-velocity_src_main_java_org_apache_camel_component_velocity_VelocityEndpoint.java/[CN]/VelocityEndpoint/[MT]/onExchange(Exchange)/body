{
  String path=getResourceUri();
  ObjectHelper.notNull(path,"resourceUri");
  String newResourceUri=exchange.getIn().getHeader(VelocityConstants.VELOCITY_RESOURCE_URI,String.class);
  if (newResourceUri != null) {
    exchange.getIn().removeHeader(VelocityConstants.VELOCITY_RESOURCE_URI);
    if (log.isDebugEnabled()) {
      log.debug(VelocityConstants.VELOCITY_RESOURCE_URI + " set to " + newResourceUri+ " creating new endpoint to handle exchange");
    }
    VelocityEndpoint newEndpoint=findOrCreateEndpoint(getEndpointUri(),newResourceUri);
    newEndpoint.onExchange(exchange);
    return;
  }
  Resource resource;
  Reader reader;
  String content=exchange.getIn().getHeader(VelocityConstants.VELOCITY_TEMPLATE,String.class);
  if (content != null) {
    reader=new StringReader(content);
    if (log.isDebugEnabled()) {
      log.debug("Velocity content read from header " + VelocityConstants.VELOCITY_TEMPLATE + " for endpoint "+ getEndpointUri());
    }
    exchange.getIn().removeHeader(VelocityConstants.VELOCITY_TEMPLATE);
  }
 else {
    resource=getResource();
    ObjectHelper.notNull(resource,"resource");
    if (log.isDebugEnabled()) {
      log.debug("Velocity content read from resource " + resource + " with resourceUri: "+ path+ " for endpoint "+ getEndpointUri());
    }
    reader=getEncoding() != null ? new InputStreamReader(getResourceAsInputStream(),getEncoding()) : new InputStreamReader(getResourceAsInputStream());
  }
  StringWriter buffer=new StringWriter();
  String logTag=getClass().getName();
  Map variableMap=ExchangeHelper.createVariableMap(exchange);
  Context velocityContext=new VelocityContext(variableMap);
  VelocityEngine engine=getVelocityEngine();
  if (log.isDebugEnabled()) {
    log.debug("Velocity is evaluating using velocity context: " + variableMap);
  }
  engine.evaluate(velocityContext,buffer,logTag,reader);
  Message out=exchange.getOut();
  out.setBody(buffer.toString());
  Map<String,Object> headers=(Map<String,Object>)velocityContext.get("headers");
  for (  Entry<String,Object> entry : headers.entrySet()) {
    out.setHeader(entry.getKey(),entry.getValue());
  }
}
