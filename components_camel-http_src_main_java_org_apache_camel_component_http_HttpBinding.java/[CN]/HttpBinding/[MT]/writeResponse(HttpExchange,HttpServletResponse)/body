{
  Message out=exchange.getOut();
  if (out != null) {
    if (out.getHeader(HttpProducer.HTTP_RESPONSE_CODE) != null) {
      int responseCode=((Integer)out.getHeader(HttpProducer.HTTP_RESPONSE_CODE)).intValue();
      response.setStatus(responseCode);
    }
    for (    String key : out.getHeaders().keySet()) {
      String value=out.getHeader(key,String.class);
      if (shouldHeaderBePropagated(key,value)) {
        response.setHeader(key,value);
      }
    }
    if (out.getBody() != null) {
      InputStream is=out.getBody(InputStream.class);
      if (is != null) {
        ServletOutputStream os=response.getOutputStream();
        int c;
        while ((c=is.read()) >= 0) {
          os.write(c);
        }
      }
 else {
        String data=out.getBody(String.class);
        if (data != null) {
          response.getWriter().print(data);
        }
      }
    }
  }
}
