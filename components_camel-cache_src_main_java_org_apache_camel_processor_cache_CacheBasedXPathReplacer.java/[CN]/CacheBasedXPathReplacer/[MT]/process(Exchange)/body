{
  cacheManager=new DefaultCacheManagerFactory().getInstance();
  if (isValid(cacheManager,cacheName,key)) {
    cache=cacheManager.getCache(cacheName);
    if (LOG.isDebugEnabled()) {
      LOG.debug("Replacing XPath value {} in Message with value stored against key {} in CacheName {}",new Object[]{xpath,key,cacheName});
    }
    exchange.getIn().setHeader(CacheConstants.CACHE_KEY,key);
    Object body=exchange.getIn().getBody();
    InputStream is=exchange.getContext().getTypeConverter().convertTo(InputStream.class,body);
    try {
      document=exchange.getContext().getTypeConverter().convertTo(Document.class,exchange,is);
    }
  finally {
      IOHelper.close(is,"is",LOG);
    }
    InputStream cis=exchange.getContext().getTypeConverter().convertTo(InputStream.class,cache.get(key).getObjectValue());
    try {
      Document cacheValueDocument=exchange.getContext().getTypeConverter().convertTo(Document.class,exchange,cis);
      XmlConverter xmlConverter=new XmlConverter();
      String xslString=IOConverter.toString(new File("./src/main/resources/xpathreplacer.xsl"),exchange);
      xslString=xslString.replace("##match_token##",xpath);
      Source xslSource=xmlConverter.toStreamSource(new StringReader(xslString));
      TransformerFactory transformerFactory=xmlConverter.createTransformerFactory();
      Transformer transformer=transformerFactory.newTransformer(xslSource);
      source=xmlConverter.toDOMSource(document);
      result=new DOMResult();
      transformer.setParameter("cacheValue",cacheValueDocument);
      transformer.transform(source,result);
    }
  finally {
      IOHelper.close(cis,"cis",LOG);
    }
  }
  DOMSource dom=new DOMSource(result.getNode());
  exchange.getIn().setBody(dom,byte[].class);
}
