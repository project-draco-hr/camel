{
  getMockEndpoint("mock:foo").expectedMessageCount(5);
  getMockEndpoint("mock:bar").expectedMessageCount(5);
  getMockEndpoint("mock:baz").expectedMessageCount(5);
  for (int i=0; i < 10; i++) {
    if (i % 2 == 0) {
      template.sendBody("seda:foo","Hello " + i);
    }
 else {
      template.sendBody("seda:bar","Hello " + i);
    }
  }
  assertMockEndpointsSatisfied();
  assertEquals(3,metricRegistry.getNames().size());
  Set<ObjectName> set=getMBeanServer().queryNames(new ObjectName("org.apache.camel.metrics:*"),null);
  assertEquals(3,set.size());
  String name=String.format("org.apache.camel:context=%s,type=services,name=MetricsMessageHistoryService",context.getManagementName());
  ObjectName on=ObjectName.getInstance(name);
  String json=(String)getMBeanServer().invoke(on,"dumpStatisticsAsJson",null,null);
  assertNotNull(json);
  log.info(json);
  assertTrue(json.contains("foo.history"));
  assertTrue(json.contains("bar.history"));
  assertTrue(json.contains("baz.history"));
  getMBeanServer().invoke(on,"reset",null,null);
  resetMocks();
  getMockEndpoint("mock:foo").expectedMessageCount(1);
  template.sendBody("seda:foo","Hello Again");
  assertMockEndpointsSatisfied();
  json=(String)getMBeanServer().invoke(on,"dumpStatisticsAsJson",null,null);
  assertNotNull(json);
  log.info(json);
  assertTrue(json.contains("foo.history"));
  assertFalse(json.contains("bar.history"));
  assertFalse(json.contains("baz.history"));
}
