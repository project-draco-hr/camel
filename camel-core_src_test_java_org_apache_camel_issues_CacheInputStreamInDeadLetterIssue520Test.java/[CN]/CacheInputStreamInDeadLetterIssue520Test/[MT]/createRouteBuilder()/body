{
  return new RouteBuilder(){
    public void configure() throws Exception {
      context.setStreamCaching(true);
      errorHandler(deadLetterChannel("direct:errorHandler").maximumRedeliveries(3).redeliveryDelay(0));
      from("direct:start").process(new Processor(){
        public void process(        Exchange exchange) throws Exception {
          count++;
          String result=exchange.getIn().getBody(String.class);
          assertEquals("Should read the inputstream out again","<hello>Willem</hello>",result);
          throw new Exception("Forced exception by unit test");
        }
      }
);
      from("direct:errorHandler").process(new Processor(){
        public void process(        Exchange exchange) throws Exception {
          String result=exchange.getIn().getBody(String.class);
          assertEquals("Should read the inputstream out again","<hello>Willem</hello>",result);
        }
      }
).to("mock:error");
    }
  }
;
}
