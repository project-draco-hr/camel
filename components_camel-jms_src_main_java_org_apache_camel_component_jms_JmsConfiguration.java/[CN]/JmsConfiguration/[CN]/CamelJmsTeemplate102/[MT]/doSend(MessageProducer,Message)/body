{
  if (config.isPreserveMessageQos()) {
    long ttl=message.getJMSExpiration();
    if (ttl != 0) {
      ttl=ttl - System.currentTimeMillis();
      if (ttl <= 0) {
        ttl=1;
      }
    }
    if (isPubSubDomain()) {
      ((TopicPublisher)producer).publish(message,message.getJMSDeliveryMode(),message.getJMSPriority(),ttl);
    }
 else {
      ((QueueSender)producer).send(message,message.getJMSDeliveryMode(),message.getJMSPriority(),ttl);
    }
  }
 else {
    super.doSend(producer,message);
  }
}
