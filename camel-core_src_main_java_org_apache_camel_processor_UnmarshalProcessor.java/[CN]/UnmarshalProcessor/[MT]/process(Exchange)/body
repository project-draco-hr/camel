{
  ObjectHelper.notNull(dataFormat,"dataFormat");
  InputStream stream=ExchangeHelper.getMandatoryInBody(exchange,InputStream.class);
  try {
    Message out=exchange.getOut();
    out.copyFrom(exchange.getIn());
    Object result=dataFormat.unmarshal(exchange,stream);
    if (result instanceof Exchange) {
      if (result != exchange) {
        throw new RuntimeCamelException("The returned exchange " + result + " is not the same as "+ exchange+ " provided to the DataFormat");
      }
    }
 else     if (result instanceof Message) {
      Message message=(Message)result;
      ObjectHelper.notNull(message.getBody(),"body",message);
      exchange.setOut((Message)result);
    }
 else {
      ObjectHelper.notNull(result,"result");
      out.setBody(result);
    }
  }
 catch (  Exception e) {
    exchange.setOut(null);
    throw e;
  }
 finally {
    IOHelper.close(stream,"input stream");
  }
}
