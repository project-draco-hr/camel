{
  Snmp snmp=null;
  USM usm;
  TransportMapping<? extends Address> transport=null;
  CommunityTarget target=null;
  PDU pdu=null;
  Address targetAddress=null;
  try {
    LOG.debug("Starting SNMP producer on {}",endpoint.getAddress());
    targetAddress=GenericAddress.parse(endpoint.getAddress());
    LOG.debug("targetAddress: " + targetAddress);
    if ("tcp".equals(endpoint.getProtocol())) {
      transport=new DefaultTcpTransportMapping();
    }
 else     if ("udp".equals(endpoint.getProtocol())) {
      transport=new DefaultUdpTransportMapping();
    }
 else {
      throw new IllegalArgumentException("Unknown protocol: " + endpoint.getProtocol());
    }
    snmp=new Snmp(transport);
    usm=new USM(SecurityProtocols.getInstance(),new OctetString(MPv3.createLocalEngineID()),0);
    SecurityModels.getInstance().addSecurityModel(usm);
    target=new CommunityTarget();
    target.setCommunity(new OctetString(endpoint.getSnmpCommunity()));
    target.setAddress(targetAddress);
    target.setRetries(this.endpoint.getRetries());
    target.setTimeout(this.endpoint.getTimeout());
    target.setVersion(this.endpoint.getSnmpVersion());
    pdu=new PDU();
    for (    OID oid : endpoint.getOids()) {
      pdu.add(new VariableBinding(oid));
    }
    pdu.setErrorIndex(0);
    pdu.setErrorStatus(0);
    pdu.setMaxRepetitions(0);
    pdu.setType(PDU.GET);
    LOG.debug("Snmp: i am sending");
    snmp.listen();
    ResponseEvent responseEvent=snmp.send(pdu,target);
    LOG.debug("Snmp: sended");
    if (responseEvent.getResponse() != null) {
      exchange.getIn().setBody(new SnmpMessage(responseEvent.getResponse()));
    }
 else {
      throw new Exception("SNMP Producer Timeout");
    }
  }
  finally {
    try {
      transport.close();
    }
 catch (    Exception e) {
    }
    try {
      snmp.close();
    }
 catch (    Exception e) {
    }
  }
}
