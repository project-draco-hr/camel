{
  if (holder != null && isRunAllowed()) {
    try {
      Exchange exchange=holder.getExchange();
      Message message=holder.getMessage();
      boolean timeout=holder.isTimeout();
      if (timeout) {
        if (log.isWarnEnabled()) {
          log.warn("Timeout occurred after {} millis waiting for reply message with correlationID [{}]." + " Setting ExchangeTimedOutException on {} and continue routing.",new Object[]{holder.getRequestTimeout(),holder.getCorrelationId(),ExchangeHelper.logIds(exchange)});
        }
        String msg="reply message with correlationID: " + holder.getCorrelationId() + " not received";
        exchange.setException(new ExchangeTimedOutException(exchange,holder.getRequestTimeout(),msg));
      }
 else {
        JmsMessage response=new JmsMessage(message,endpoint.getBinding());
        Object body=response.getBody();
        if (endpoint.isTransferException() && body instanceof Exception) {
          log.debug("Reply received. Setting reply as an Exception: {}",body);
          exchange.setException((Exception)body);
        }
 else {
          log.debug("Reply received. Setting reply as OUT message: {}",body);
          exchange.setOut(response);
        }
        if (holder.getOriginalCorrelationId() != null) {
          JmsMessageHelper.setCorrelationId(message,holder.getOriginalCorrelationId());
          exchange.getOut().setHeader("JMSCorrelationID",holder.getOriginalCorrelationId());
        }
      }
    }
  finally {
      AsyncCallback callback=holder.getCallback();
      callback.done(false);
    }
  }
}
