{
  boolean doSend=false;
synchronized (calculationLock) {
    if (messageFrequency > 0) {
      currentMessageCount++;
      if (currentMessageCount % messageFrequency == 0) {
        doSend=true;
      }
    }
 else {
      long now=System.nanoTime();
      if (now >= timeOfLastExchange + periodInNanos) {
        doSend=true;
        if (log.isTraceEnabled()) {
          log.trace(sampled.sample());
        }
        timeOfLastExchange=now;
      }
 else {
        if (log.isTraceEnabled()) {
          log.trace(sampled.drop());
        }
      }
    }
  }
  if (doSend) {
    return super.process(exchange,callback);
  }
 else {
    try {
      stopper.process(exchange);
    }
 catch (    Exception e) {
      exchange.setException(e);
    }
  }
  callback.done(true);
  return true;
}
