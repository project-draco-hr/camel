{
  if (!camelContext.getStatus().isStarted()) {
    if (LOG.isTraceEnabled()) {
      LOG.trace("Recover check cannot start due CamelContext(" + camelContext.getName() + ") has not been started yet");
    }
    return;
  }
  LOG.trace("Starting recover check");
  Set<String> exchangeIds=recoverable.scan(camelContext);
  for (  String exchangeId : exchangeIds) {
    if (!isRunAllowed()) {
      LOG.info("We are shutting down so stop recovering");
      return;
    }
    boolean inProgress=inProgressCompleteExchanges.contains(exchangeId);
    if (inProgress) {
      if (LOG.isTraceEnabled()) {
        LOG.trace("Aggregated exchange with id: " + exchangeId + " is already in progress.");
      }
    }
 else {
      if (LOG.isDebugEnabled()) {
        LOG.debug("Loading aggregated exchange with id: " + exchangeId + " to be recovered.");
      }
      Exchange exchange=recoverable.recover(camelContext,exchangeId);
      if (exchange != null) {
        String key=exchange.getProperty(Exchange.AGGREGATED_CORRELATION_KEY,String.class);
        exchange.getIn().setHeader(Exchange.REDELIVERED,Boolean.TRUE);
        RedeliveryData data=redeliveryState.get(exchange.getExchangeId());
        if (data != null && recoverable.getMaximumRedeliveries() > 0 && data.redeliveryCounter >= recoverable.getMaximumRedeliveries()) {
          LOG.warn("The recovered exchange is exhausted after " + recoverable.getMaximumRedeliveries() + " attempts, will now be moved to dead letter channel: "+ recoverable.getDeadLetterUri());
          try {
            exchange.getIn().setHeader(Exchange.REDELIVERY_COUNTER,data.redeliveryCounter);
            exchange.getIn().setHeader(Exchange.REDELIVERY_EXHAUSTED,Boolean.TRUE);
            deadLetterProcessor.process(exchange);
          }
 catch (          Throwable e) {
            exchange.setException(e);
          }
          if (exchange.getException() != null) {
            getExceptionHandler().handleException("Failed to move recovered Exchange to dead letter channel: " + recoverable.getDeadLetterUri(),exchange.getException());
          }
 else {
            recoverable.confirm(camelContext,exchangeId);
          }
        }
 else {
          if (data == null) {
            data=new RedeliveryData();
            redeliveryState.put(exchange.getExchangeId(),data);
          }
          data.redeliveryCounter++;
          exchange.getIn().setHeader(Exchange.REDELIVERY_COUNTER,data.redeliveryCounter);
          if (recoverable.getMaximumRedeliveries() > 0) {
            exchange.getIn().setHeader(Exchange.REDELIVERY_MAX_COUNTER,recoverable.getMaximumRedeliveries());
          }
          if (LOG.isDebugEnabled()) {
            LOG.debug("Delivery attempt: " + data.redeliveryCounter + " to recover aggregated exchange with id: "+ exchangeId+ "");
          }
          onSubmitCompletion(key,exchange);
        }
      }
    }
  }
  LOG.trace("Recover check complete");
}
