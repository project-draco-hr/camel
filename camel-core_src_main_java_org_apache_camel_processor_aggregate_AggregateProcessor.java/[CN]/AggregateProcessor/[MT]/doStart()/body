{
  if (getCompletionTimeout() <= 0 && getCompletionSize() <= 0 && getCompletionPredicate() == null && !isCompletionFromBatchConsumer() && getCompletionTimeoutExpression() == null && getCompletionSizeExpression() == null) {
    throw new IllegalStateException("At least one of the completions options" + " [completionTimeout, completionSize, completionPredicate, completionFromBatchConsumer] must be set");
  }
  if (getCloseCorrelationKeyOnCompletion() != null) {
    if (getCloseCorrelationKeyOnCompletion() > 0) {
      LOG.info("Using ClosedCorrelationKeys with a LRUCache with a capacity of " + getCloseCorrelationKeyOnCompletion());
      closedCorrelationKeys=new LRUCache<Object,Object>(getCloseCorrelationKeyOnCompletion());
    }
 else {
      LOG.info("Using ClosedCorrelationKeys with unbounded capacity");
      closedCorrelationKeys=new HashMap<Object,Object>();
    }
  }
  ServiceHelper.startService(aggregationRepository);
  if (executorService == null) {
    if (isParallelProcessing()) {
      executorService=camelContext.getExecutorServiceStrategy().newCachedThreadPool(this,"Aggregator");
    }
 else {
      executorService=camelContext.getExecutorServiceStrategy().newSingleThreadExecutor(this,"Aggregator");
    }
  }
  if (getCompletionTimeout() > 0 || getCompletionTimeoutExpression() != null) {
    ScheduledExecutorService scheduler=camelContext.getExecutorServiceStrategy().newScheduledThreadPool(this,"AggregateTimeoutChecker",1);
    timeoutMap=new AggregationTimeoutMap(scheduler,1000L);
    ServiceHelper.startService(timeoutMap);
  }
}
