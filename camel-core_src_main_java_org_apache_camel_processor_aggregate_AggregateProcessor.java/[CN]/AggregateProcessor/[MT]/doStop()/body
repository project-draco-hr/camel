{
  if (forceCompletionOnStop) {
    forceCompletionOfAllGroups();
    while (inProgressCompleteExchanges.size() > 0) {
      LOG.trace("waiting for {} in progress exchanges to complete",inProgressCompleteExchanges.size());
      Thread.sleep(100);
    }
  }
  if (recoverService != null) {
    camelContext.getExecutorServiceManager().shutdownNow(recoverService);
  }
  ServiceHelper.stopServices(timeoutMap,processor,deadLetterProducerTemplate);
  if (closedCorrelationKeys != null) {
    ServiceHelper.stopService(closedCorrelationKeys);
    closedCorrelationKeys.clear();
  }
  batchConsumerCorrelationKeys.clear();
  redeliveryState.clear();
}
