{
  String key=correlationExpression.evaluate(exchange,String.class);
  if (ObjectHelper.isEmpty(key)) {
    if (isIgnoreInvalidCorrelationKeys()) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("Invalid correlation key. This Exchange will be ignored: " + exchange);
      }
      return;
    }
 else {
      throw new CamelExchangeException("Invalid correlation key",exchange);
    }
  }
  if (closedCorrelationKeys != null && closedCorrelationKeys.containsKey(key)) {
    throw new ClosedCorrelationKeyException(key,exchange);
  }
  lock.lock();
  try {
    arrivedCorrelationKeys.add(key);
    doAggregation(key,exchange);
  }
  finally {
    arrivedCorrelationKeys.remove(key);
    lock.unlock();
  }
}
