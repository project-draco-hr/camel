{
  Object key=correlationExpression.evaluate(exchange,Object.class);
  if (ObjectHelper.isEmpty(key)) {
    if (isIgnoreBadCorrelationKeys()) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("Correlation key could not be evaluated to a value. Exchange will be ignored: " + exchange);
      }
      return;
    }
 else {
      throw new CamelExchangeException("Correlation key could not be evaluated to a value",exchange);
    }
  }
  if (isCloseCorrelationKeyOnCompletion()) {
    if (closedCorrelationKeys.contains(key)) {
      throw new CamelExchangeException("Correlation key has been closed",exchange);
    }
  }
  doAggregation(key,exchange);
}
