{
  LOG.trace("onAggregation +++ start +++ with correlation key: {}",key);
  Exchange answer;
  Exchange oldExchange=aggregationRepository.get(exchange.getContext(),key);
  Exchange newExchange=exchange;
  Integer size=1;
  if (oldExchange != null) {
    size=oldExchange.getProperty(Exchange.AGGREGATED_SIZE,0,Integer.class);
    size++;
  }
  String complete=null;
  if (isEagerCheckCompletion()) {
    newExchange.setProperty(Exchange.AGGREGATED_SIZE,size);
    complete=isCompleted(key,newExchange);
    newExchange.removeProperty(Exchange.AGGREGATED_SIZE);
  }
  ExchangeHelper.prepareAggregation(oldExchange,newExchange);
  answer=onAggregation(oldExchange,exchange);
  if (answer == null) {
    throw new CamelExchangeException("AggregationStrategy " + aggregationStrategy + " returned null which is not allowed",exchange);
  }
  answer.setProperty(Exchange.AGGREGATED_SIZE,size);
  if (!isEagerCheckCompletion()) {
    complete=isCompleted(key,answer);
  }
  if (complete == null) {
    LOG.trace("In progress aggregated exchange: {} with correlation key: {}",answer,key);
    aggregationRepository.add(exchange.getContext(),key,answer);
  }
 else {
    if ("consumer".equals(complete)) {
      for (      String batchKey : batchConsumerCorrelationKeys) {
        Exchange batchAnswer;
        if (batchKey.equals(key)) {
          batchAnswer=answer;
        }
 else {
          batchAnswer=aggregationRepository.get(camelContext,batchKey);
        }
        if (batchAnswer != null) {
          batchAnswer.setProperty(Exchange.AGGREGATED_COMPLETED_BY,complete);
          onCompletion(batchKey,batchAnswer,false);
        }
      }
      batchConsumerCorrelationKeys.clear();
    }
 else {
      answer.setProperty(Exchange.AGGREGATED_COMPLETED_BY,complete);
      onCompletion(key,answer,false);
    }
  }
  LOG.trace("onAggregation +++  end  +++ with correlation key: {}",key);
  return answer;
}
