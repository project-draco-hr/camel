{
  final org.apache.camel.Message in=exchange.getIn();
  String destinationName=in.getHeader(JmsConstants.JMS_DESTINATION_NAME,String.class);
  if (destinationName != null) {
    in.removeHeader(JmsConstants.JMS_DESTINATION_NAME);
  }
  if (destinationName == null) {
    destinationName=endpoint.getDestinationName();
  }
  Destination destination=in.getHeader(JmsConstants.JMS_DESTINATION,Destination.class);
  if (destination != null) {
    in.removeHeader(JmsConstants.JMS_DESTINATION);
  }
  if (destination == null) {
    destination=endpoint.getDestination();
  }
  if (destination != null) {
    destinationName=null;
  }
  if (!endpoint.isPreserveMessageQos() && !endpoint.isExplicitQosEnabled()) {
    Object replyTo=exchange.getIn().getHeader("JMSReplyTo");
    if (replyTo != null) {
      String to=destinationName != null ? destinationName : "" + destination;
      LOG.warn("Disabling JMSReplyTo as this Exchange is not OUT capable with JMSReplyTo: " + replyTo + " for destination: "+ to+ ". Use preserveMessageQos=true to force Camel to keep the JMSReplyTo."+ " Exchange: "+ exchange);
      exchange.getIn().setHeader("JMSReplyTo",null);
    }
  }
  MessageCreator messageCreator=new MessageCreator(){
    public Message createMessage(    Session session) throws JMSException {
      Message answer=endpoint.getBinding().makeJmsMessage(exchange,in,session,null);
      String replyTo=exchange.getIn().getHeader("JMSReplyTo",String.class);
      if (replyTo != null && answer.getJMSReplyTo() == null) {
        Destination destination=null;
        if (endpoint.getDestinationResolver() != null) {
          destination=endpoint.getDestinationResolver().resolveDestinationName(session,replyTo,endpoint.isPubSubDomain());
        }
        if (destination == null) {
          if (endpoint.isPubSubDomain()) {
            if (LOG.isDebugEnabled()) {
              LOG.debug("Creating JMSReplyTo topic: " + replyTo);
            }
            destination=session.createTopic(replyTo);
          }
 else {
            if (LOG.isDebugEnabled()) {
              LOG.debug("Creating JMSReplyTo queue: " + replyTo);
            }
            destination=session.createQueue(replyTo);
          }
        }
        if (destination != null) {
          if (LOG.isDebugEnabled()) {
            LOG.debug("Using JMSReplyTo destination: " + destination);
          }
          answer.setJMSReplyTo(destination);
        }
      }
      return answer;
    }
  }
;
  doSend(false,destinationName,destination,messageCreator,null);
  setMessageId(exchange);
  callback.done(true);
  return true;
}
