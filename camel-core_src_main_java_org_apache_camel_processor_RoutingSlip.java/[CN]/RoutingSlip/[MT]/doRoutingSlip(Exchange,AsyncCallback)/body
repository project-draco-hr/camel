{
  Exchange current=exchange;
  RoutingSlipIterator iter=createRoutingSlipIterator(exchange);
  if (current.hasProperties()) {
    current.setProperty(Exchange.SLIP_ENDPOINT,null);
  }
  while (iter.hasNext(current)) {
    Endpoint endpoint;
    try {
      endpoint=resolveEndpoint(iter,exchange);
      if (endpoint == null) {
        continue;
      }
    }
 catch (    Exception e) {
      exchange.setException(e);
      return true;
    }
    Exchange copy=prepareExchangeForRoutingSlip(current,endpoint);
    boolean sync=processExchange(endpoint,copy,exchange,callback,iter);
    current=copy;
    if (!sync) {
      if (log.isTraceEnabled()) {
        log.trace("Processing exchangeId: " + exchange.getExchangeId() + " is continued being processed asynchronously");
      }
      return false;
    }
    if (log.isTraceEnabled()) {
      log.trace("Processing exchangeId: " + exchange.getExchangeId() + " is continued being processed synchronously");
    }
    if (isIgnoreInvalidEndpoints()) {
      FailedToCreateProducerException e=current.getException(FailedToCreateProducerException.class);
      if (e != null) {
        log.info("Endpoint uri is invalid: " + endpoint + ". This exception will be ignored.",e);
        current.setException(null);
      }
    }
    if (!continueProcessing(current,"so breaking out of the routing slip",log)) {
      break;
    }
  }
  if (log.isTraceEnabled()) {
    log.trace("Processing complete for exchangeId: " + exchange.getExchangeId() + " >>> "+ current);
  }
  ExchangeHelper.copyResults(exchange,current);
  callback.done(true);
  return true;
}
