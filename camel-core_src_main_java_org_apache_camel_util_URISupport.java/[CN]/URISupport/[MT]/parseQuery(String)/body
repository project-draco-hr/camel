{
  if (uri != null && uri.endsWith("&")) {
    throw new URISyntaxException(uri,"Invalid uri syntax: Trailing & marker found. " + "Check the uri and remove the trailing & marker.");
  }
  try {
    Map<String,Object> rc=new LinkedHashMap<String,Object>();
    if (uri != null) {
      String[] parameters=uri.split("&");
      for (      String parameter : parameters) {
        int p=parameter.indexOf("=");
        if (p >= 0) {
          String name=URLDecoder.decode(parameter.substring(0,p),CHARSET);
          String value=URLDecoder.decode(parameter.substring(p + 1),CHARSET);
          if (rc.containsKey(name)) {
            Object existing=rc.get(name);
            List<String> list;
            if (existing instanceof List) {
              list=CastUtils.cast((List<?>)existing);
            }
 else {
              list=new ArrayList<String>();
              String s=existing != null ? existing.toString() : null;
              if (s != null) {
                list.add(s);
              }
            }
            list.add(value);
            rc.put(name,list);
          }
 else {
            rc.put(name,value);
          }
        }
 else {
          rc.put(parameter,null);
        }
      }
    }
    return rc;
  }
 catch (  UnsupportedEncodingException e) {
    URISyntaxException se=new URISyntaxException(e.toString(),"Invalid encoding");
    se.initCause(e);
    throw se;
  }
}
