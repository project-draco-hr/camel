{
  ObjectHelper.notNull(uri,"uri");
  String s=uri.toString();
  String before=ObjectHelper.before(s,"?");
  if (before == null) {
    before=ObjectHelper.before(s,"#");
  }
  if (before != null) {
    s=before;
  }
  if (query != null) {
    s=s + "?" + query;
  }
  if ((!s.contains("#")) && (uri.getFragment() != null)) {
    s=s + "#" + uri.getFragment();
  }
  return new URI(s);
}
