{
  boolean sync=true;
  Exception caught=exchange.getException();
  exchange.setException(null);
  final boolean shouldHandle=isDeadLetterChannel || shouldHandled(exchange,data);
  final boolean shouldContinue=shouldContinue(exchange,data);
  boolean handled=false;
  if (shouldHandle || shouldContinue) {
    exchange.getIn().removeHeader(Exchange.REDELIVERED);
    exchange.getIn().removeHeader(Exchange.REDELIVERY_COUNTER);
    exchange.getIn().removeHeader(Exchange.REDELIVERY_MAX_COUNTER);
    exchange.removeProperty(Exchange.REDELIVERY_EXHAUSTED);
    exchange.removeProperty(Exchange.ROLLBACK_ONLY);
    exchange.removeProperty(Exchange.UNIT_OF_WORK_EXHAUSTED);
    handled=true;
  }
 else {
    decrementRedeliveryCounter(exchange);
  }
  if (processor != null) {
    if (data.useOriginalInMessage) {
      log.trace("Using the original IN message instead of current");
      Message original=exchange.getUnitOfWork().getOriginalInMessage();
      exchange.setIn(original);
      if (exchange.hasOut()) {
        log.trace("Removing the out message to avoid some uncertain behavior");
        exchange.setOut(null);
      }
    }
    MessageHelper.resetStreamCache(exchange.getIn());
    log.trace("Failure processor {} is processing Exchange: {}",processor,exchange);
    exchange.setProperty(Exchange.FAILURE_ENDPOINT,exchange.getProperty(Exchange.TO_ENDPOINT));
    if (exchange.getUnitOfWork().getRouteContext() != null) {
      exchange.setProperty(Exchange.FAILURE_ROUTE_ID,exchange.getUnitOfWork().getRouteContext().getRoute().getId());
    }
    AsyncProcessor afp=AsyncProcessorConverterHelper.convert(processor);
    sync=AsyncProcessorHelper.process(afp,exchange,new AsyncCallback(){
      public void done(      boolean sync){
        log.trace("Failure processor done: {} processing Exchange: {}",processor,exchange);
        try {
          prepareExchangeAfterFailure(exchange,data,shouldHandle,shouldContinue);
          boolean deadLetterChannel=processor == data.deadLetterProcessor && data.deadLetterProcessor != null;
          EventHelper.notifyExchangeFailureHandled(exchange.getContext(),exchange,processor,deadLetterChannel);
        }
  finally {
          data.sync&=sync;
          callback.done(data.sync);
        }
      }
    }
);
  }
 else {
    try {
      prepareExchangeAfterFailure(exchange,data,shouldHandle,shouldContinue);
    }
  finally {
      callback.done(data.sync);
    }
  }
  String msg="Failed delivery for " + ExchangeHelper.logIds(exchange);
  msg=msg + ". Exhausted after delivery attempt: " + data.redeliveryCounter+ " caught: "+ caught;
  if (processor != null) {
    msg=msg + ". Processed by failure processor: " + processor;
  }
  logFailedDelivery(false,handled,false,exchange,msg,data,null);
  return sync;
}
