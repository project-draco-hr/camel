{
  ExchangeHelper.setFailureHandled(exchange);
  boolean alreadySet=exchange.getProperty(Exchange.ERRORHANDLER_HANDLED) != null;
  if (alreadySet) {
    boolean handled=exchange.getProperty(Exchange.ERRORHANDLER_HANDLED,Boolean.class);
    if (log.isDebugEnabled()) {
      log.debug("This exchange has already been marked for handling: " + handled);
    }
    if (handled) {
      exchange.setException(null);
    }
 else {
      exchange.setException(exchange.getProperty(Exchange.EXCEPTION_CAUGHT,Exception.class));
    }
    return;
  }
  Predicate handledPredicate=data.handledPredicate;
  if (handledPredicate == null || !handledPredicate.matches(exchange)) {
    if (log.isDebugEnabled()) {
      log.debug("This exchange is not handled so its marked as failed: " + exchange);
    }
    exchange.setProperty(Exchange.ERRORHANDLER_HANDLED,Boolean.FALSE);
    exchange.setException(exchange.getProperty(Exchange.EXCEPTION_CAUGHT,Exception.class));
  }
 else {
    if (log.isDebugEnabled()) {
      log.debug("This exchange is handled so its marked as not failed: " + exchange);
    }
    exchange.setProperty(Exchange.ERRORHANDLER_HANDLED,Boolean.TRUE);
  }
}
