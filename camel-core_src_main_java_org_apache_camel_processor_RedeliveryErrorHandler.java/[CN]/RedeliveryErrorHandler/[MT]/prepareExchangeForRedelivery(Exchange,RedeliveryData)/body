{
  if (!redeliveryEnabled) {
    throw new IllegalStateException("Redelivery is not enabled on " + this + ". Make sure you have configured the error handler properly.");
  }
  ObjectHelper.notNull(data.original,"Defensive copy of Exchange is null",this);
  exchange.setException(null);
  exchange.setProperty(Exchange.ROLLBACK_ONLY,null);
  Integer redeliveryCounter=exchange.getIn().getHeader(Exchange.REDELIVERY_COUNTER,Integer.class);
  Integer redeliveryMaxCounter=exchange.getIn().getHeader(Exchange.REDELIVERY_MAX_COUNTER,Integer.class);
  Boolean redelivered=exchange.getIn().getHeader(Exchange.REDELIVERED,Boolean.class);
  exchange.getIn().copyFrom(data.original.getIn());
  exchange.setOut(null);
  MessageHelper.resetStreamCache(exchange.getIn());
  if (redeliveryCounter != null) {
    exchange.getIn().setHeader(Exchange.REDELIVERY_COUNTER,redeliveryCounter);
  }
  if (redeliveryMaxCounter != null) {
    exchange.getIn().setHeader(Exchange.REDELIVERY_MAX_COUNTER,redeliveryMaxCounter);
  }
  if (redelivered != null) {
    exchange.getIn().setHeader(Exchange.REDELIVERED,redelivered);
  }
}
