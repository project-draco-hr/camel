{
  Exception e=exchange.getException();
  exchange.setProperty(Exchange.EXCEPTION_CAUGHT,e);
  OnExceptionDefinition exceptionPolicy=getExceptionPolicy(exchange,e);
  if (exceptionPolicy != null) {
    data.currentRedeliveryPolicy=exceptionPolicy.createRedeliveryPolicy(exchange.getContext(),data.currentRedeliveryPolicy);
    data.handledPredicate=exceptionPolicy.getHandledPolicy();
    data.continuedPredicate=exceptionPolicy.getContinuedPolicy();
    data.retryWhilePredicate=exceptionPolicy.getRetryWhilePolicy();
    data.useOriginalInMessage=exceptionPolicy.isUseOriginalMessage();
    Processor processor=null;
    UnitOfWork uow=exchange.getUnitOfWork();
    if (uow != null && uow.getRouteContext() != null) {
      String routeId=uow.getRouteContext().getRoute().getId();
      processor=exceptionPolicy.getErrorHandler(routeId);
    }
 else     if (!exceptionPolicy.getErrorHandlers().isEmpty()) {
      log.warn("Cannot determine current route from Exchange with id: {}, will fallback and use first error handler.",exchange.getExchangeId());
      processor=exceptionPolicy.getErrorHandlers().iterator().next();
    }
    if (processor != null) {
      data.failureProcessor=processor;
    }
    processor=exceptionPolicy.getOnRedelivery();
    if (processor != null) {
      data.onRedeliveryProcessor=processor;
    }
  }
  if (!ExchangeHelper.isFailureHandled(exchange) && !ExchangeHelper.isUnitOfWorkExhausted(exchange)) {
    String msg="Failed delivery for " + ExchangeHelper.logIds(exchange) + ". On delivery attempt: "+ data.redeliveryCounter+ " caught: "+ e;
    logFailedDelivery(true,false,false,false,exchange,msg,data,e);
  }
  data.redeliveryCounter=incrementRedeliveryCounter(exchange,e,data);
}
