{
  final String nodeId=getNodeId(exchange);
  final String imageId=getImageId(exchange);
  final String group=getGroup(exchange);
  final NodeState queryState=getNodeState(exchange);
  Predicate<ComputeMetadata> predicate=new Predicate<ComputeMetadata>(){
    public boolean apply(    ComputeMetadata metadata){
      if (nodeId != null && !nodeId.equals(metadata.getId())) {
        return false;
      }
      if (metadata instanceof NodeMetadataImpl) {
        Predicate<NodeMetadata> nodeMetadataPredicate=getNodePredicate(exchange);
        if (!nodeMetadataPredicate.apply((NodeMetadataImpl)metadata)) {
          return false;
        }
      }
      return true;
    }
  }
;
  return predicate;
}
