{
  ObjectHelper.notNull(endpoint,"endpoint");
  File file=new File(fileName);
  if (file.exists()) {
    if (endpoint.getFileExist() == GenericFileExist.Ignore) {
      if (LOG.isTraceEnabled()) {
        LOG.trace("An existing file already exists: " + file + ". Ignore and do not override it.");
      }
      return true;
    }
 else     if (endpoint.getFileExist() == GenericFileExist.Fail) {
      throw new GenericFileOperationFailedException("File already exist: " + file + ". Cannot write new file.");
    }
  }
  try {
    File source=null;
    if (exchange.getIn().getBody() instanceof File || exchange.getIn().getBody() instanceof GenericFile) {
      source=exchange.getIn().getBody(File.class);
    }
    if (source != null) {
      File local=exchange.getIn().getHeader(Exchange.FILE_LOCAL_WORK_PATH,File.class);
      if (local != null && local.exists()) {
        boolean renamed=writeFileByLocalWorkPath(local,file);
        if (renamed) {
          keepLastModified(exchange,file);
          exchange.getIn().setHeader(Exchange.FILE_LOCAL_WORK_PATH,null);
          return true;
        }
      }
 else       if (source.exists()) {
        writeFileByFile(source,file);
        keepLastModified(exchange,file);
        return true;
      }
    }
    InputStream in=ExchangeHelper.getMandatoryInBody(exchange,InputStream.class);
    writeFileByStream(in,file);
    keepLastModified(exchange,file);
    return true;
  }
 catch (  IOException e) {
    throw new GenericFileOperationFailedException("Cannot store file: " + file,e);
  }
catch (  InvalidPayloadException e) {
    throw new GenericFileOperationFailedException("Cannot store file: " + file,e);
  }
}
