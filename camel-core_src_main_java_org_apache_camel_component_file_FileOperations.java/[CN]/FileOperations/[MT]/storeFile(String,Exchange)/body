{
  ObjectHelper.notNull(endpoint,"endpoint");
  File file=new File(fileName);
  if (file.exists()) {
    if (endpoint.getFileExist() == GenericFileExist.Ignore) {
      LOG.trace("An existing file already exists: {}. Ignore and do not override it.",file);
      return true;
    }
 else     if (endpoint.getFileExist() == GenericFileExist.Fail) {
      throw new GenericFileOperationFailedException("File already exist: " + file + ". Cannot write new file.");
    }
 else     if (endpoint.getFileExist() == GenericFileExist.Move) {
      doMoveExistingFile(fileName);
    }
  }
  if (exchange.getIn().getBody() == null) {
    if (endpoint.isAllowNullBody()) {
      LOG.trace("Writing empty file.");
      try {
        writeFileEmptyBody(file);
        return true;
      }
 catch (      IOException e) {
        throw new GenericFileOperationFailedException("Cannot store file: " + file,e);
      }
    }
 else {
      throw new GenericFileOperationFailedException("Cannot write null body to file: " + file);
    }
  }
  try {
    String charset=endpoint.getCharset();
    File source=null;
    boolean fileBased=false;
    if (charset == null) {
      Object body=exchange.getIn().getBody();
      if (body instanceof WrappedFile) {
        body=((WrappedFile<?>)body).getFile();
      }
      if (body instanceof File) {
        source=(File)body;
        fileBased=true;
      }
    }
    if (fileBased) {
      File local=exchange.getIn().getHeader(Exchange.FILE_LOCAL_WORK_PATH,File.class);
      if (local != null && local.exists()) {
        boolean renamed=writeFileByLocalWorkPath(local,file);
        if (renamed) {
          keepLastModified(exchange,file);
          if (ObjectHelper.isNotEmpty(endpoint.getChmod())) {
            Set<PosixFilePermission> permissions=endpoint.getPermissions();
            if (!permissions.isEmpty()) {
              if (LOG.isTraceEnabled()) {
                LOG.trace("Setting chmod: {} on file: {} ",PosixFilePermissions.toString(permissions),file);
              }
              Files.setPosixFilePermissions(file.toPath(),permissions);
            }
          }
          exchange.getIn().setHeader(Exchange.FILE_LOCAL_WORK_PATH,null);
          return true;
        }
      }
 else       if (source != null && source.exists()) {
        writeFileByFile(source,file);
        keepLastModified(exchange,file);
        if (ObjectHelper.isNotEmpty(endpoint.getChmod())) {
          Set<PosixFilePermission> permissions=endpoint.getPermissions();
          if (!permissions.isEmpty()) {
            if (LOG.isTraceEnabled()) {
              LOG.trace("Setting chmod: {} on file: {} ",PosixFilePermissions.toString(permissions),file);
            }
            Files.setPosixFilePermissions(file.toPath(),permissions);
          }
        }
        return true;
      }
    }
    if (charset != null) {
      Reader in=exchange.getContext().getTypeConverter().tryConvertTo(Reader.class,exchange,exchange.getIn().getBody());
      if (in == null) {
        InputStream is=exchange.getIn().getMandatoryBody(InputStream.class);
        in=new InputStreamReader(is);
      }
      in=IOHelper.buffered(in);
      writeFileByReaderWithCharset(in,file,charset);
    }
 else {
      InputStream in=exchange.getIn().getMandatoryBody(InputStream.class);
      writeFileByStream(in,file);
    }
    keepLastModified(exchange,file);
    if (ObjectHelper.isNotEmpty(endpoint.getChmod())) {
      Set<PosixFilePermission> permissions=endpoint.getPermissions();
      if (!permissions.isEmpty()) {
        if (LOG.isTraceEnabled()) {
          LOG.trace("Setting chmod: {} on file: {} ",PosixFilePermissions.toString(permissions),file);
        }
        Files.setPosixFilePermissions(file.toPath(),permissions);
      }
    }
    return true;
  }
 catch (  IOException e) {
    throw new GenericFileOperationFailedException("Cannot store file: " + file,e);
  }
catch (  InvalidPayloadException e) {
    throw new GenericFileOperationFailedException("Cannot store file: " + file,e);
  }
}
