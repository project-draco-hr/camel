{
  String url=HttpHelper.createURL(exchange,getEndpoint());
  URI uri=HttpHelper.createURI(exchange,url,getEndpoint());
  url=uri.toASCIIString();
  String queryString=uri.getRawQuery();
  String rewriteUrl=HttpHelper.urlRewrite(exchange,url,getEndpoint(),this);
  if (rewriteUrl != null) {
    url=rewriteUrl;
    uri=new URI(url);
    queryString=uri.getRawQuery();
  }
  if (url.indexOf('?') != -1) {
    url=url.substring(0,url.indexOf('?'));
  }
  RequestEntity requestEntity=createRequestEntity(exchange);
  HttpMethods methodToUse=HttpMethodsHelper.createMethod(exchange,getEndpoint(),requestEntity != null);
  HttpMethod method=methodToUse.createMethod(url);
  if (queryString != null) {
    queryString=UnsafeUriCharactersEncoder.encode(queryString);
    method.setQueryString(queryString);
  }
  LOG.trace("Using URL: {} with method: {}",url,method);
  if (methodToUse.isEntityEnclosing()) {
    ((EntityEnclosingMethod)method).setRequestEntity(requestEntity);
    if (requestEntity != null && requestEntity.getContentType() == null) {
      LOG.debug("No Content-Type provided for URL: {} with exchange: {}",url,exchange);
    }
  }
  if (method.getHostConfiguration().getHost() == null) {
    throw new IllegalArgumentException("Invalid uri: " + url + ". If you are forwarding/bridging http endpoints, then enable the bridgeEndpoint option on the endpoint: "+ getEndpoint());
  }
  return method;
}
