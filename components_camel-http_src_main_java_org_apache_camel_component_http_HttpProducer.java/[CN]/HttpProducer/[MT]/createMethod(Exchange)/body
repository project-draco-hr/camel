{
  String queryString=exchange.getIn().getHeader(QUERY,String.class);
  if (queryString == null) {
    queryString=((HttpEndpoint)getEndpoint()).getHttpUri().getQuery();
  }
  RequestEntity requestEntity=createRequestEntity(exchange);
  HttpMethods methodToUse;
  HttpMethods m=exchange.getIn().getHeader(HTTP_METHOD,HttpMethods.class);
  if (m != null) {
    methodToUse=m;
  }
 else   if (queryString != null) {
    methodToUse=HttpMethods.GET;
  }
 else {
    methodToUse=requestEntity != null ? HttpMethods.POST : HttpMethods.GET;
  }
  String uri=exchange.getIn().getHeader(HTTP_URI,String.class);
  if (uri == null) {
    uri=((HttpEndpoint)getEndpoint()).getHttpUri().toString();
  }
  HttpMethod method=methodToUse.createMethod(uri);
  if (queryString != null) {
    method.setQueryString(queryString);
  }
  if (methodToUse.isEntityEnclosing()) {
    ((EntityEnclosingMethod)method).setRequestEntity(requestEntity);
  }
  return method;
}
