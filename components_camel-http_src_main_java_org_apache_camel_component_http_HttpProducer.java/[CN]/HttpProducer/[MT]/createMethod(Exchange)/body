{
  String queryString=exchange.getIn().getHeader(Exchange.HTTP_QUERY,String.class);
  if (queryString == null) {
    queryString=((HttpEndpoint)getEndpoint()).getHttpUri().getQuery();
  }
  RequestEntity requestEntity=createRequestEntity(exchange);
  HttpMethods methodToUse;
  HttpMethods m=exchange.getIn().getHeader(Exchange.HTTP_METHOD,HttpMethods.class);
  if (m != null) {
    methodToUse=m;
  }
 else   if (queryString != null) {
    methodToUse=HttpMethods.GET;
  }
 else {
    methodToUse=requestEntity != null ? HttpMethods.POST : HttpMethods.GET;
  }
  String uri=null;
  if (!((HttpEndpoint)getEndpoint()).isBridgeEndpoint()) {
    uri=exchange.getIn().getHeader(Exchange.HTTP_URI,String.class);
  }
  if (uri == null) {
    uri=((HttpEndpoint)getEndpoint()).getHttpUri().toString();
  }
  String path=exchange.getIn().getHeader(Exchange.HTTP_PATH,String.class);
  if (path != null) {
    if (!uri.endsWith("/")) {
      uri=uri + "/";
    }
    if (path.startsWith("/")) {
      path=path.substring(1);
    }
    uri=uri.concat(path);
  }
  HttpMethod method=methodToUse.createMethod(uri);
  if (queryString != null) {
    method.setQueryString(queryString);
  }
  if (methodToUse.isEntityEnclosing()) {
    ((EntityEnclosingMethod)method).setRequestEntity(requestEntity);
    if (requestEntity != null && requestEntity.getContentType() == null) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("No Content-Type provided for URI: " + uri + " with exchange: "+ exchange);
      }
    }
  }
  return method;
}
