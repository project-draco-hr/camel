{
  Collection<Attachment> atts=setupAttachmentOutput(message);
  List<Object> outObjects=CastUtils.cast(message.getContent(List.class));
  for (  MessagePartInfo mpi : sbi.getAttachments()) {
    String partName=mpi.getConcreteName().getLocalPart();
    String ct=(String)mpi.getProperty(Message.CONTENT_TYPE);
    String id=new StringBuilder().append(partName).append("=").append(UUID.randomUUID()).append("@apache.org").toString();
    int idx=mpi.getIndex();
    Object o=outObjects.get(idx);
    if (o == null) {
      continue;
    }
    outObjects.set(idx,null);
    DataHandler dh=null;
    if (o instanceof Source) {
      dh=new DataHandler(createDataSource((Source)o,ct));
    }
 else     if (o instanceof Image) {
      ByteArrayOutputStream bos=new ByteArrayOutputStream(2048);
      Iterator<ImageWriter> writers=ImageIO.getImageWritersByMIMEType(ct);
      if (writers.hasNext()) {
        ImageWriter writer=writers.next();
        try {
          BufferedImage bimg=convertToBufferedImage((Image)o);
          ImageOutputStream out=ImageIO.createImageOutputStream(bos);
          writer.setOutput(out);
          writer.write(bimg);
          writer.dispose();
          out.flush();
          out.close();
          bos.close();
        }
 catch (        IOException e) {
          throw new Fault(e);
        }
      }
 else {
        throw new Fault(new org.apache.cxf.common.i18n.Message("ATTACHMENT_NOT_SUPPORTED",LOG,ct));
      }
      dh=new DataHandler(new ByteArrayDataSource(bos.toByteArray(),ct));
    }
 else     if (o instanceof DataHandler) {
      dh=(DataHandler)o;
      ct=dh.getContentType();
      try {
        if ("text/xml".equals(ct) && dh.getContent() instanceof Source) {
          dh=new DataHandler(createDataSource((Source)dh.getContent(),ct));
        }
      }
 catch (      IOException e) {
      }
    }
 else     if (o instanceof byte[]) {
      if (ct == null) {
        ct="application/octet-stream";
      }
      dh=new DataHandler(new ByteArrayDataSource((byte[])o,ct));
    }
 else     if (o instanceof String) {
      if (ct == null) {
        ct="text/plain; charset=\'UTF-8\'";
      }
      try {
        dh=new DataHandler(new ByteArrayDataSource((String)o,ct));
      }
 catch (      IOException e) {
        throw new Fault(e);
      }
    }
 else {
      throw new Fault(new org.apache.cxf.common.i18n.Message("ATTACHMENT_NOT_SUPPORTED",LOG,o.getClass()));
    }
    AttachmentImpl att=new AttachmentImpl(id);
    att.setDataHandler(dh);
    att.setHeader("Content-Type",ct);
    atts.add(att);
  }
}
