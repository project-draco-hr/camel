{
  int total=exchanges.size();
  if (maxMessagesPerPoll > 0 && total > maxMessagesPerPoll) {
    log.debug("Limiting to maximum messages to poll " + maxMessagesPerPoll + " as there was "+ total+ " messages in this poll.");
    total=maxMessagesPerPoll;
  }
  for (int index=0; index < total && isRunAllowed(); index++) {
    GenericFileExchange<T> exchange=(GenericFileExchange<T>)exchanges.poll();
    exchange.setProperty(Exchange.BATCH_INDEX,index);
    exchange.setProperty(Exchange.BATCH_SIZE,total);
    exchange.setProperty(Exchange.BATCH_COMPLETE,index == total - 1);
    processExchange(exchange);
  }
  for (int index=0; index < exchanges.size() && isRunAllowed(); index++) {
    GenericFileExchange<T> exchange=(GenericFileExchange<T>)exchanges.poll();
    String key=exchange.getGenericFile().getFileName();
    endpoint.getInProgressRepository().remove(key);
  }
}
