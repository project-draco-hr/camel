{
  GenericFile<T> file=getExchangeFileProperty(exchange);
  log.trace("Processing file: {}",file);
  String absoluteFileName=file.getAbsoluteFilePath();
  try {
    final GenericFileProcessStrategy<T> processStrategy=endpoint.getGenericFileProcessStrategy();
    boolean begin=processStrategy.begin(operations,endpoint,exchange,file);
    if (!begin) {
      log.debug("{} cannot begin processing file: {}",endpoint,file);
      try {
        processStrategy.abort(operations,endpoint,exchange,file);
      }
  finally {
        endpoint.getInProgressRepository().remove(absoluteFileName);
      }
      return;
    }
  }
 catch (  Exception e) {
    endpoint.getInProgressRepository().remove(absoluteFileName);
    String msg=endpoint + " cannot begin processing file: " + file+ " due to: "+ e.getMessage();
    handleException(msg,e);
    return;
  }
  final GenericFile<T> target=getExchangeFileProperty(exchange);
  final String name=target.getAbsoluteFilePath();
  try {
    if (isRetrieveFile()) {
      log.trace("Retrieving file: {} from: {}",name,endpoint);
      boolean retrieved=operations.retrieveFile(name,exchange);
      if (!retrieved) {
        throw new GenericFileOperationFailedException("Cannot retrieve file: " + file + " from: "+ endpoint);
      }
      log.trace("Retrieved file: {} from: {}",name,endpoint);
    }
 else {
      log.trace("Skipped retrieval of file: {} from: {}",name,endpoint);
      exchange.getIn().setBody(null);
    }
    exchange.addOnCompletion(new GenericFileOnCompletion<T>(endpoint,operations,target,absoluteFileName));
    log.debug("About to process file: {} using exchange: {}",target,exchange);
    getAsyncProcessor().process(exchange,new AsyncCallback(){
      public void done(      boolean doneSync){
        if (log.isTraceEnabled()) {
          log.trace("Done processing file: {} {}",target,doneSync ? "synchronously" : "asynchronously");
        }
      }
    }
);
  }
 catch (  Exception e) {
    endpoint.getInProgressRepository().remove(absoluteFileName);
    String msg="Error processing file " + file + " due to "+ e.getMessage();
    handleException(msg,e);
  }
}
