{
  if (bundleContext != null) {
    registry=new OsgiServiceRegistry(bundleContext);
    context=new OsgiDefaultCamelContext(bundleContext,registry);
    context.setApplicationContextClassLoader(new BundleDelegatingClassLoader(bundleContext.getBundle()));
    Thread.currentThread().setContextClassLoader(context.getApplicationContextClassLoader());
  }
 else {
    registry=new SimpleRegistry();
    context=new DefaultCamelContext(registry);
  }
  setupPropertiesComponent(context,props,log);
}
