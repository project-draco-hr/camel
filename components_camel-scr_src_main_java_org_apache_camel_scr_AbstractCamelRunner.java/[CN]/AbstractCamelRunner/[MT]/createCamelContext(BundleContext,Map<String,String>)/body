{
  if (bundleContext != null) {
    context=new OsgiDefaultCamelContext(bundleContext,registry);
    context.setApplicationContextClassLoader(new BundleDelegatingClassLoader(bundleContext.getBundle()));
    Thread.currentThread().setContextClassLoader(context.getApplicationContextClassLoader());
  }
 else {
    context=new DefaultCamelContext(registry);
  }
  setupPropertiesComponent(context,props,log);
  String name=props.remove("camelContextId");
  if (name != null) {
    context.setNameStrategy(new ExplicitCamelContextNameStrategy(name));
  }
  context.getManagementStrategy().addEventNotifier(new OsgiCamelContextPublisher(bundleContext));
}
