{
  CamelConnectionFactory factory=getMandatoryBean(CamelConnectionFactory.class,"connectionFactory");
  CamelContext context=factory.getCamelContext();
  assertNotNull("Should have a CamelContext!",context);
  MockEndpoint result=context.getEndpoint("mock:result",MockEndpoint.class);
  assertNotNull("Should have a MockEndpoint!",result);
  result.expectedBodiesReceived(expectedBody);
  result.message(0).header("foo").isEqualTo("bar");
  Connection connection=factory.createConnection();
  connection.start();
  Session session=connection.createSession(false,Session.AUTO_ACKNOWLEDGE);
  CamelQueue destination=new CamelQueue("mock:result");
  destination.setCamelContext(context);
  MessageProducer producer=session.createProducer(destination);
  ObjectMessage message=session.createObjectMessage(expectedBody);
  message.setStringProperty("foo","bar");
  producer.send(message);
  result.assertIsSatisfied();
  log.info("Received message: " + result.getReceivedExchanges());
}
