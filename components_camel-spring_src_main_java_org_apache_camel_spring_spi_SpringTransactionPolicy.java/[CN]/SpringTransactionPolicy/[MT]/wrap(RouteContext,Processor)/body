{
  TransactionErrorHandler answer;
  ErrorHandlerBuilder builder=routeContext.getRoute().getErrorHandlerBuilder();
  if (builder instanceof ErrorHandlerBuilderRef) {
    ErrorHandlerBuilderRef builderRef=(ErrorHandlerBuilderRef)builder;
    String ref=builderRef.getRef();
    if (ErrorHandlerBuilderRef.isErrorHandlerBuilderConfigued(ref)) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("Looking up ErrorHandlerBuilder with ref: " + ref);
      }
      builder=ErrorHandlerBuilderRef.lookupErrorHandlerBuilder(routeContext,ref);
    }
  }
  if (builder != null && builder.supportTransacted()) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("The ErrorHandlerBuilder configured is already a TransactionErrorHandlerBuilder: " + builder);
    }
    answer=createTransactionErrorHandler(routeContext,processor,builder);
    answer.setExceptionPolicy(builder.getExceptionPolicyStrategy());
    builder.configure(answer);
  }
 else {
    if (LOG.isDebugEnabled()) {
      if (builder != null) {
        LOG.debug("The ErrorHandlerBuilder configured is not a TransactionErrorHandlerBuilder: " + builder);
      }
 else {
        LOG.debug("No ErrorHandlerBuilder configured, will use default TransactionErrorHandlerBuilder settings");
      }
    }
    TransactionErrorHandlerBuilder txBuilder=new TransactionErrorHandlerBuilder();
    txBuilder.setTransactionTemplate(getTransactionTemplate());
    txBuilder.setSpringTransactionPolicy(this);
    if (builder != null) {
      txBuilder.setErrorHandlers(builder.getErrorHandlers());
    }
    answer=createTransactionErrorHandler(routeContext,processor,txBuilder);
    answer.setExceptionPolicy(txBuilder.getExceptionPolicyStrategy());
    txBuilder.configure(answer);
    routeContext.getRoute().setErrorHandlerBuilder(txBuilder);
  }
  return answer;
}
