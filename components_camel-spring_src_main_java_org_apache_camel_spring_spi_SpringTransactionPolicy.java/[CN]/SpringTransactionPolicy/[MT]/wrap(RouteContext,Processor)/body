{
  final TransactionTemplate transactionTemplate=getTransactionTemplate();
  if (transactionTemplate == null) {
    LOG.warn("No TransactionTemplate available so transactions will not be enabled!");
    return processor;
  }
  TransactionErrorHandler answer=new TransactionErrorHandler(transactionTemplate);
  answer.setOutput(processor);
  ErrorHandlerBuilder builder=routeContext.getRoute().getErrorHandlerBuilder();
  if (builder instanceof ErrorHandlerBuilderRef) {
    ErrorHandlerBuilderRef ref=(ErrorHandlerBuilderRef)builder;
    if (LOG.isDebugEnabled()) {
      LOG.debug("Looking up errorHandlerRef: " + ref.getRef());
    }
    builder=ref.lookupErrorHandlerBuilder(routeContext);
  }
  if (builder instanceof TransactionErrorHandlerBuilder) {
    TransactionErrorHandlerBuilder txBuilder=(TransactionErrorHandlerBuilder)builder;
    answer.setExceptionPolicy(txBuilder.getExceptionPolicyStrategy());
    answer.setDelayPolicy(txBuilder.getDelayPolicy());
    txBuilder.configure(answer);
  }
 else {
    LOG.warn("No TransactionErrorHandler defined so exception policies will not be enabled!");
  }
  return answer;
}
