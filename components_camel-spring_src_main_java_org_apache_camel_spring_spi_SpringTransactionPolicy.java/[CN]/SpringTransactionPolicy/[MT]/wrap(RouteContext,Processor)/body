{
  TransactionErrorHandler answer=new TransactionErrorHandler(getTransactionTemplate());
  answer.setOutput(processor);
  ErrorHandlerBuilder builder=routeContext.getRoute().getErrorHandlerBuilder();
  if (builder instanceof ErrorHandlerBuilderRef) {
    ErrorHandlerBuilderRef ref=(ErrorHandlerBuilderRef)builder;
    if (LOG.isDebugEnabled()) {
      LOG.debug("Looking up ErrorHandlerBuilder with ref: " + ref.getRef());
    }
    builder=ref.lookupErrorHandlerBuilder(routeContext);
  }
  if (builder instanceof TransactionErrorHandlerBuilder) {
    TransactionErrorHandlerBuilder txBuilder=(TransactionErrorHandlerBuilder)builder;
    answer.setExceptionPolicy(txBuilder.getExceptionPolicyStrategy());
    answer.setDelayPolicy(txBuilder.getDelayPolicy());
    txBuilder.configure(answer);
  }
 else {
    if (builder != null && LOG.isDebugEnabled()) {
      LOG.debug("The ErrorHandlerBuilder configured is not a TransactionErrorHandlerBuilder: " + builder);
    }
 else {
      LOG.debug("No ErrorHandlerBuilder configured, will use default TransactionErrorHandlerBuilder settings");
    }
    TransactionErrorHandlerBuilder txBuilder=new TransactionErrorHandlerBuilder();
    txBuilder.setTransactionTemplate(getTransactionTemplate());
    txBuilder.setSpringTransactionPolicy(this);
    if (builder != null) {
      txBuilder.setErrorHandlers(builder.getErrorHandlers());
    }
    answer.setExceptionPolicy(txBuilder.getExceptionPolicyStrategy());
    answer.setDelayPolicy(txBuilder.getDelayPolicy());
    txBuilder.configure(answer);
  }
  return answer;
}
