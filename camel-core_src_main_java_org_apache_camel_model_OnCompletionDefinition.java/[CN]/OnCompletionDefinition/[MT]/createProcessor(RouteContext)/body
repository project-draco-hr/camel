{
  Processor childProcessor=createOutputsProcessor(routeContext);
  childProcessor=new UnitOfWorkProcessor(routeContext,childProcessor);
  Predicate when=null;
  if (onWhen != null) {
    when=onWhen.getExpression().createPredicate(routeContext);
  }
  if (onCompleteOnly && onFailureOnly) {
    throw new IllegalArgumentException("Both onCompleteOnly and onFailureOnly cannot be true. Only one of them can be true. On node: " + this);
  }
  if (executorServiceRef != null) {
    executorService=routeContext.lookup(executorServiceRef,ExecutorService.class);
    if (executorService == null) {
      throw new IllegalArgumentException("ExecutorServiceRef " + executorServiceRef + " not found in registry.");
    }
  }
  OnCompletionProcessor answer=new OnCompletionProcessor(routeContext.getCamelContext(),childProcessor,onCompleteOnly,onFailureOnly,when);
  answer.setExecutorService(executorService);
  return answer;
}
