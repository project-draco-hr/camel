{
  shutdownRunningTask=null;
  pendingExchanges=0;
  int polledMessages=0;
  ensureIsConnected();
  if (store == null || folder == null) {
    throw new IllegalStateException("MailConsumer did not connect properly to the MailStore: " + getEndpoint().getConfiguration().getMailStoreLogInformation());
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Polling mailbox folder: " + getEndpoint().getConfiguration().getMailStoreLogInformation());
  }
  if (getEndpoint().getConfiguration().getFetchSize() == 0) {
    LOG.warn("Fetch size is 0 meaning the configuration is set to poll no new messages at all. Camel will skip this poll.");
    return 0;
  }
  if (!folder.isOpen()) {
    folder.open(Folder.READ_WRITE);
  }
  try {
    int count=folder.getMessageCount();
    if (count > 0) {
      Message[] messages;
      if (getEndpoint().getSearchTerm() != null) {
        messages=folder.search(getEndpoint().getSearchTerm());
      }
 else       if (getEndpoint().getConfiguration().isUnseen()) {
        messages=folder.search(new SearchTermBuilder().unseen().build());
      }
 else {
        messages=folder.getMessages();
      }
      polledMessages=processBatch(CastUtils.cast(createExchanges(messages)));
    }
 else     if (count == -1) {
      throw new MessagingException("Folder: " + folder.getFullName() + " is closed");
    }
  }
 catch (  Exception e) {
    handleException(e);
  }
 finally {
    try {
      if (folder.isOpen()) {
        folder.close(true);
      }
    }
 catch (    Exception e) {
      LOG.debug("Could not close mailbox folder: " + folder.getName(),e);
    }
  }
  boolean disconnect=getEndpoint().getConfiguration().isDisconnect();
  if (disconnect) {
    LOG.debug("Disconnecting from {}",getEndpoint().getConfiguration().getMailStoreLogInformation());
    try {
      store.close();
    }
 catch (    Exception e) {
      LOG.debug("Could not disconnect from {}: " + getEndpoint().getConfiguration().getMailStoreLogInformation(),e);
    }
    store=null;
    folder=null;
  }
  return polledMessages;
}
