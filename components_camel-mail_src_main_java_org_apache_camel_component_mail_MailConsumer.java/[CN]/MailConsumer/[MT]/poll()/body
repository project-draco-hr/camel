{
  if (LOG.isDebugEnabled()) {
    LOG.debug("Polling mailfolder " + folder.getFullName() + " at host "+ endpoint.getConfiguration().getHost()+ ":"+ endpoint.getConfiguration().getPort());
  }
  if (endpoint.getConfiguration().getFetchSize() == 0) {
    LOG.warn("Fetch size is 0 meaning the configuration is set to poll no new messages at all. Camel will skip this poll.");
    return;
  }
  if (!folder.isOpen()) {
    folder.open(Folder.READ_WRITE);
  }
  try {
    int count=folder.getMessageCount();
    if (count > 0) {
      Message[] messages;
      if (endpoint.getConfiguration().isProcessOnlyUnseenMessages()) {
        messages=folder.search(new FlagTerm(new Flags(Flags.Flag.SEEN),false));
      }
 else {
        messages=folder.getMessages();
      }
      processMessages(messages);
    }
 else     if (count == -1) {
      throw new MessagingException("Folder: " + folder.getFullName() + " is closed");
    }
  }
  finally {
    if (folder.isOpen()) {
      folder.close(true);
    }
  }
}
