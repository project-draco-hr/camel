{
  ensureIsConnected();
  if (store == null || folder == null) {
    throw new IllegalStateException("MailConsumer did not connect properly to the MailStore: " + endpoint.getConfiguration().getMailStoreLogInformation());
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Polling mailfolder: " + endpoint.getConfiguration().getMailStoreLogInformation());
  }
  if (endpoint.getConfiguration().getFetchSize() == 0) {
    LOG.warn("Fetch size is 0 meaning the configuration is set to poll no new messages at all. Camel will skip this poll.");
    return;
  }
  if (!folder.isOpen()) {
    folder.open(Folder.READ_WRITE);
  }
  try {
    int count=folder.getMessageCount();
    if (count > 0) {
      Message[] messages;
      if (endpoint.getConfiguration().isUnseen()) {
        messages=folder.search(new FlagTerm(new Flags(Flags.Flag.SEEN),false));
      }
 else {
        messages=folder.getMessages();
      }
      processBatch(CastUtils.cast(createExchanges(messages)));
    }
 else     if (count == -1) {
      throw new MessagingException("Folder: " + folder.getFullName() + " is closed");
    }
  }
 catch (  Exception e) {
    handleException(e);
  }
 finally {
    try {
      if (folder.isOpen()) {
        folder.close(true);
      }
    }
 catch (    Exception e) {
      LOG.debug("Could not close mailbox folder: " + folder.getName(),e);
    }
  }
}
