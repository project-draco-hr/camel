{
  MailConfiguration config=endpoint.getConfiguration();
  if (store == null || !store.isConnected()) {
    store=sender.getSession().getStore(config.getProtocol());
    if (LOG.isDebugEnabled()) {
      LOG.debug("Connecting to MailStore at host " + config.getHost() + " on port "+ config.getPort());
    }
    store.connect(config.getHost(),config.getPort(),config.getUsername(),config.getPassword());
  }
  if (folder == null) {
    folder=store.getFolder(config.getFolderName());
    if (folder == null || !folder.exists()) {
      throw new FolderNotFoundException(folder,"Folder not found or invalid: " + config.getFolderName());
    }
  }
}
