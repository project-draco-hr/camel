{
  try {
    if (!folder.isOpen()) {
      folder.open(Folder.READ_WRITE);
    }
    String uid=(String)exchange.removeProperty(POP3_UID);
    if (uid != null) {
      int count=folder.getMessageCount();
      Message found=null;
      LOG.trace("Looking for POP3Message with UID {} from folder with {} mails",uid,count);
      for (int i=1; i <= count; ++i) {
        Message msg=folder.getMessage(i);
        if (uid.equals(generatePop3Uid(msg))) {
          LOG.debug("Found POP3Message with UID {} from folder with {} mails",uid,count);
          found=msg;
          break;
        }
      }
      if (found == null) {
        boolean delete=getEndpoint().getConfiguration().isDelete();
        LOG.warn("POP3message not found in folder. Message cannot be marked as " + (delete ? "DELETED" : "SEEN"));
      }
 else {
        mail=found;
      }
    }
    org.apache.camel.Message in=exchange.getIn();
    MailConfiguration config=getEndpoint().getConfiguration();
    String copyTo=in.getHeader("copyTo",config.getCopyTo(),String.class);
    boolean delete=in.getHeader("delete",config.isDelete(),boolean.class);
    if (config.getProtocol().equals(MailUtils.PROTOCOL_IMAP) || config.getProtocol().equals(MailUtils.PROTOCOL_IMAPS)) {
      if (copyTo != null) {
        LOG.trace("IMAP message needs to be copied to {}",copyTo);
        Folder destFolder=store.getFolder(copyTo);
        if (!destFolder.exists()) {
          destFolder.create(Folder.HOLDS_MESSAGES);
        }
        folder.copyMessages(new Message[]{mail},destFolder);
        LOG.trace("IMAP message {} copied to {}",mail,copyTo);
      }
    }
    if (delete) {
      LOG.trace("Exchange processed, so flagging message as DELETED");
      mail.setFlag(Flags.Flag.DELETED,true);
    }
 else {
      LOG.trace("Exchange processed, so flagging message as SEEN");
      mail.setFlag(Flags.Flag.SEEN,true);
    }
  }
 catch (  MessagingException e) {
    getExceptionHandler().handleException("Error occurred during committing mail message: " + mail,exchange,e);
  }
}
