{
  Exchange exchange=consumer.endpoint.createRabbitExchange(envelope,properties,body);
  mergeAmqpProperties(exchange,properties);
  log.trace("Created exchange [exchange={}]",exchange);
  long deliveryTag=envelope.getDeliveryTag();
  try {
    consumer.getProcessor().process(exchange);
  }
 catch (  Exception e) {
    exchange.setException(e);
  }
  if (!exchange.isFailed()) {
    if (!consumer.endpoint.isAutoAck()) {
      log.trace("Acknowledging receipt [delivery_tag={}]",deliveryTag);
      channel.basicAck(deliveryTag,false);
    }
  }
 else {
    if (deliveryTag != 0 && !consumer.endpoint.isAutoAck()) {
      channel.basicReject(deliveryTag,false);
    }
    if (exchange.getException() != null) {
      getExceptionHandler().handleException("Error processing exchange",exchange,exchange.getException());
    }
  }
}
