{
  order.set(0);
  final CountDownLatch latch=new CountDownLatch(1);
  template.asyncCallback("direct:echo",new Processor(){
    public void process(    Exchange exchange) throws Exception {
      exchange.getIn().setBody("Hello");
      exchange.setPattern(ExchangePattern.InOut);
    }
  }
,new SynchronizationAdapter(){
    @Override public void onDone(    Exchange exchange){
      order.addAndGet(2);
      assertEquals("HelloHello",exchange.getOut().getBody());
      latch.countDown();
    }
  }
);
  order.addAndGet(1);
  latch.await(10,TimeUnit.SECONDS);
  order.addAndGet(4);
  assertEquals(7,order.get());
}
