{
  NettyConfiguration config;
  if (getConfiguration() != null) {
    config=getConfiguration().copy();
  }
 else {
    config=new NettyHttpConfiguration();
  }
  NettyServerBootstrapConfiguration bootstrapConfiguration=resolveAndRemoveReferenceParameter(parameters,"bootstrapConfiguration",NettyServerBootstrapConfiguration.class);
  if (bootstrapConfiguration != null) {
    Map<String,Object> options=new HashMap<String,Object>();
    if (IntrospectionSupport.getProperties(bootstrapConfiguration,options,null,false)) {
      IntrospectionSupport.setProperties(getCamelContext().getTypeConverter(),config,options);
    }
  }
  NettyHttpSecurityConfiguration securityConfiguration=resolveAndRemoveReferenceParameter(parameters,"securityConfiguration",NettyHttpSecurityConfiguration.class);
  String realm=getAndRemoveParameter(parameters,"realm",String.class);
  if (securityConfiguration != null && realm != null) {
    throw new IllegalArgumentException("Cannot have both realm and securityConfiguration options configured");
  }
 else   if (realm != null) {
    securityConfiguration=new NettyHttpSecurityConfiguration();
    securityConfiguration.setRealm(realm);
  }
  config=parseConfiguration(config,remaining,parameters);
  config.validateConfiguration();
  NettySharedHttpServer shared=resolveAndRemoveReferenceParameter(parameters,"nettySharedHttpServer",NettySharedHttpServer.class);
  if (shared != null) {
    LOG.debug("Using NettySharedHttpServer: {} with port: {}",shared,shared.getPort());
    config.setPort(shared.getPort());
  }
  NettyHttpEndpoint answer=new NettyHttpEndpoint(remaining,this,config);
  answer.setTimer(getTimer());
  setProperties(answer.getConfiguration(),parameters);
  if (!parameters.isEmpty()) {
    String query=URISupport.createQueryString(parameters);
    answer.setUriParameters(query);
  }
  if (answer.getNettyHttpBinding() == null) {
    answer.setNettyHttpBinding(getNettyHttpBinding());
  }
  if (answer.getHeaderFilterStrategy() == null) {
    answer.setHeaderFilterStrategy(getHeaderFilterStrategy());
  }
  if (securityConfiguration != null) {
    answer.setSecurityConfiguration(securityConfiguration);
  }
 else   if (answer.getSecurityConfiguration() == null) {
    answer.setSecurityConfiguration(getSecurityConfiguration());
  }
  answer.setNettySharedHttpServer(shared);
  return answer;
}
