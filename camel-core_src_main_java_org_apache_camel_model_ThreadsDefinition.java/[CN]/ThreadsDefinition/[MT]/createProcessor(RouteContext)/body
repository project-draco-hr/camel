{
  if (executorService == null && executorServiceRef != null) {
    executorService=routeContext.lookup(executorServiceRef,ExecutorService.class);
    if (executorService == null) {
      throw new IllegalArgumentException("ExecutorServiceRef " + executorServiceRef + " not found in registry.");
    }
  }
  if (executorService == null) {
    String name=getThreadName() != null ? getThreadName() : "Threads";
    if (poolSize == null || poolSize <= 0) {
      executorService=ExecutorServiceHelper.newCachedThreadPool(name,true);
    }
 else {
      int max=getMaxPoolSize() != null ? getMaxPoolSize() : poolSize;
      executorService=ExecutorServiceHelper.newThreadPool(name,poolSize,max,getKeepAliveTime(),getUnits(),true);
    }
  }
  Processor childProcessor=routeContext.createProcessor(this);
  UnitOfWorkProcessor uow=new UnitOfWorkProcessor(routeContext,childProcessor);
  return new ThreadsProcessor(uow,executorService,waitForTaskToComplete);
}
