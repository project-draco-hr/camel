{
  if (log.isTraceEnabled()) {
    log.trace("Polling " + endpoint.getConfiguration());
  }
  try {
    connectIfNecessary();
    if (!loggedIn) {
      String message="Could not connect/login to " + endpoint.getConfiguration();
      log.warn(message);
      throw new FtpOperationFailedException(client.getReplyCode(),client.getReplyString(),message);
    }
    final String fileName=endpoint.getConfiguration().getFile();
    if (endpoint.getConfiguration().isDirectory()) {
      pollDirectory(fileName);
    }
 else {
      int index=fileName.lastIndexOf('/');
      if (index > -1) {
        client.changeWorkingDirectory(fileName.substring(0,index));
      }
      final FTPFile[] files=client.listFiles(fileName.substring(index + 1));
      pollFile(files[0]);
    }
    lastPollTime=System.currentTimeMillis();
  }
 catch (  Exception e) {
    loggedIn=false;
    if (isStopping() || isStopped()) {
      log.warn("Consumer is stopping. Ignoring caught exception: " + e.getClass().getCanonicalName() + " message: "+ e.getMessage());
    }
 else {
      log.warn("Exception occured during polling: " + e.getClass().getCanonicalName() + " message: "+ e.getMessage());
      disconnect();
      throw e;
    }
  }
}
