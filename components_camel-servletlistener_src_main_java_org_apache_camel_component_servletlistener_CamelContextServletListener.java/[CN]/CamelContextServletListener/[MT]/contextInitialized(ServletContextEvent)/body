{
  LOG.info("CamelContextServletListener initializing ...");
  try {
    jndiContext=new JndiContext();
    camelContext=new ServletCamelContext(jndiContext,sce.getServletContext());
  }
 catch (  Exception e) {
    LOG.error("Error creating CamelContext.",e);
    throw new RuntimeException("Error creating CamelContext.",e);
  }
  Map<String,Object> map=extractInitParameters(sce);
  String test=(String)map.remove("test");
  if (test != null && "true".equalsIgnoreCase(test)) {
    this.test=true;
  }
  LOG.trace("In test mode? {}",this.test);
  if (!map.isEmpty()) {
    try {
      IntrospectionSupport.setProperties(camelContext,map);
    }
 catch (    Exception e) {
      throw new RuntimeException("Error setting init parameters on CamelContext.",e);
    }
  }
  Map<String,RouteBuilder> routeBuilders=extractRouteBuilders(map);
  for (  Map.Entry<String,RouteBuilder> entry : routeBuilders.entrySet()) {
    LOG.debug("Adding RouteBuilder {} -> {}",entry.getKey(),entry.getValue());
    try {
      camelContext.addRoutes(entry.getValue());
    }
 catch (    Exception e) {
      throw new RuntimeException("Error adding RouteBuilder " + entry.getKey(),e);
    }
  }
  String lifecycle=(String)map.remove(CamelContextLifecycle.class.getName());
  if (lifecycle != null) {
    try {
      Class<CamelContextLifecycle> clazz=camelContext.getClassResolver().resolveMandatoryClass(lifecycle,CamelContextLifecycle.class);
      camelContextLifecycle=camelContext.getInjector().newInstance(clazz);
    }
 catch (    ClassNotFoundException e) {
      throw new RuntimeException("Error creating CamelContextLifecycle class with name " + lifecycle,e);
    }
  }
  if (!map.isEmpty()) {
    throw new IllegalArgumentException("Error setting init parameters on CamelContext." + " There are " + map.size() + " unknown parameters. ["+ map+ "]");
  }
  try {
    if (camelContextLifecycle != null) {
      camelContextLifecycle.beforeStart(camelContext,jndiContext);
    }
    camelContext.start();
    if (camelContextLifecycle != null) {
      camelContextLifecycle.afterStart(camelContext,jndiContext);
    }
  }
 catch (  Exception e) {
    LOG.error("Error starting CamelContext.",e);
    throw new RuntimeException("Error starting CamelContext.",e);
  }
  if (this.test) {
    instance=camelContext;
  }
  LOG.info("CamelContextServletListener initialized");
}
