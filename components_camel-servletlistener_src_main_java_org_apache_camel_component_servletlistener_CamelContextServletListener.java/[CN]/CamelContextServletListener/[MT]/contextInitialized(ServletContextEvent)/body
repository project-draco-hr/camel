{
  LOG.info("CamelContextServletListener initializing ...");
  try {
    jndiContext=new JndiContext();
    camelContext=new ServletCamelContext(jndiContext,sce.getServletContext());
  }
 catch (  Exception e) {
    LOG.error("Error creating CamelContext.",e);
    throw new RuntimeException("Error creating CamelContext.",e);
  }
  Map<String,Object> map=extractInitParameters(sce);
  String test=(String)map.remove("test");
  if (test != null && "true".equalsIgnoreCase(test)) {
    this.test=true;
  }
  LOG.trace("In test mode? {}",this.test);
  if (!map.isEmpty()) {
    try {
      IntrospectionSupport.setProperties(camelContext,map);
    }
 catch (    Exception e) {
      throw new RuntimeException("Error setting init parameters on CamelContext.",e);
    }
  }
  Map<String,Object> routes=extractRoutes(map);
  for (  Map.Entry<String,Object> entry : routes.entrySet()) {
    if (entry.getValue() instanceof RouteBuilder) {
      LOG.debug("Adding route(s) {} -> {}",entry.getKey(),entry.getValue());
      try {
        camelContext.addRoutes((RoutesBuilder)entry.getValue());
      }
 catch (      Exception e) {
        throw new RuntimeException("Error adding route(s) " + entry.getKey(),e);
      }
    }
 else     if (entry.getValue() instanceof Set) {
      for (      Object clazz : (Set)entry.getValue()) {
        LOG.debug("Adding route(s) {} -> {}",entry.getKey(),clazz);
        try {
          camelContext.addRoutes((RoutesBuilder)clazz);
        }
 catch (        Exception e) {
          throw new RuntimeException("Error adding route(s) " + entry.getKey(),e);
        }
      }
    }
 else     if (entry.getValue() instanceof RoutesDefinition) {
      LOG.debug("Adding routes {} -> {}",entry.getKey(),entry.getValue());
      try {
        camelContext.addRouteDefinitions(((RoutesDefinition)entry.getValue()).getRoutes());
      }
 catch (      Exception e) {
        throw new RuntimeException("Error adding route(s) " + entry.getKey(),e);
      }
    }
 else     if (entry.getValue() instanceof RouteDefinition) {
      LOG.debug("Adding routes {} -> {}",entry.getKey(),entry.getValue());
      try {
        camelContext.addRouteDefinition((RouteDefinition)entry.getValue());
      }
 catch (      Exception e) {
        throw new RuntimeException("Error adding route(s) " + entry.getKey(),e);
      }
    }
 else {
      throw new IllegalArgumentException("Unsupported route " + entry.getKey() + " of type: "+ entry.getValue().getClass().getName());
    }
  }
  String lifecycle=(String)map.remove(CamelContextLifecycle.class.getName());
  if (lifecycle != null) {
    try {
      Class<CamelContextLifecycle> clazz=camelContext.getClassResolver().resolveMandatoryClass(lifecycle,CamelContextLifecycle.class);
      camelContextLifecycle=camelContext.getInjector().newInstance(clazz);
    }
 catch (    ClassNotFoundException e) {
      throw new RuntimeException("Error creating CamelContextLifecycle class with name " + lifecycle,e);
    }
  }
  if (!map.isEmpty()) {
    throw new IllegalArgumentException("Error setting init parameters on CamelContext." + " There are " + map.size() + " unknown parameters. ["+ map+ "]");
  }
  try {
    if (camelContextLifecycle != null) {
      camelContextLifecycle.beforeStart(camelContext,jndiContext);
    }
    camelContext.start();
    if (camelContextLifecycle != null) {
      camelContextLifecycle.afterStart(camelContext,jndiContext);
    }
  }
 catch (  Exception e) {
    LOG.error("Error starting CamelContext.",e);
    throw new RuntimeException("Error starting CamelContext.",e);
  }
  if (this.test) {
    instance=camelContext;
  }
  LOG.info("CamelContextServletListener initialized");
}
