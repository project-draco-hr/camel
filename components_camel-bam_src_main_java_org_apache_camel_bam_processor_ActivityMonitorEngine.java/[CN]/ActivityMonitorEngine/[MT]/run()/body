{
  LOG.debug("Starting to poll for timeout events");
  while (!isStopped()) {
    try {
      long now=System.currentTimeMillis();
      long nextPoll=now + windowMillis;
      final Date timeNow=new Date(now);
      transactionTemplate.execute(new TransactionCallbackWithoutResult(){
        protected void doInTransactionWithoutResult(        TransactionStatus status){
          List<ActivityState> list=CastUtils.cast(template.find("select x from " + ActivityState.class.getName() + " x where x.timeOverdue < ?1",timeNow));
          for (          ActivityState activityState : list) {
            fireExpiredEvent(activityState);
          }
        }
      }
);
      long timeToSleep=nextPoll - System.currentTimeMillis();
      if (timeToSleep > 0) {
        if (LOG.isDebugEnabled()) {
          LOG.debug("Sleeping for " + timeToSleep + " millis");
        }
        try {
          Thread.sleep(timeToSleep);
        }
 catch (        InterruptedException e) {
          LOG.debug("Caught: " + e,e);
        }
      }
    }
 catch (    Exception e) {
      LOG.error("Caught: " + e,e);
    }
  }
}
