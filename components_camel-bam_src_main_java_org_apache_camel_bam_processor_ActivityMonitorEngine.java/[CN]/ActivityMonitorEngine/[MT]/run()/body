{
  LOG.debug("Starting to poll for timeout events");
  while (!isStopped()) {
    try {
      long now=System.currentTimeMillis();
      long nextPoll=now + windowMillis;
      final Date timeNow=new Date(now);
      transactionTemplate.execute(new TransactionCallbackWithoutResult(){
        protected void doInTransactionWithoutResult(        TransactionStatus status){
          Map<String,Object> params=new HashMap<String,Object>(1);
          params.put("timeNow",timeNow);
          List<ActivityState> list=CastUtils.cast(template.findByNamedParams("select x from " + QueryUtils.getTypeName(ActivityState.class) + " x where x.timeOverdue < :timeNow",params));
          for (          ActivityState activityState : list) {
            fireExpiredEvent(activityState);
          }
        }
      }
);
      long timeToSleep=nextPoll - System.currentTimeMillis();
      if (timeToSleep > 0) {
        LOG.debug("Sleeping for {} millis",timeToSleep);
        try {
          Thread.sleep(timeToSleep);
        }
 catch (        InterruptedException e) {
          LOG.debug("Caught: " + e,e);
        }
      }
    }
 catch (    Exception e) {
      LOG.error("Caught: " + e,e);
    }
  }
}
