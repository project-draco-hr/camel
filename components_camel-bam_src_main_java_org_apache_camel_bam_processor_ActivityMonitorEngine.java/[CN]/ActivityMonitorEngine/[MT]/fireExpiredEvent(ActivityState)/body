{
  if (log.isDebugEnabled()) {
    log.debug("Trying to fire expiration of: " + activityState);
  }
  template.execute(new JpaCallback(){
    public Object doInJpa(    EntityManager entityManager) throws PersistenceException {
      if (isUseLocking()) {
        log.info("Attempting to lock: " + activityState);
        entityManager.lock(activityState,LockModeType.WRITE);
        log.info("Grabbed lock: " + activityState);
      }
      try {
        rules.processExpired(activityState);
      }
 catch (      Exception e) {
        log.error("Failed to process expiration of: " + activityState + ". Reason: "+ e,e);
      }
      activityState.setEscalationLevel(escalateLevel + 1);
      return null;
    }
  }
);
}
