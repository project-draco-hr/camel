{
  Exchange resourceExchange=createResourceExchange(exchange,ExchangePattern.InOut);
  producer.process(resourceExchange);
  if (resourceExchange.isFailed()) {
    copyResultsPreservePattern(exchange,resourceExchange);
  }
 else {
    prepareResult(exchange);
    Boolean filtered=resourceExchange.getProperty(Exchange.FILTERED,Boolean.class);
    if (filtered == null || !filtered) {
      ExchangeHelper.prepareAggregation(exchange,resourceExchange);
      Exchange aggregatedExchange=aggregationStrategy.aggregate(exchange,resourceExchange);
      if (aggregatedExchange != null) {
        copyResultsPreservePattern(exchange,aggregatedExchange);
      }
    }
 else {
      if (LOG.isTraceEnabled()) {
        LOG.trace("Cannot aggregate exchange as its filtered: " + resourceExchange);
      }
    }
  }
}
