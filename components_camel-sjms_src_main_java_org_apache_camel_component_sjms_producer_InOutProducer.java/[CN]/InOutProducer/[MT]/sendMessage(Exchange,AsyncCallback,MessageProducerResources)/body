{
  if (isEndpointTransacted()) {
    exchange.getUnitOfWork().addSynchronization(new SessionTransactionSynchronization(producer.getSession(),getCommitStrategy()));
  }
  Message request=SjmsExchangeMessageHelper.createMessage(exchange,producer.getSession(),getSjmsEndpoint().getJmsKeyFormatStrategy());
  String correlationId=null;
  if (exchange.getIn().getHeader("JMSCorrelationID",String.class) == null) {
    correlationId=UUID.randomUUID().toString().replace("-","");
  }
 else {
    correlationId=exchange.getIn().getHeader("JMSCorrelationID",String.class);
  }
  Object responseObject=null;
  Exchanger<Object> messageExchanger=new Exchanger<Object>();
  SjmsExchangeMessageHelper.setCorrelationId(request,correlationId);
  lock.writeLock().lock();
  try {
    exchangerMap.put(correlationId,messageExchanger);
  }
  finally {
    lock.writeLock().unlock();
  }
  MessageConsumerResources consumer=consumers.borrowObject();
  SjmsExchangeMessageHelper.setJMSReplyTo(request,consumer.getReplyToDestination());
  consumers.returnObject(consumer);
  producer.getMessageProducer().send(request);
  try {
    getProducers().returnObject(producer);
  }
 catch (  Exception exception) {
  }
  try {
    responseObject=messageExchanger.exchange(null,getResponseTimeOut(),TimeUnit.MILLISECONDS);
    lock.writeLock().lock();
    try {
      exchangerMap.remove(correlationId);
    }
  finally {
      lock.writeLock().unlock();
    }
  }
 catch (  InterruptedException e) {
    log.debug("Exchanger was interrupted while waiting on response",e);
    exchange.setException(e);
  }
catch (  TimeoutException e) {
    log.debug("Exchanger timed out while waiting on response",e);
    exchange.setException(e);
  }
  if (exchange.getException() == null) {
    if (responseObject instanceof Throwable) {
      exchange.setException((Throwable)responseObject);
    }
 else     if (responseObject instanceof Message) {
      Message response=(Message)responseObject;
      SjmsExchangeMessageHelper.populateExchange(response,exchange,true,getEndpoint().getJmsKeyFormatStrategy());
    }
 else {
      exchange.setException(new CamelException("Unknown response type: " + responseObject));
    }
  }
  callback.done(isSynchronous());
}
