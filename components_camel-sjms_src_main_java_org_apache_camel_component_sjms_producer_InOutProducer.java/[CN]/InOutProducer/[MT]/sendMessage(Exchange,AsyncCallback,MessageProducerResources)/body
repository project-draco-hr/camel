{
  if (isEndpointTransacted()) {
    exchange.getUnitOfWork().addSynchronization(new SessionTransactionSynchronization(producer.getSession(),getCommitStrategy()));
  }
  Message request=JmsMessageHelper.createMessage(exchange,producer.getSession(),getEndpoint());
  String correlationId;
  if (exchange.getIn().getHeader(JmsConstants.JMS_CORRELATION_ID,String.class) == null) {
    correlationId=UUID.randomUUID().toString().replace("-","");
  }
 else {
    correlationId=exchange.getIn().getHeader(JmsConstants.JMS_CORRELATION_ID,String.class);
  }
  Object responseObject=null;
  Exchanger<Object> messageExchanger=new Exchanger<Object>();
  JmsMessageHelper.setCorrelationId(request,correlationId);
  EXCHANGERS.put(correlationId,messageExchanger);
  MessageConsumerResources consumer=consumers.borrowObject();
  JmsMessageHelper.setJMSReplyTo(request,consumer.getReplyToDestination());
  consumers.returnObject(consumer);
  producer.getMessageProducer().send(request);
  try {
    getProducers().returnObject(producer);
  }
 catch (  Exception exception) {
  }
  try {
    responseObject=messageExchanger.exchange(null,getResponseTimeOut(),TimeUnit.MILLISECONDS);
    EXCHANGERS.remove(correlationId);
  }
 catch (  InterruptedException e) {
    log.debug("Exchanger was interrupted while waiting on response",e);
    exchange.setException(e);
  }
catch (  TimeoutException e) {
    log.debug("Exchanger timed out while waiting on response",e);
    exchange.setException(e);
  }
  if (exchange.getException() == null) {
    if (responseObject instanceof Throwable) {
      exchange.setException((Throwable)responseObject);
    }
 else     if (responseObject instanceof Message) {
      Message response=(Message)responseObject;
      JmsMessageHelper.populateExchange(response,exchange,true,getEndpoint().getJmsKeyFormatStrategy());
    }
 else {
      exchange.setException(new CamelException("Unknown response type: " + responseObject));
    }
  }
  callback.done(isSynchronous());
}
