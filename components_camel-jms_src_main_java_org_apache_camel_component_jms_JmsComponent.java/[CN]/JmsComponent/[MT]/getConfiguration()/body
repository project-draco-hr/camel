{
  if (configuration == null) {
    configuration=createConfiguration();
    if (applicationContext != null) {
      Map beansOfType=applicationContext.getBeansOfType(ConnectionFactory.class);
      if (!beansOfType.isEmpty()) {
        ConnectionFactory cf=(ConnectionFactory)beansOfType.values().iterator().next();
        configuration.setConnectionFactory(cf);
      }
    }
  }
  return configuration;
}
