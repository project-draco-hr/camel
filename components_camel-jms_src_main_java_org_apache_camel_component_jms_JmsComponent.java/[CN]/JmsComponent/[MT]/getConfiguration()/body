{
  if (configuration == null) {
    configuration=createConfiguration();
    if (applicationContext != null) {
      Map<String,Object> beansOfType=CastUtils.cast(applicationContext.getBeansOfType(ConnectionFactory.class));
      if (!beansOfType.isEmpty()) {
        ConnectionFactory cf=(ConnectionFactory)beansOfType.values().iterator().next();
        configuration.setConnectionFactory(cf);
      }
      beansOfType=CastUtils.cast(applicationContext.getBeansOfType(DestinationResolver.class));
      if (!beansOfType.isEmpty()) {
        DestinationResolver destinationResolver=(DestinationResolver)beansOfType.values().iterator().next();
        configuration.setDestinationResolver(destinationResolver);
      }
    }
  }
  return configuration;
}
