{
  JmsMessageType type=null;
  if (endpoint != null && endpoint.isTransferExchange()) {
    if (LOG.isTraceEnabled()) {
      LOG.trace("Option transferExchange=true so we use JmsMessageType: Object");
    }
    Serializable holder=DefaultExchangeHolder.marshal(exchange);
    return session.createObjectMessage(holder);
  }
  if (endpoint != null && endpoint.getMessageConverter() != null) {
    if (LOG.isTraceEnabled()) {
      LOG.trace("Creating JmsMessage using a custom MessageConverter: " + endpoint.getMessageConverter() + " with body: "+ body);
    }
    return endpoint.getMessageConverter().toMessage(body,session);
  }
  if (headers.containsKey(JmsConstants.JMS_MESSAGE_TYPE)) {
    type=context.getTypeConverter().convertTo(JmsMessageType.class,headers.get(JmsConstants.JMS_MESSAGE_TYPE));
  }
 else   if (endpoint != null && endpoint.getConfiguration().getJmsMessageType() != null) {
    type=endpoint.getConfiguration().getJmsMessageType();
  }
 else {
    if (body instanceof Node || body instanceof String) {
      type=Text;
    }
 else     if (body instanceof byte[] || body instanceof GenericFile || body instanceof File|| body instanceof Reader|| body instanceof InputStream|| body instanceof ByteBuffer|| body instanceof StreamCache) {
      type=Bytes;
    }
 else     if (body instanceof Map) {
      type=Map;
    }
 else     if (body instanceof Serializable) {
      type=Object;
    }
  }
  if (type != null) {
    if (LOG.isTraceEnabled()) {
      LOG.trace("Using JmsMessageType: " + type);
    }
switch (type) {
case Text:
{
        TextMessage message=session.createTextMessage();
        String payload=context.getTypeConverter().convertTo(String.class,exchange,body);
        message.setText(payload);
        return message;
      }
case Bytes:
{
      BytesMessage message=session.createBytesMessage();
      byte[] payload=context.getTypeConverter().convertTo(byte[].class,exchange,body);
      message.writeBytes(payload);
      return message;
    }
case Map:
{
    MapMessage message=session.createMapMessage();
    Map payload=context.getTypeConverter().convertTo(Map.class,exchange,body);
    populateMapMessage(message,payload,context);
    return message;
  }
case Object:
Serializable payload;
try {
payload=context.getTypeConverter().mandatoryConvertTo(Serializable.class,exchange,body);
}
 catch (NoTypeConversionAvailableException e) {
JMSException cause=new MessageFormatException(e.getMessage());
cause.initCause(e);
throw cause;
}
return session.createObjectMessage(payload);
default :
break;
}
}
if (LOG.isWarnEnabled()) {
LOG.warn("Cannot determine specific JmsMessage type to use from body class." + " Will use generic JmsMessage." + (body != null ? (" Body class: " + body.getClass().getCanonicalName()) : " Body is null") + ". If you want to send a POJO then your class might need to implement java.io.Serializable"+ ", or you can force a specific type by setting the jmsMessageType option on the JMS endpoint.");
}
return session.createMessage();
}
