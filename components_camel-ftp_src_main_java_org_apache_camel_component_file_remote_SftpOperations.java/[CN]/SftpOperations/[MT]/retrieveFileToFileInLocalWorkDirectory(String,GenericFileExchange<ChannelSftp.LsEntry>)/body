{
  File temp;
  File local=new File(endpoint.getLocalWorkDirectory());
  OutputStream os;
  try {
    String relativeName=exchange.getGenericFile().getRelativeFilePath();
    temp=new File(local,relativeName + ".inprogress");
    local=new File(local,relativeName);
    local.mkdirs();
    if (temp.exists()) {
      if (!temp.delete()) {
        throw new GenericFileOperationFailedException("Cannot delete existing local work file: " + temp);
      }
    }
    if (local.exists()) {
      if (!local.delete()) {
        throw new GenericFileOperationFailedException("Cannot delete existing local work file: " + local);
      }
    }
    if (!temp.createNewFile()) {
      throw new GenericFileOperationFailedException("Cannot create new local work file: " + temp);
    }
    os=new FileOutputStream(temp);
    exchange.getIn().setHeader("CamelFileLocalWorkPath",local.getPath());
  }
 catch (  Exception e) {
    throw new GenericFileOperationFailedException("Cannot create new local work file: " + local);
  }
  try {
    GenericFile<ChannelSftp.LsEntry> target=exchange.getGenericFile();
    target.setBody(local);
    channel.get(name,os);
    if (!temp.renameTo(local)) {
      throw new GenericFileOperationFailedException("Cannot rename local work file from: " + temp + " to: "+ local);
    }
  }
 catch (  SftpException e) {
    throw new GenericFileOperationFailedException("Cannot retrieve file: " + name,e);
  }
 finally {
    ObjectHelper.close(os,"retrieve: " + name,LOG);
  }
  return true;
}
