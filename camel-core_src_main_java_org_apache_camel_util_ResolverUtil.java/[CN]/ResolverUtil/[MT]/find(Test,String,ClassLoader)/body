{
  if (LOG.isTraceEnabled()) {
    LOG.trace("Searching for: " + test + " in package: "+ packageName+ " using classloader: "+ loader);
  }
  try {
    Method mth=loader.getClass().getMethod("getBundle",new Class[]{});
    if (mth != null) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("Loading from osgi buindle using classloader: " + loader);
      }
      loadImplementationsInBundle(test,packageName,loader,mth);
      return;
    }
  }
 catch (  NoSuchMethodException e) {
    LOG.trace("It's not an osgi bundle classloader");
  }
  Enumeration<URL> urls;
  try {
    urls=getResources(loader,packageName);
    if (!urls.hasMoreElements()) {
      LOG.trace("No URLs returned by classloader");
    }
  }
 catch (  IOException ioe) {
    LOG.warn("Could not read package: " + packageName,ioe);
    return;
  }
  while (urls.hasMoreElements()) {
    URL url=null;
    try {
      url=urls.nextElement();
      if (LOG.isTraceEnabled()) {
        LOG.trace("URL from classloader: " + url);
      }
      String urlPath=url.getFile();
      urlPath=URLDecoder.decode(urlPath,"UTF-8");
      if (urlPath.startsWith("file:")) {
        urlPath=urlPath.substring(5);
      }
      if (urlPath.indexOf('!') > 0) {
        urlPath=urlPath.substring(0,urlPath.indexOf('!'));
      }
      if (LOG.isTraceEnabled()) {
        LOG.trace("Scanning for classes in [" + urlPath + "] matching criteria: "+ test);
      }
      File file=new File(urlPath);
      if (file.isDirectory()) {
        if (LOG.isDebugEnabled()) {
          LOG.debug("Loading from directory: " + file);
        }
        loadImplementationsInDirectory(test,packageName,file);
      }
 else {
        if (LOG.isDebugEnabled()) {
          LOG.debug("Loading from jar: " + file);
        }
        loadImplementationsInJar(test,packageName,file);
      }
    }
 catch (    IOException ioe) {
      LOG.warn("Could not read entries in url: " + url,ioe);
    }
  }
}
