{
  return new RouteBuilder(){
    @Override public void configure(){
      from("direct:start").to("sjms:topic:transacted.consumer.test");
      from("sjms:topic:transacted.consumer.test?transacted=true&transactionBatchCount=10").choice().when(header("JMSRedelivered").isEqualTo("false")).to("log:before_log?showAll=true").to("mock:test.before").process(new Processor(){
        @Override public void process(        Exchange exchange) throws Exception {
          String body=exchange.getIn().getBody(String.class);
          if (body.endsWith("10")) {
            log.info("10th message received.  Rolling back.");
            exchange.getOut().setFault(true);
            exchange.getOut().setBody("10th message received.  Rolling back.");
          }
        }
      }
).otherwise().to("log:after_log?showAll=true").to("mock:test.after");
    }
  }
;
}
