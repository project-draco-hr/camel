{
  return new RouteBuilder(){
    public void configure() throws Exception {
      from(timeOutEndpointUri).to("jms:queue:test.b");
      from("jms:queue:test.b").aggregate(header("cheese"),new AggregationStrategy(){
        public Exchange aggregate(        Exchange oldExchange,        Exchange newExchange){
          try {
            Thread.sleep(2 * BatchProcessor.DEFAULT_BATCH_TIMEOUT);
          }
 catch (          InterruptedException e) {
            LOG.error("aggregration delay sleep inturrepted",e);
            fail("aggregration delay sleep inturrepted");
          }
          return newExchange;
        }
      }
).completionTimeout(2000L).to("mock:result");
      from(multicastEndpointUri).to("jms:queue:point1","jms:queue:point2","jms:queue:point3");
      from("jms:queue:point1").process(new MyProcessor()).to("jms:queue:reply");
      from("jms:queue:point2").process(new MyProcessor()).to("jms:queue:reply");
      from("jms:queue:point3").process(new MyProcessor()).to("jms:queue:reply");
      from("jms:queue:reply").aggregate(header("cheese"),new AggregationStrategy(){
        public Exchange aggregate(        Exchange oldExchange,        Exchange newExchange){
          if (oldExchange == null) {
            return newExchange;
          }
          LOG.info("try to aggregating the message ");
          Integer old=oldExchange.getProperty("aggregated",Integer.class);
          if (old == null) {
            old=1;
          }
          oldExchange.setProperty("aggregated",old + 1);
          return oldExchange;
        }
      }
).completionPredicate(header("aggregated").isEqualTo(3)).to("mock:reply");
    }
  }
;
}
