{
  return new RouteBuilder(){
    public void configure() throws Exception {
      from(timeOutEndpointUri).to("jms:queue:test.b");
      from("jms:queue:test.b").aggregator(header("cheese"),new AggregationStrategy(){
        public Exchange aggregate(        Exchange oldExchange,        Exchange newExchange){
          try {
            Thread.sleep(2 * BatchProcessor.DEFAULT_BATCH_TIMEOUT);
          }
 catch (          InterruptedException e) {
            LOG.error("aggregration delay sleep inturrepted",e);
            fail("aggregration delay sleep inturrepted");
          }
          return newExchange;
        }
      }
).to("mock:result");
      from(multicastEndpointUri).to("jms:queue:point1","jms:queue:point2","jms:queue:point3");
      from("jms:queue:point1").process(new MyProcessor()).to("jms:queue:reply");
      from("jms:queue:point2").process(new MyProcessor()).to("jms:queue:reply");
      from("jms:queue:point3").process(new MyProcessor()).to("jms:queue:reply");
      from("jms:queue:reply").aggregator(header("cheese"),new AggregationStrategy(){
        public Exchange aggregate(        Exchange oldExchange,        Exchange newExchange){
          Exchange copy=newExchange.copy();
          LOG.info("try to aggregating the message ");
          Integer old=(Integer)oldExchange.getProperty("aggregated");
          if (old == null) {
            old=1;
          }
          Exchange result=copy;
          result.setProperty("aggregated",old + 1);
          return result;
        }
      }
).completedPredicate(header("aggregated").isEqualTo(3)).to("mock:reply");
    }
  }
;
}
