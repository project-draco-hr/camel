{
  if (usingIterator) {
    return new ZipIterator(exchange.getIn());
  }
 else {
    InputStream is=exchange.getIn().getMandatoryBody(InputStream.class);
    ZipInputStream zis=new ZipInputStream(is);
    ByteArrayOutputStream baos=new ByteArrayOutputStream();
    try {
      ZipEntry entry=zis.getNextEntry();
      if (entry != null) {
        exchange.getOut().setHeader(FILE_NAME,entry.getName());
        IOHelper.copy(zis,baos);
      }
      entry=zis.getNextEntry();
      if (entry != null) {
        throw new IllegalStateException("Zip file has more than 1 entry.");
      }
      return baos.toByteArray();
    }
  finally {
      IOHelper.close(zis,baos);
    }
  }
}
