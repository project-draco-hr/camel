{
  try {
    final Session session=connection.createSession(TRANSACTED,Session.CLIENT_ACKNOWLEDGE);
    try {
      Queue queue=session.createQueue(destinationName);
      MessageConsumer consumer=session.createConsumer(queue);
      try {
        consumeBatchesOnLoop(session,consumer,completionTimeoutTrigger);
      }
  finally {
        try {
          consumer.close();
        }
 catch (        JMSException ex2) {
          if (log.isDebugEnabled()) {
            log.debug("Exception caught closing consumer",ex2);
          }
          log.warn("Exception caught closing consumer: {}",ex2.getMessage());
        }
      }
    }
  finally {
      try {
        session.close();
      }
 catch (      JMSException ex1) {
        if (log.isDebugEnabled()) {
          log.debug("Exception caught closing session: {}",ex1);
        }
        log.warn("Exception caught closing session: {}",ex1.getMessage());
      }
    }
  }
 catch (  JMSException ex) {
    LOG.warn("Exception caught consuming from " + destinationName,ex);
  }
 finally {
    CountDownLatch consumersShutdownLatch=consumersShutdownLatchRef.get();
    consumersShutdownLatch.countDown();
  }
}
