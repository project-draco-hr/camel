{
  XMLCipher xmlCipher=XMLCipher.getInstance(xmlCipherAlgorithm);
  xmlCipher.init(XMLCipher.ENCRYPT_MODE,dataEncryptionKey);
  if (secureTag.equalsIgnoreCase("")) {
    embedKeyInfoInEncryptedData(document,keyCipher,xmlCipher,dataEncryptionKey,keyEncryptionKey);
    document=xmlCipher.doFinal(document,document.getDocumentElement());
  }
 else {
    XPathBuilder xpathBuilder=new XPathBuilder(secureTag);
    xpathBuilder.setNamespaceContext(getNamespaceContext());
    NodeList nodeList=xpathBuilder.evaluate(exchange,NodeList.class);
    for (int i=0; i < nodeList.getLength(); i++) {
      Node node=nodeList.item(i);
      document=node.getOwnerDocument();
      embedKeyInfoInEncryptedData(node.getOwnerDocument(),keyCipher,xmlCipher,dataEncryptionKey,keyEncryptionKey);
      Document temp=xmlCipher.doFinal(node.getOwnerDocument(),(Element)node,getSecureTagContents());
      document.importNode(temp.getDocumentElement().cloneNode(true),true);
    }
  }
  try {
    DOMSource source=new DOMSource(document);
    InputStream sis=exchange.getContext().getTypeConverter().mandatoryConvertTo(InputStream.class,source);
    IOHelper.copy(sis,stream);
  }
  finally {
    stream.close();
  }
}
