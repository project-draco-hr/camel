{
  InputStream is=exchange.getContext().getTypeConverter().convertTo(InputStream.class,graph);
  if (is == null) {
    throw new IllegalArgumentException("Cannot get the inputstream for XMLSecurityDataFormat mashalling");
  }
  Document document=exchange.getContext().getTypeConverter().convertTo(Document.class,exchange,is);
  Key keyEncryptionkey;
  Key dataEncryptionkey;
  if (xmlCipherAlgorithm.equals(XMLCipher.TRIPLEDES)) {
    keyEncryptionkey=generateEncryptionKey("DESede");
    dataEncryptionkey=generateEncryptionKey("DESede");
  }
 else {
    keyEncryptionkey=generateEncryptionKey("AES");
    dataEncryptionkey=generateEncryptionKey("AES");
  }
  XMLCipher keyCipher=XMLCipher.getInstance(generateXmlCipherAlgorithmKeyWrap());
  keyCipher.init(XMLCipher.WRAP_MODE,keyEncryptionkey);
  XMLCipher xmlCipher=XMLCipher.getInstance(xmlCipherAlgorithm);
  xmlCipher.init(XMLCipher.ENCRYPT_MODE,dataEncryptionkey);
  if (secureTag.equalsIgnoreCase("")) {
    embedKeyInfoInEncryptedData(document,keyCipher,xmlCipher,dataEncryptionkey);
    document=xmlCipher.doFinal(document,document.getDocumentElement());
  }
 else {
    NodeIterator iter=XPathAPI.selectNodeIterator(document,secureTag);
    Node node;
    while ((node=iter.nextNode()) != null) {
      embedKeyInfoInEncryptedData(document,keyCipher,xmlCipher,dataEncryptionkey);
      Document temp=xmlCipher.doFinal(document,(Element)node,getSecureTagContents());
      document.importNode(temp.getDocumentElement().cloneNode(true),true);
    }
  }
  DOMSource source=new DOMSource(document);
  try {
    IOConverter.copy(IOConverter.toInputStrean(source),stream);
  }
  finally {
    stream.close();
  }
}
