{
  String answer;
  String name=exchange.getIn().getHeader(FileComponent.HEADER_FILE_NAME,String.class);
  Expression expression=endpoint.getExpression();
  if (name != null) {
    if (name.indexOf("${") > -1) {
      if (LOG.isDebugEnabled()) {
        LOG.debug(FileComponent.HEADER_FILE_NAME + " contains a FileLanguage expression: " + name);
      }
      expression=FileLanguage.file(name);
    }
  }
  if (expression != null) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Filename evaluated as expression: " + expression);
    }
    Object result=expression.evaluate(exchange);
    name=exchange.getContext().getTypeConverter().convertTo(String.class,result);
  }
  String endpointFile=endpoint.getConfiguration().getFile();
  if (endpoint.getConfiguration().isDirectory()) {
    String baseDir="";
    if (endpointFile.length() > 0) {
      baseDir=endpointFile + (endpointFile.endsWith("/") ? "" : "/");
    }
    String fileName=(name != null) ? name : endpoint.getGeneratedFileName(exchange.getIn());
    answer=baseDir + fileName;
  }
 else {
    answer=endpointFile;
  }
  return answer;
}
