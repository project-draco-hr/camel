{
  InputStream payload=exchange.getIn().getBody(InputStream.class);
  try {
    int lastPathIndex=fileName.lastIndexOf('/');
    if (lastPathIndex != -1) {
      String directory=fileName.substring(0,lastPathIndex);
      if (!operations.buildDirectory(directory)) {
        LOG.warn("Couldn't build directory: " + directory + " (could be because of denied permissions)");
      }
    }
    if (LOG.isTraceEnabled()) {
      LOG.trace("About to send: " + fileName + " to: "+ remoteServer()+ " from exchange: "+ exchange);
    }
    boolean success=operations.storeFile(fileName,payload);
    if (!success) {
      throw new RemoteFileOperationFailedException("Error sending file: " + fileName + " to: "+ remoteServer());
    }
    if (LOG.isDebugEnabled()) {
      LOG.debug("Sent: " + fileName + " to: "+ remoteServer());
    }
  }
  finally {
    ObjectHelper.close(payload,"Closing payload",LOG);
  }
}
