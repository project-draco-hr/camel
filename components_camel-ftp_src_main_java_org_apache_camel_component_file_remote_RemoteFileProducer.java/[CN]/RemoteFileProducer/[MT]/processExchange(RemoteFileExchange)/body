{
  if (LOG.isTraceEnabled()) {
    LOG.trace("Processing " + exchange);
  }
  try {
    connectIfNecessary();
    if (!loggedIn) {
      String message="Could not connect/login to: " + endpoint.remoteServerInformation();
      throw new RemoteFileOperationFailedException(message);
    }
    String target=createFileName(exchange);
    boolean writeAsTempAndRename=ObjectHelper.isNotEmpty(endpoint.getTempPrefix());
    String tempTarget=null;
    if (writeAsTempAndRename) {
      tempTarget=createTempFileName(target);
    }
    writeFile(exchange,tempTarget != null ? tempTarget : target);
    if (tempTarget != null) {
      if (LOG.isTraceEnabled()) {
        LOG.trace("Renaming file: " + tempTarget + " to: "+ target);
      }
      boolean renamed=ftp.renameFile(tempTarget,target);
      if (!renamed) {
        throw new RemoteFileOperationFailedException("Cannot rename file from: " + tempTarget + " to: "+ target);
      }
    }
    exchange.getIn().setHeader(FileComponent.HEADER_FILE_NAME_PRODUCED,target);
  }
 catch (  Exception e) {
    loggedIn=false;
    if (isStopping() || isStopped()) {
      LOG.debug("Exception occurd during stopping. " + e.getMessage());
    }
 else {
      LOG.debug("Exception occurd during processing.",e);
      disconnect();
      throw e;
    }
  }
}
