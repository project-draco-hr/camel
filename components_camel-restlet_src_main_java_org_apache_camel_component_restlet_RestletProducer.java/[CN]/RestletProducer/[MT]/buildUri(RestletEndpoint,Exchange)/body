{
  String uri=endpoint.getProtocol() + "://" + endpoint.getHost()+ ":"+ endpoint.getPort()+ endpoint.getUriPattern();
  LOG.trace("Substituting { } placeholders in uri: {}",uri);
  Matcher matcher=PATTERN.matcher(uri);
  while (matcher.find()) {
    String key=matcher.group(1);
    String header=exchange.getIn().getHeader(key,String.class);
    if (header == null) {
      throw new CamelExchangeException("Header with key: " + key + " not found in Exchange",exchange);
    }
    if (LOG.isTraceEnabled()) {
      LOG.trace("Replacing: {} with header value: {}",matcher.group(0),header);
    }
    uri=matcher.replaceFirst(header);
    matcher.reset(uri);
  }
  String query=exchange.getIn().getHeader(Exchange.HTTP_QUERY,String.class);
  if (query != null) {
    if (LOG.isTraceEnabled()) {
      LOG.trace("Adding query: " + query + " to uri: "+ uri);
    }
    uri=addQueryToUri(uri,query);
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Using uri: " + uri);
  }
  return uri;
}
