{
  byte[] body=ExchangeHelper.convertToMandatoryType(exchange,byte[].class,inputStream);
  String charsetName=HL7Charset.getCharsetName(body,guessCharsetName(body,exchange));
  String bodyAsString=new String(body,charsetName);
  Message message=HL7Converter.parse(bodyAsString,parser);
  Terser terser=new Terser(message);
  for (  Map.Entry<String,String> entry : HEADER_MAP.entrySet()) {
    exchange.getOut().setHeader(entry.getKey(),terser.get(entry.getValue()));
  }
  exchange.getOut().setHeader(HL7_CONTEXT,hapiContext);
  exchange.getOut().setHeader(Exchange.CHARSET_NAME,charsetName);
  return message;
}
