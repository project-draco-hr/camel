{
  Collection<Message> messages=new ArrayList<Message>(1);
  MessageProducerResources producer=getProducers().borrowObject();
  try {
    if (producer != null) {
      if (exchange.getIn().getBody() != null) {
        if (exchange.getIn().getBody() instanceof List) {
          Iterable<?> payload=(Iterable<?>)exchange.getIn().getBody();
          for (          final Object object : payload) {
            Message message;
            if (BatchMessage.class.isInstance(object)) {
              BatchMessage<?> batchMessage=(BatchMessage<?>)object;
              message=JmsMessageHelper.createMessage(producer.getSession(),batchMessage.getPayload(),batchMessage.getHeaders(),getSjmsEndpoint().getJmsKeyFormatStrategy());
            }
 else {
              message=JmsMessageHelper.createMessage(producer.getSession(),object,exchange.getIn().getHeaders(),getSjmsEndpoint().getJmsKeyFormatStrategy());
            }
            messages.add(message);
          }
        }
 else {
          Object payload=exchange.getIn().getBody();
          Message message=JmsMessageHelper.createMessage(producer.getSession(),payload,exchange.getIn().getHeaders(),getSjmsEndpoint().getJmsKeyFormatStrategy());
          messages.add(message);
        }
      }
      if (isEndpointTransacted()) {
        exchange.getUnitOfWork().addSynchronization(new SessionTransactionSynchronization(producer.getSession(),producer.getCommitStrategy()));
      }
      for (      final Message message : messages) {
        producer.getMessageProducer().send(message);
      }
    }
 else {
      exchange.setException(new Exception("Unable to send message: connection not available"));
    }
  }
 catch (  Exception e) {
    exchange.setException(new Exception("Unable to complete sending the message: " + e.getLocalizedMessage()));
  }
 finally {
    if (producer != null) {
      getProducers().returnObject(producer);
    }
    callback.done(isSynchronous());
  }
}
