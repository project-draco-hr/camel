{
  LOG.debug("Geocode for current address");
  String json=exchange.getContext().getTypeConverter().mandatoryConvertTo(String.class,new URL("http://freegeoip.net/json/"));
  if (isEmpty(json)) {
    throw new IllegalStateException("Got the unexpected value '" + json + "' for the geolocation");
  }
  LOG.debug("Geocode response {}",json);
  exchange.getIn().setHeader(GeoCoderConstants.STATUS,GeocoderStatus.OK);
  ObjectMapper mapper=new ObjectMapper();
  JsonNode node=mapper.readValue(json,JsonNode.class);
  JsonNode latitudeNode=notNull(node.get("latitude"),"latitude");
  JsonNode longitudeNode=notNull(node.get("longitude"),"longitude");
  String resLatlng=latitudeNode.asText() + "," + longitudeNode.asText();
  exchange.getIn().setHeader(GeoCoderConstants.LATLNG,resLatlng);
  JsonNode country_code=node.get("country_code");
  JsonNode country_name=node.get("country_name");
  if (country_code != null) {
    exchange.getIn().setHeader(GeoCoderConstants.COUNTRY_SHORT,country_code.asText());
  }
  if (country_name != null) {
    exchange.getIn().setHeader(GeoCoderConstants.COUNTRY_LONG,country_name.asText());
  }
  JsonNode region_code=node.get("region_code");
  JsonNode region_name=node.get("region_name");
  if (region_code != null) {
    exchange.getIn().setHeader(GeoCoderConstants.REGION_CODE,region_code.asText());
  }
  if (region_name != null) {
    exchange.getIn().setHeader(GeoCoderConstants.REGION_NAME,region_name.asText());
  }
  JsonNode city=node.get("city");
  if (city != null) {
    exchange.getIn().setHeader(GeoCoderConstants.CITY,city.asText());
  }
  if (!endpoint.isHeadersOnly()) {
    exchange.getIn().setBody(json);
  }
}
