{
  if (LOG.isTraceEnabled()) {
    LOG.trace("Connecting using FTPClient: " + client);
  }
  String host=configuration.getHost();
  int port=configuration.getPort();
  String username=configuration.getUsername();
  FtpConfiguration ftpConfig=(FtpConfiguration)configuration;
  if (ftpConfig.getFtpClientConfig() != null) {
    LOG.trace("Configuring FTPClient with config: " + ftpConfig.getFtpClientConfig());
    client.configure(ftpConfig.getFtpClientConfig());
  }
  if (LOG.isTraceEnabled()) {
    LOG.trace("Connecting to " + configuration.remoteServerInformation());
  }
  boolean connected=false;
  int attempt=0;
  while (!connected) {
    try {
      if (LOG.isTraceEnabled() && attempt > 0) {
        LOG.trace("Reconnect attempt #" + attempt + " connecting to + "+ configuration.remoteServerInformation());
      }
      client.connect(host,port);
      int reply=client.getReplyCode();
      if (FTPReply.isPositiveCompletion(reply)) {
        connected=true;
      }
 else {
        throw new GenericFileOperationFailedException(client.getReplyCode(),client.getReplyString(),"Server refused connection");
      }
    }
 catch (    Exception e) {
      GenericFileOperationFailedException failed;
      if (e instanceof GenericFileOperationFailedException) {
        failed=(GenericFileOperationFailedException)e;
      }
 else {
        failed=new GenericFileOperationFailedException(client.getReplyCode(),client.getReplyString(),e.getMessage(),e);
      }
      if (LOG.isTraceEnabled()) {
        LOG.trace("Cannot connect due: " + failed.getMessage());
      }
      attempt++;
      if (attempt > endpoint.getMaximumReconnectAttempts()) {
        throw failed;
      }
      if (endpoint.getReconnectDelay() > 0) {
        try {
          Thread.sleep(endpoint.getReconnectDelay());
        }
 catch (        InterruptedException ie) {
        }
      }
    }
  }
  if (configuration.isPassiveMode()) {
    LOG.trace("Using passive mode connections");
    client.enterLocalPassiveMode();
  }
  try {
    boolean login;
    if (username != null) {
      if (LOG.isTraceEnabled()) {
        LOG.trace("Attempting to login user: " + username + " using password: "+ configuration.getPassword());
      }
      login=client.login(username,configuration.getPassword());
    }
 else {
      LOG.trace("Attempting to login anonymous");
      login=client.login("anonymous",null);
    }
    if (LOG.isTraceEnabled()) {
      LOG.trace("User " + (username != null ? username : "anonymous") + " logged in: "+ login);
    }
    if (!login) {
      throw new GenericFileOperationFailedException(client.getReplyCode(),client.getReplyString());
    }
    client.setFileType(configuration.isBinary() ? FTPClient.BINARY_FILE_TYPE : FTPClient.ASCII_FILE_TYPE);
  }
 catch (  IOException e) {
    throw new GenericFileOperationFailedException(client.getReplyCode(),client.getReplyString(),e.getMessage(),e);
  }
  return true;
}
