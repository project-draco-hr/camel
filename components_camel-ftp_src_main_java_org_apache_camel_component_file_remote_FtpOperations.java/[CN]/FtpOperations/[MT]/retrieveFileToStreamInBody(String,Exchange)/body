{
  OutputStream os=null;
  boolean result;
  try {
    GenericFile<FTPFile> target=(GenericFile<FTPFile>)exchange.getProperty(FileComponent.FILE_EXCHANGE_FILE);
    ObjectHelper.notNull(target,"Exchange should have the " + FileComponent.FILE_EXCHANGE_FILE + " set");
    String remoteName=name;
    String currentDir=null;
    if (endpoint.getConfiguration().isStepwise()) {
      currentDir=getCurrentDirectory();
      String path=FileUtil.onlyPath(name);
      if (path != null) {
        changeCurrentDirectory(path);
      }
      remoteName=FileUtil.stripPath(name);
    }
    log.trace("Client retrieveFile: {}",remoteName);
    if (endpoint.getConfiguration().isStreamDownload()) {
      InputStream is=client.retrieveFileStream(remoteName);
      target.setBody(is);
      exchange.getIn().setHeader(RemoteFileComponent.REMOTE_FILE_INPUT_STREAM,is);
      result=true;
    }
 else {
      os=new ByteArrayOutputStream();
      target.setBody(os);
      result=client.retrieveFile(remoteName,os);
    }
    exchange.getIn().setHeader(FtpConstants.FTP_REPLY_CODE,client.getReplyCode());
    exchange.getIn().setHeader(FtpConstants.FTP_REPLY_STRING,client.getReplyString());
    if (endpoint.getConfiguration().isStepwise()) {
      changeCurrentDirectory(currentDir);
    }
  }
 catch (  IOException e) {
    throw new GenericFileOperationFailedException(client.getReplyCode(),client.getReplyString(),e.getMessage(),e);
  }
 finally {
    IOHelper.close(os,"retrieve: " + name,log);
  }
  return result;
}
