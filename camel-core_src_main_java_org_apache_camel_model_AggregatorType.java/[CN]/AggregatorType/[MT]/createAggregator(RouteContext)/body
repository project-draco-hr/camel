{
  Endpoint from=routeContext.getEndpoint();
  final Processor processor=routeContext.createProcessor(this);
  final Aggregator aggregator;
  if (getAggregationCollection() == null) {
    setAggregationCollection(createAggregationCollection(routeContext));
  }
  if (aggregationCollection != null) {
    if (aggregationCollection.getCorrelationExpression() == null) {
      aggregationCollection.setCorrelationExpression(getExpression());
    }
    if (aggregationCollection.getAggregationStrategy() == null) {
      AggregationStrategy strategy=createAggregationStrategy(routeContext);
      aggregationCollection.setAggregationStrategy(strategy);
    }
    aggregator=new Aggregator(from,processor,aggregationCollection);
  }
 else {
    AggregationStrategy strategy=createAggregationStrategy(routeContext);
    if (getExpression() == null) {
      throw new RuntimeCamelException("You need to specify an expression or aggregation collection " + "for the aggregator.");
    }
    Expression aggregateExpression=getExpression().createExpression(routeContext);
    Predicate predicate=null;
    if (getCompletedPredicate() != null) {
      predicate=getCompletedPredicate().createPredicate(routeContext);
    }
    if (predicate != null) {
      aggregator=new Aggregator(from,processor,aggregateExpression,strategy,predicate);
    }
 else {
      aggregator=new Aggregator(from,processor,aggregateExpression,strategy);
    }
  }
  if (batchSize != null) {
    aggregator.setBatchSize(batchSize);
  }
  if (batchTimeout != null) {
    aggregator.setBatchTimeout(batchTimeout);
  }
  if (outBatchSize != null) {
    aggregator.setOutBatchSize(outBatchSize);
  }
  return aggregator;
}
