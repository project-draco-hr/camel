{
  if (log.isTraceEnabled()) {
    log.trace("Polling file: " + sftpFile);
  }
  boolean timestampMatched=true;
  if (isTimestamp()) {
    long ts=sftpFile.getAttrs().getMTime() * 1000L;
    timestampMatched=ts > lastPollTime;
    if (log.isTraceEnabled()) {
      log.trace("The file is to old + " + sftpFile + ". lastPollTime="+ lastPollTime+ " > fileTimestamp="+ ts);
    }
  }
  if (timestampMatched && isMatched(sftpFile)) {
    String fullFileName=getFullFileName(sftpFile);
    if (exclusiveReadLock) {
      acquireExclusiveReadLock(sftpFile);
    }
    final ByteArrayOutputStream byteArrayOutputStream=new ByteArrayOutputStream();
    channel.get(sftpFile.getFilename(),byteArrayOutputStream);
    if (log.isDebugEnabled()) {
      log.debug("Retrieved file: " + sftpFile.getFilename() + " from: "+ remoteServer());
    }
    RemoteFileExchange exchange=endpoint.createExchange(getFullFileName(sftpFile),byteArrayOutputStream);
    if (isSetNames()) {
      String ftpBasePath=endpoint.getConfiguration().getFile();
      String relativePath=fullFileName.substring(ftpBasePath.length() + 1);
      relativePath=relativePath.replaceFirst("/","");
      if (log.isDebugEnabled()) {
        log.debug("Setting exchange filename to " + relativePath);
      }
      exchange.getIn().setHeader(FileComponent.HEADER_FILE_NAME,relativePath);
    }
    if (deleteFile) {
      if (log.isDebugEnabled()) {
        log.debug("Deleteing file: " + sftpFile.getFilename() + " from: "+ remoteServer());
      }
      deleteFile(sftpFile.getFilename());
    }
 else     if (isMoveFile()) {
      String fromName=sftpFile.getFilename();
      String toName=getMoveFileName(fromName);
      if (log.isDebugEnabled()) {
        log.debug("Moving file: " + fromName + " to: "+ toName);
      }
      boolean deleted=deleteFile(toName);
      if (!deleted) {
        int lastPathIndex=toName.lastIndexOf('/');
        if (lastPathIndex != -1) {
          String directory=toName.substring(0,lastPathIndex);
          if (!SftpUtils.buildDirectory(channel,directory)) {
            log.warn("Can not build directory: " + directory + " (maybe because of denied permissions)");
          }
        }
      }
      try {
        channel.rename(fromName,toName);
      }
 catch (      SftpException e) {
        log.warn("Can not move file: " + fromName + " to: "+ toName);
      }
    }
    getProcessor().process(exchange);
  }
}
