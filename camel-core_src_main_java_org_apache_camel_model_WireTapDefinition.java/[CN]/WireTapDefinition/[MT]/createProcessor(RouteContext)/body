{
  boolean shutdownThreadPool=ProcessorDefinitionHelper.willCreateNewThreadPool(routeContext,this,true);
  ExecutorService threadPool=ProcessorDefinitionHelper.getConfiguredExecutorService(routeContext,"WireTap",this,true);
  SendDynamicProcessor dynamicTo=new SendDynamicProcessor(getExpression());
  dynamicTo.setCamelContext(routeContext.getCamelContext());
  if (cacheSize != null) {
    dynamicTo.setCacheSize(cacheSize);
  }
  if (ignoreInvalidEndpoint != null) {
    dynamicTo.setIgnoreInvalidEndpoint(ignoreInvalidEndpoint);
  }
  Processor target=wrapInErrorHandler(routeContext,dynamicTo);
  CamelInternalProcessor internal=new CamelInternalProcessor(target);
  internal.addAdvice(new CamelInternalProcessor.UnitOfWorkProcessorAdvice(routeContext));
  boolean isCopy=getCopy() == null || getCopy();
  WireTapProcessor answer=new WireTapProcessor(getExpression(),internal,getPattern(),threadPool,shutdownThreadPool);
  answer.setCopy(isCopy);
  if (newExchangeProcessorRef != null) {
    newExchangeProcessor=routeContext.mandatoryLookup(newExchangeProcessorRef,Processor.class);
  }
  if (newExchangeProcessor != null) {
    answer.addNewExchangeProcessor(newExchangeProcessor);
  }
  if (newExchangeExpression != null) {
    answer.setNewExchangeExpression(newExchangeExpression.createExpression(routeContext));
  }
  if (headers != null && !headers.isEmpty()) {
    for (    SetHeaderDefinition header : headers) {
      Processor processor=createProcessor(routeContext,header);
      answer.addNewExchangeProcessor(processor);
    }
  }
  if (onPrepareRef != null) {
    onPrepare=CamelContextHelper.mandatoryLookup(routeContext.getCamelContext(),onPrepareRef,Processor.class);
  }
  if (onPrepare != null) {
    answer.setOnPrepare(onPrepare);
  }
  if (cacheSize != null) {
    answer.setCacheSize(cacheSize);
  }
  if (ignoreInvalidEndpoint != null) {
    answer.setIgnoreInvalidEndpoint(ignoreInvalidEndpoint);
  }
  return answer;
}
