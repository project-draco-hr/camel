{
  LOCK.lock();
  try {
    LOG.trace("LoadEntity call");
    T entity=findEntityByCorrelationKey(key);
    if (entity == null) {
      entity=createEntity(exchange,key);
      setKeyProperty(entity,key);
      ProcessDefinition definition=ProcessDefinition.getRefreshedProcessDefinition(entityManagerTemplate,getActivityRules().getProcessRules().getProcessDefinition());
      setProcessDefinitionProperty(entity,definition);
      final T finalEntity=entity;
      entityManagerTemplate.execute(new EntityManagerCallback<Object>(){
        @Override public Object execute(        EntityManager entityManager){
          entityManager.persist(finalEntity);
          return null;
        }
      }
);
      LOG.debug("About to flush on entity: {} with key: {}",entity,key);
      entityManagerTemplate.execute(new EntityManagerCallback<Object>(){
        @Override public Object execute(        EntityManager entityManager){
          entityManager.flush();
          return null;
        }
      }
);
    }
    return entity;
  }
  finally {
    LOCK.unlock();
  }
}
