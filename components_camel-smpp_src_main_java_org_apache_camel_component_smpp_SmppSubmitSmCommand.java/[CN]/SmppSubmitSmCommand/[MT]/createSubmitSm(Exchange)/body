{
  byte[] shortMessage=getShortMessage(exchange.getIn());
  SubmitSm template=createSubmitSmTemplate(exchange);
  SmppSplitter splitter=createSplitter(exchange.getIn());
  byte[][] segments=splitter.split(shortMessage);
  if (segments.length > 1) {
    template.setEsmClass(new ESMClass(MessageMode.DEFAULT,MessageType.DEFAULT,GSMSpecificFeature.UDHI).value());
  }
  SubmitSm[] submitSms=new SubmitSm[segments.length];
  for (int i=0; i < segments.length; i++) {
    SubmitSm submitSm=SmppUtils.copySubmitSm(template);
    submitSm.setShortMessage(segments[i]);
    submitSms[i]=submitSm;
  }
  return submitSms;
}
