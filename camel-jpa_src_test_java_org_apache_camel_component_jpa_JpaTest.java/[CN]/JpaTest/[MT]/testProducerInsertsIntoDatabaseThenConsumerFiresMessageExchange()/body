{
  transaction=entityManager.getTransaction();
  transaction.begin();
  List results=entityManager.createQuery(queryText).getResultList();
  assertEquals("Should have no results: " + results,0,results.size());
  client.send(endpoint,new Processor<Exchange>(){
    public void onExchange(    Exchange exchange){
      exchange.getIn().setBody(new SendEmail("foo@bar.com"));
    }
  }
);
  transaction.commit();
  transaction.begin();
  results=entityManager.createQuery(queryText).getResultList();
  assertEquals("Should have no results: " + results,1,results.size());
  SendEmail mail=(SendEmail)results.get(0);
  assertEquals("address property","foo@bar.com",mail.getAddress());
  consumer=endpoint.createConsumer(new Processor<Exchange>(){
    public void onExchange(    Exchange e){
      log.info("Received exchange: " + e.getIn());
      receivedExchange=e;
      latch.countDown();
    }
  }
);
  boolean received=latch.await(5,TimeUnit.SECONDS);
  assertTrue("Did not recieve the message!",received);
  assertNotNull(receivedExchange);
  SendEmail result=receivedExchange.getIn().getBody(SendEmail.class);
  assertNotNull("Received a POJO",result);
  assertEquals("address property","foo@bar.com",result.getAddress());
}
