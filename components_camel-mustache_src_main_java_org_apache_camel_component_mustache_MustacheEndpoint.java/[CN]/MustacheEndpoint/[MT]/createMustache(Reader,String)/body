{
  ClassLoader oldcl=Thread.currentThread().getContextClassLoader();
  try {
    ClassLoader apcl=getCamelContext().getApplicationContextClassLoader();
    if (apcl != null) {
      Thread.currentThread().setContextClassLoader(apcl);
    }
    Mustache newMustache;
    if (startDelimiter != null && endDelimiter != null && mustacheFactory instanceof DefaultMustacheFactory) {
      DefaultMustacheFactory defaultMustacheFactory=(DefaultMustacheFactory)mustacheFactory;
      newMustache=defaultMustacheFactory.compile(resourceReader,resourceUri,startDelimiter,endDelimiter);
    }
 else {
      newMustache=mustacheFactory.compile(resourceReader,resourceUri);
    }
    return newMustache;
  }
  finally {
    resourceReader.close();
    if (oldcl != null) {
      Thread.currentThread().setContextClassLoader(oldcl);
    }
  }
}
