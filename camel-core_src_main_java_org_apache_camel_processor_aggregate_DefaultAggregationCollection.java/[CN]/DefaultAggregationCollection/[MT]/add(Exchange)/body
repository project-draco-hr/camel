{
  Object correlationKey=correlationExpression.evaluate(exchange);
  Exchange oldExchange=map.get(correlationKey);
  Exchange newExchange=exchange;
  if (oldExchange != null) {
    Integer count=oldExchange.getProperty(Exchange.AGGREGATED_COUNT,Integer.class);
    if (count == null) {
      count=1;
    }
    count++;
    newExchange=aggregationStrategy.aggregate(oldExchange,newExchange);
    newExchange.setProperty(Exchange.AGGREGATED_COUNT,count);
  }
  if (newExchange != oldExchange) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("put exchange:" + newExchange + " for key:"+ correlationKey);
    }
    if (oldExchange == null) {
      newExchange.setProperty(Exchange.AGGREGATED_COUNT,Integer.valueOf(1));
    }
    map.put(correlationKey,newExchange);
  }
  onAggregation(correlationKey,newExchange);
  return true;
}
