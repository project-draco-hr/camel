{
  Boolean filtered=exchange.getProperty(Exchange.FILTERED,Boolean.class);
  if (filtered != null && filtered) {
    if (LOG.isTraceEnabled()) {
      LOG.trace("Cannot aggregate exchange as its filtered: " + exchange);
    }
    return false;
  }
  Object correlationKey=correlationExpression.evaluate(exchange,Object.class);
  if (LOG.isTraceEnabled()) {
    LOG.trace("Evaluated expression: " + correlationExpression + " as correlation key: "+ correlationKey);
  }
  Exchange oldExchange=aggregated.get(correlationKey);
  Exchange newExchange=exchange;
  Integer size=1;
  if (oldExchange != null) {
    size=oldExchange.getProperty(Exchange.AGGREGATED_SIZE,Integer.class);
    ObjectHelper.notNull(size,Exchange.AGGREGATED_SIZE + " on " + oldExchange);
    size++;
  }
  ExchangeHelper.prepareAggregation(oldExchange,newExchange);
  newExchange=aggregationStrategy.aggregate(oldExchange,newExchange);
  newExchange.setProperty(Exchange.AGGREGATED_SIZE,size);
  newExchange.setProperty(Exchange.AGGREGATED_INDEX,counter.getAndIncrement());
  if (!newExchange.equals(oldExchange)) {
    if (LOG.isTraceEnabled()) {
      LOG.trace("Put exchange:" + newExchange + " with correlation key:"+ correlationKey);
    }
    aggregated.put(correlationKey,newExchange);
  }
  onAggregation(correlationKey,newExchange);
  return true;
}
