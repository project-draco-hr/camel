{
  if (LOG.isDebugEnabled()) {
    LOG.debug("Finding best suited exception policy for thrown exception " + exception.getClass().getName());
  }
  int targetLevel=getInheritanceLevel(exception.getClass());
  ExceptionType candidate=null;
  int candidateDiff=Integer.MAX_VALUE;
  Set<Map.Entry<Class,ExceptionType>> entries=exceptionPolicices.entrySet();
  for (  Map.Entry<Class,ExceptionType> entry : entries) {
    Class clazz=entry.getKey();
    ExceptionType type=entry.getValue();
    if (clazz.isInstance(exception)) {
      if (clazz.equals(exception.getClass())) {
        candidate=type;
        break;
      }
      int level=getInheritanceLevel(clazz);
      int diff=targetLevel - level;
      if (diff < candidateDiff) {
        candidate=type;
        candidateDiff=diff;
      }
    }
  }
  if (LOG.isDebugEnabled()) {
    if (candidate != null) {
      LOG.debug("Using " + candidate + " as the exception policy");
    }
 else {
      LOG.debug("No candidate found to be used as exception policy");
    }
  }
  return candidate;
}
